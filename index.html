<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novan Agency | Painel de Gest√£o de Tr√°fego e Tarefas</title>
    <!-- Carrega Tailwind CSS para estiliza√ß√£o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega Chart.js para gera√ß√£o de gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Configura√ß√£o da fonte Poppins e cores personalizadas do Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'novan-primary': '#6D28D9', // Roxo principal
                        'novan-secondary': '#0F172A', // Preto/Cinza Escuro (fundo)
                        'novan-light': '#F8FAFC', // Cinza Claro (cards/inputs)
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        /* Estilos globais para a aplica√ß√£o */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1E293B; /* Fundo Escuro para o conte√∫do principal (Slate-800) */
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .sidebar-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        .sidebar-item.active {
            background-color: #5B21B6; /* Roxo mais escuro (Corrigido, removido aspas extras) */
            border-left: 4px solid #FBBF24; /* Destaque amarelo para contraste */
        }
        
        /* Estilos do calend√°rio */
        .calendar-day {
            min-height: 100px;
            border: 1px solid #334155; /* Borda escura */
            background-color: #1E293B; /* Fundo escuro */
            transition: transform 0.1s;
            color: #E2E8F0; /* Texto claro */
        }
        .calendar-day:hover {
            transform: scale(1.02);
            cursor: pointer; /* Adiciona cursor de ponteiro para indicar que √© clic√°vel */
            background-color: #334155; /* Darker hover */
        }
        /* Cor dos dias do m√™s (o padr√£o Tailwind √© aplicado no HTML, mas garantindo aqui) */
        .calendar-day div {
            color: #E2E8F0; 
        }
        
        /* --- ESTILOS DE LOGIN (FUNDO ANIMADO) --- */
        #login-page {
            background-color: #0E1B31; /* Azul Marinho Escuro */
            position: relative;
            overflow: hidden;
        }

        /* NOVO: Estilo para o Canvas Matrix */
        #matrixCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; 
            opacity: 0.6;
        }
        
        #login-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Padr√£o de Grid Sutil */
            background-image: linear-gradient(to right, rgba(109, 40, 217, 0.1) 1px, transparent 1px), 
                              linear-gradient(to bottom, rgba(109, 40, 217, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.5;
            animation: pulseGlow 15s infinite alternate;
            z-index: 0; /* Manter o grid no fundo */
        }
        @keyframes pulseGlow {
            0% { opacity: 0.3; transform: scale(1); }
            100% { opacity: 0.6; transform: scale(1.05); }
        }

        /* PE√áAS DE JOGO ANIMADAS */
        .futuristic-piece {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #a78bfa 0%, #6D28D9 100%);
            box-shadow: 0 0 15px #6D28D9, inset 0 0 8px rgba(255, 255, 255, 0.5);
            z-index: 1;
            opacity: 0.7;
            animation: floatPiece 15s ease-in-out infinite alternate, pulsePiece 3s ease-in-out infinite;
        }

        .piece-1 { top: 10%; left: 10%; transform: scale(0.8); }
        .piece-2 { bottom: 15%; right: 10%; width: 90px; height: 90px; background: radial-gradient(circle at 70% 70%, #d8b4fe 0%, #6D28D9 100%); animation-delay: 2s; }
        .piece-3 { top: 50%; left: 5%; transform: scale(0.6); animation-delay: 4s; }
        .piece-4 { bottom: 5%; left: 40%; width: 40px; height: 40px; animation-delay: 6s; }

        @keyframes floatPiece {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(50px, -50px) rotate(10deg); }
        }

        @keyframes pulsePiece {
            0% { box-shadow: 0 0 15px #6D28D9, inset 0 0 8px rgba(255, 255, 255, 0.5); }
            50% { box-shadow: 0 0 25px #c4b5fd, inset 0 0 15px #a78bfa; }
            100% { box-shadow: 0 0 15px #6D28D9, inset 0 0 8px rgba(255, 255, 255, 0.5); }
        }
        /* FIM PE√áAS DE JOGO ANIMADAS */
        
        /* ANIMA√á√ÉO DE CARREGAMENTO (SPINNER) */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #6D28D9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Estilos para diferencia√ß√£o de cor nas c√©lulas da tabela */
        .text-investimento { color: #EF4444; font-weight: 600; } /* Red 500 (GASTO) */
        .text-faturamento { color: #10B981; font-weight: 600; }  /* Green 500 (FATURAMENTO/VENDAS) */
        .text-cpa { color: #F59E0B; font-weight: 600; }          /* Amber 500 (CPA) */
        .text-roas { color: #DC2626; font-weight: 600; }          /* Red 600 (ROAS - mantendo a cor forte de retorno) */
        .text-cpm { color: #3B82F6; font-weight: 600; }           /* Blue 500 (CPM) */
        
        .text-impressoes { color: #3B82F6; font-weight: 600; }   /* Blue 500 (IMPRESS√ïES - mesma cor do CPM para consist√™ncia) */
        .text-cliques { color: #EC4899; font-weight: 600; }      /* Pink 500 (CLIQUES) */
        .text-conversoes { color: #6D28D9; font-weight: 600; }    /* Novan Primary (Purple) (CONVERS√ïES) */
        
        /* Estilo para as tarefas no calend√°rio */
        .task-item {
            padding: 2px 4px;
            border-radius: 6px;
            font-size: 0.7rem;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
            border-left: 4px solid; /* Usado para a cor do cliente */
        }
        /* --- ESTILOS DE STATUS DE CALEND√ÅRIO E KANBAN --- */
        .bg-status-Pendente { background-color: #DC2626; } /* Vermelho */
        .bg-status-Em_Andamento { background-color: #F59E0B; } /* √Çmbar/Amarelo */
        .bg-status-Concluido { background-color: #10B981; } /* Verde */
        
        /* Estilo para diminuir a altura do canvas nos relat√≥rios */
        .chart-container {
            height: 300px; /* Altura padr√£o para todos os gr√°ficos */
            width: 100%;
        }

    </style>
</head>
<body class="flex flex-col lg:flex-row min-h-screen">
    
    <!-- Tela de Login -->
    <div id="login-page" class="flex items-center justify-center min-h-screen w-full bg-novan-secondary">
        <!-- NOVO: CANVAS PARA EFEITO CASCATA DE C√ìDIGO (Matrix) -->
        <canvas id="matrixCanvas"></canvas>
        
        <!-- Pe√ßas de Jogo Animadas para Fundo Futurista -->
        <div class="futuristic-piece piece-1"></div>
        <div class="futuristic-piece piece-2"></div>
        <div class="futuristic-piece piece-3"></div>
        <div class="futuristic-piece piece-4"></div>
        <!-- Fim Pe√ßas de Jogo Animadas -->

        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md z-10">
            <h1 class="text-4xl font-bold text-center text-novan-primary mb-6">Novan Agency</h1>
            <p class="text-center text-gray-600 mb-8">Acesso restrito. Fa√ßa login para continuar.</p>
            
            <form id="loginForm" class="space-y-4">
                <input type="email" id="login_email" placeholder="Email" required 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-novan-primary focus:border-novan-primary" />
                
                <!-- CAMPO DE SENHA COM TOGGLE DE VISIBILIDADE -->
                <div class="relative">
                    <input type="password" id="login_password" placeholder="Senha" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-novan-primary focus:border-novan-primary pr-10" />
                    <button type="button" onclick="togglePasswordVisibility()" 
                        class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-novan-primary transition-colors">
                        <!-- SVG do Olho Aberto (Padr√£o) -->
                        <svg id="togglePasswordIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <!-- Path 1 (Center dot/circle) -->
                            <path id="togglePasswordPath1" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <!-- Path 2 (Eye outline) -->
                            <path id="togglePasswordPath2" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </button>
                </div>
                <!-- FIM CAMPO DE SENHA COM TOGGLE DE VISIBILIDADE -->
                
                <div class="flex items-center justify-between">
                    <label for="rememberMe" class="flex items-center text-sm text-gray-600">
                        <input type="checkbox" id="rememberMe" checked class="h-4 w-4 text-novan-primary border-gray-300 rounded focus:ring-novan-primary mr-2">
                        Lembrar de Mim (Salvar Login)
                    </label>
                </div>

                <button type="submit" id="loginButton" class="w-full bg-novan-primary hover:bg-violet-700 text-white font-semibold p-3 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                    Entrar
                </button>
            </form>
            <p id="authError" class="text-center text-red-500 mt-4 text-sm hidden"></p>
        </div>
    </div>
    <!-- Fim Tela de Login -->

    <!-- Dashboard Principal (Escondido at√© o Login) -->
    <div id="dashboard-container" class="hidden contents">

        <!-- Sidebar de Navega√ß√£o (Menu) -->
        <aside id="sidebar" class="bg-novan-secondary text-white w-full lg:w-64 flex-shrink-0 p-4 shadow-2xl lg:shadow-none">
            <div class="text-3xl font-bold mb-8 text-novan-primary border-b border-gray-700 pb-4">
                Novan Agency
            </div>
            
            <!-- Menu Items - NOVA ORDEM AQUI -->
            <nav>
                <!-- 1. Cadastro de Clientes (Clientes) -->
                <div id="nav-clientes" class="sidebar-item p-3 rounded-lg flex items-center mb-2 active" data-tab="clientes">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M7 14v-4a5 5 0 0110 0v4M7 14l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17" /></svg>
                    Cadastro de Clientes
                </div>
                
                <!-- 2. Resultados de Campanhas (Resultados) -->
                <div id="nav-resultados" class="sidebar-item p-3 rounded-lg flex items-center mb-2" data-tab="resultados">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-2 7v-4m-2 2h4M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                    Resultados de Campanhas
                </div>

                <!-- 3. Calend√°rio de Tarefas (Calendario) -->
                <div id="nav-calendario" class="sidebar-item p-3 rounded-lg flex items-center mb-2" data-tab="calendario">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-4 10h.01M3 21h18a2 2 0 002-2V7a2 2 0 00-2-2H3a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    Calend√°rio de Tarefas
                </div>
                
                <!-- 4. Gest√£o de Tarefas (Gestao) -->
                <div id="nav-gestao" class="sidebar-item p-3 rounded-lg flex items-center mb-2" data-tab="gestao">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-2 4l-2 2m0 0l-2-2m2 2V5" /></svg>
                    Gest√£o de Tarefas
                </div>

                <!-- 5. Relat√≥rios e Insights (Relatorios) -->
                <div id="nav-relatorios" class="sidebar-item p-3 rounded-lg flex items-center mb-2" data-tab="relatorios">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>
                    Relat√≥rios e Insights
                </div>
                
                <!-- Bot√£o de SAIR / LOGOUT -->
                <div onclick="handleLogout()" class="sidebar-item p-3 rounded-lg flex items-center mb-2 mt-8 bg-red-600 hover:bg-red-700 text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    Sair (Logout)
                </div>
            </nav>
        </aside>

        <!-- Conte√∫do Principal -->
        <main class="flex-grow p-4 md:p-8 overflow-x-hidden">
            
            <!-- Mensagem de feedback/alerta -->
            <div id="messageBox" class="fixed top-4 right-4 bg-novan-primary text-white p-3 rounded-lg shadow-xl hidden z-50 transition-all duration-300"></div>

            <!-- Tab 1: Resultados de Campanhas -->
            <section id="resultados" class="tab-content">
                <h1 class="text-4xl font-bold text-white mb-6">üßæ Resultados de Campanhas</h1>
                
                <!-- Formul√°rio de Registro Di√°rio -->
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-novan-primary">Registro Di√°rio de Performance</h2>
                    <form id="campaignForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <!-- NOVO: ID oculto para edi√ß√£o -->
                        <input type="hidden" id="res_id_edit" value=""> 

                        <!-- LINHA 1 (Data, Cliente, Plataforma, Gasto) -->
                        <input type="date" id="res_data" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" value="" />
                        <select id="res_cliente" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                            <option value="">Selecione o Cliente</option>
                        </select>
                        <select id="res_plataforma" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                            <option value="Meta">Meta Ads</option>
                            <option value="Google">Google Ads</option>
                            <option value="Outra">Outra</option>
                        </select>
                        <input type="number" step="0.01" id="res_investimento" placeholder="Gasto (R$)" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        
                        <!-- LINHA 2 (M√©tricas Prim√°rias e Vendas) -->
                        <input type="number" id="res_impressoes" placeholder="Impress√µes" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        <input type="number" id="res_alcance" placeholder="Alcance" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        <input type="number" id="res_cliques" placeholder="Cliques no Site" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        <!-- Vendas / Faturamento -->
                        <input type="number" step="0.01" id="res_vendas" placeholder="Vendas (incl. Compras) / Faturamento (R$)" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        
                        <!-- LINHA 3 (Convers√£o e M√©tricas Calculadas) -->
                        <!-- BLOCO DE CONVERS√ÉO -->
                        <div class="col-span-1 md:col-span-2 flex items-center space-x-2">
                            <select id="res_conversion_type" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary w-1/2 bg-gray-700 text-white">
                                <option value="">Tipo Convers√£o</option>
                                <option value="Ligue">Ligue</option>
                                <option value="Mensagem">Mensagem</option>
                                <option value="Compras">Compras</option>
                                <option value="Formulario">Formul√°rio</option>
                                <option value="Visualizacao">Visualiza√ß√£o</option>
                                <option value="Outro">Outro</option>
                            </select>
                            <input type="number" id="res_conversion_count" placeholder="Total de Convers√µes" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        </div>
                        <!-- M√©tricas Calculadas (CPA, ROAS, CPM) -->
                        <div class="col-span-1 md:col-span-2 flex items-center space-x-4">
                            <div class="text-sm font-medium text-gray-300">CPA: R$ <span id="cpa_calc" class="font-bold text-red-500">0.00</span></div>
                            <div class="text-sm font-medium text-gray-300">ROAS: <span id="roas_calc" class="font-bold text-green-500">0.00</span></div>
                            <div class="text-sm font-medium text-gray-300">CPM: R$ <span id="cpm_calc" class="font-bold text-blue-500">0.00</span></div>
                        </div>
                        
                        <!-- LINHA 4 (Observa√ß√µes, Parsing e Bot√µes) -->
                        <textarea id="rawMetricsInput" placeholder="Cole a mensagem pronta aqui (opcional)" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary col-span-1 md:col-span-4 bg-gray-700 text-white h-16"></textarea>
                        <button type="button" onclick="parseAndFillMetrics()" class="col-span-1 md:col-span-4 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            ü§ñ Preencher com Mensagem Pronta
                        </button>
                        <textarea id="res_observacoes" placeholder="Observa√ß√µes do dia" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary col-span-1 md:col-span-4 bg-gray-700 text-white"></textarea>

                        <button type="submit" id="resultsSubmitButton" class="col-span-1 md:col-span-2 bg-novan-primary hover:bg-violet-700 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Registrar Resultados
                        </button>
                        <button type="button" id="btnResumoDiario" class="col-span-1 bg-green-500 hover:bg-green-600 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Gerar Resumo Di√°rio
                        </button>
                        <button type="button" id="btnResumoQuinzenal" class="col-span-1 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Gerar Resumo Quinzenal
                        </button>
                        
                        <!-- NOVO: BOT√ÉO GEMINI API -->
                        <button type="button" onclick="generatePerformanceAnalysis()" 
                                class="col-span-1 md:col-span-4 bg-pink-600 hover:bg-pink-700 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            ‚ú® Gerar An√°lise de Desempenho Di√°rio
                        </button>
                        <!-- FIM NOVO BOT√ÉO -->
                    </form>
                </div>

                <!-- Modal para Resumos -->
                <div id="summaryModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
                    <div class="bg-novan-secondary p-6 rounded-xl shadow-2xl w-full max-w-lg">
                        <h3 id="summaryTitle" class="text-2xl font-bold mb-4 text-novan-primary"></h3>
                        <div id="summaryContent" class="mb-4 text-gray-300 max-h-96 overflow-y-auto"></div>
                        <button onclick="closeSummaryModal()" class="bg-red-500 hover:bg-red-600 text-white font-semibold p-2 rounded-lg w-full">Fechar</button>
                    </div>
                </div>

                <!-- NOVO BLOCO DE FILTROS PARA O HIST√ìRICO -->
                <div class="bg-slate-800 p-4 rounded-xl shadow-lg mb-6 flex flex-wrap gap-4 items-end">
                    <h2 class="text-xl font-semibold text-white flex-grow basis-full md:basis-auto">Filtrar Hist√≥rico:</h2>
                    <select id="results_filter_cliente" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary flex-grow bg-gray-700 text-white">
                        <option value="">Todos os Clientes</option>
                    </select>
                    <input type="date" id="results_filter_start_date" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                    <span class="font-medium text-gray-300">at√©</span>
                    <input type="date" id="results_filter_end_date" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                    <button onclick="renderResultsTable()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                        Aplicar Filtros
                    </button>
                    
                    <!-- NOVO: Bot√µes de Filtro R√°pido (Resultados) -->
                    <div class="flex flex-wrap gap-2 mt-2 pt-2 border-t border-gray-700 w-full">
                        <span class="text-sm font-medium text-gray-300 self-center mr-2">Filtros R√°pidos:</span>
                        <button onclick="filterResultsByPreset('today')" class="text-xs bg-gray-700 hover:bg-novan-primary text-white font-semibold py-1 px-3 rounded-lg shadow-md transition-all">Hoje</button>
                        <button onclick="filterResultsByPreset('7days')" class="text-xs bg-gray-700 hover:bg-novan-primary text-white font-semibold py-1 px-3 rounded-lg shadow-md transition-all">√öltimos 7 dias</button>
                        <button onclick="filterResultsByPreset('15days')" class="text-xs bg-gray-700 hover:bg-novan-primary text-white font-semibold py-1 px-3 rounded-lg shadow-md transition-all">√öltimos 15 dias</button>
                        <button onclick="filterResultsByPreset('30days')" class="text-xs bg-gray-700 hover:bg-novan-primary text-white font-semibold py-1 px-3 rounded-lg shadow-md transition-all">√öltimos 30 dias</button>
                        <button onclick="generateStrategicAnalysis()" 
                                class="text-xs bg-pink-600 hover:bg-pink-700 text-white font-semibold py-1 px-3 rounded-lg shadow-md transition-all">
                                ‚ú® An√°lise Gemini Estrat√©gica
                        </button>
                    </div>
                    <!-- FIM NOVO: Bot√µes de Filtro R√°pido -->
                </div>
                <!-- FIM NOVO BLOCO DE FILTROS -->

                <!-- NOVO BLOCO: KPI Cards de Resumo (AGREGADO) -->
                <h2 class="text-xl font-semibold mb-4 text-white mt-8">Resumo Agregado (Filtro Aplicado)</h2>
                <div id="kpiCardsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                    <!-- Cards KPI ser√£o injetados aqui -->
                    <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-red-500">
                        <p class="text-sm font-medium text-gray-400">Gasto Total</p>
                        <p class="text-2xl font-bold text-red-500 mt-1">R$ 0,00</p>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-400">Faturamento</p>
                        <p class="text-2xl font-bold text-green-500 mt-1">R$ 0,00</p>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-yellow-500">
                        <p class="text-sm font-medium text-gray-400">ROAS M√©dio (X)</p>
                        <p class="text-2xl font-bold text-yellow-500 mt-1">0.00X</p>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-indigo-500">
                        <p class="text-sm font-medium text-gray-400">CPA M√©dio (R$)</p>
                        <p class="text-2xl font-bold text-indigo-500 mt-1">R$ 0,00</p>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-400">CPM M√©dio (R$)</p>
                        <p class="text-2xl font-bold text-blue-500 mt-1">R$ 0,00</p>
                    </div>
                </div>
                <!-- FIM NOVO BLOCO DE FILTROS -->

                <!-- Hist√≥rico de Resultados (Nova Visualiza√ß√£o em Cart√µes) -->
                <div class="bg-novan-secondary p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-white">Hist√≥rico e Evolu√ß√£o das M√©tricas</h2>
                    <div id="resultsListContainer" class="space-y-4">
                        <!-- Lista de resultados em formato de cart√£o ser√° injetada aqui via JS -->
                    </div>
                    <p id="noResults" class="text-center text-gray-400 mt-4 hidden">Nenhum resultado registrado ainda.</p>
                </div>
            </section>

            <!-- Tab 2: Calend√°rio de Tarefas -->
            <section id="calendario" class="tab-content">
                <h1 class="text-4xl font-bold text-white mb-6">üìÖ Calend√°rio de Tarefas</h1>
                
                <div class="grid grid-cols-1 lg:col-span-4 gap-6">
                    
                    <!-- Card de Cadastro de Tarefas -->
                    <div class="lg:col-span-1 bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold mb-4 text-novan-primary">Cadastrar Nova Tarefa</h2>
                        <form id="taskForm" class="space-y-3">
                            <select id="task_cliente" required class="w-full p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                <option value="">Selecione o Cliente</option>
                            </select>
                            <select id="task_tipo" required class="w-full p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                <option value="">Tipo de Tarefa</option>
                                <option value="Campanha">Campanha Ads</option>
                                <option value="Post">Post/Conte√∫do</option>
                                <option value="Reuniao">Reuni√£o</option>
                                <option value="Video">Entrega de V√≠deo</option>
                                <option value="Relatorio">Relat√≥rio</option>
                                <option value="Outro">Outro</option>
                            </select>
                            <input type="datetime-local" id="task_data" required class="w-full p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                            <select id="task_status" required class="w-full p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                <option value="Pendente">Pendente</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Concluido">Conclu√≠do</option>
                            </select>
                            <textarea id="task_observacoes" placeholder="Observa√ß√µes" class="w-full p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white"></textarea>
                            <button type="submit" class="w-full bg-novan-primary hover:bg-violet-700 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                                Salvar Tarefa
                            </button>
                        </form>
                    </div>

                    <!-- Card de Visualiza√ß√£o do Calend√°rio e Filtros -->
                    <div class="lg:col-span-3 bg-novan-secondary p-6 rounded-xl shadow-lg">
                        <div class="flex flex-wrap items-center justify-between mb-4">
                            <div class="flex space-x-2 mb-4 md:mb-0">
                                <button id="prevMonth" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-lg font-bold transition-transform transform hover:scale-[1.05]">&lt;</button>
                                <h2 id="currentMonthYear" class="text-2xl font-bold text-white self-center"></h2>
                                <button id="nextMonth" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-lg font-bold transition-transform transform hover:scale-[1.05]">&gt;</button>
                            </div>
                            <div class="flex space-x-2">
                                <select id="filterClient" class="p-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-white" onchange="renderCalendar()">
                                    <option value="">Todos os Clientes</option>
                                </select>
                                <button onclick="renderCalendar()" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-lg text-sm">Ver M√™s</button>
                            </div>
                        </div>

                        <!-- Grade do Calend√°rio -->
                        <div class="grid grid-cols-7 text-center font-semibold text-novan-primary border-b-2 border-gray-600 pb-2 mb-2">
                            <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>S√°b</span>
                        </div>
                        <div id="calendarGrid" class="grid grid-cols-7 gap-1">
                            <!-- Dias ser√£o injetados aqui -->
                        </div>

                        <!-- Notifica√ß√µes de Tarefas Pr√≥ximas -->
                        <div id="taskNotifications" class="mt-6 p-3 bg-yellow-900/50 border-l-4 border-yellow-500 text-yellow-300 rounded-lg hidden">
                            <h4 class="font-semibold">‚ö†Ô∏è Alerta de Prazos Pr√≥ximos:</h4>
                            <ul id="notificationList" class="list-disc list-inside mt-1"></ul>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Tab 3: Cadastro de Clientes -->
            <section id="clientes" class="tab-content">
                <h1 class="text-4xl font-bold text-white mb-6">üë• Cadastro de Clientes</h1>

                <!-- Seletor de Tipo de Cliente -->
                <div class="flex space-x-4 mb-6 justify-center">
                    <button id="btn_type_traffic" onclick="showClientFormType('traffic')" class="client-type-btn px-6 py-2 rounded-full font-semibold shadow-md transition-all bg-novan-primary text-white">
                        Novo Cliente - Tr√°fego Pago
                    </button>
                    <button id="btn_type_social" onclick="showClientFormType('social')" class="client-type-btn px-6 py-2 rounded-full font-semibold shadow-md transition-all bg-gray-700 text-white hover:bg-gray-600">
                        Novo Cliente - Social Media
                    </button>
                </div>


                <!-- Formul√°rio de Cadastro -->
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg mb-8 max-w-2xl mx-auto">
                    <h2 class="text-xl font-semibold mb-4 text-novan-primary" id="clientFormTitle">Formul√°rio de Tr√°fego Pago</h2>
                    <form id="clientForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Campo oculto para armazenar o tipo de servi√ßo ativo -->
                        <input type="hidden" id="cli_service_type" value="traffic">
                        <!-- Campo oculto para ID de edi√ß√£o -->
                        <input type="hidden" id="cli_id_edit" value="">


                        <!-- CAMPOS COMUNS -->
                        <input type="text" id="cli_nome" placeholder="Nome da Empresa" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        <select id="cli_responsavel" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                            <option value="">Selecione o Respons√°vel da Ag√™ncia</option>
                        </select>
                        <input type="tel" id="cli_telefone" placeholder="Telefone / WhatsApp" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" oninput="maskPhone(this)" maxlength="15" />
                        <input type="url" id="cli_link" placeholder="Link (Site/Card√°pio/Perfil)" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        <!-- FIM CAMPOS COMUNS -->

                        <!-- CAMPOS ESPEC√çFICOS DE TR√ÅFEGO PAGO -->
                        <div id="trafficFields" class="contents">
                            <!-- Plataforma Principal -->
                            <select id="cli_plataforma_traffic" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                <option value="Meta">Plataforma Principal: Meta Ads</option>
                                <option value="Google">Plataforma Principal: Google Ads</option>
                                <option value="Ambos">Plataforma Principal: Ambos</option>
                            </select>
                            
                            <!-- Tipo e Valor do Or√ßamento -->
                            <div>
                                <select id="cli_budget_type_traffic" required class="w-full p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                    <option value="">Selecione o Tipo de Or√ßamento</option>
                                    <option value="Or√ßamento Di√°rio">Or√ßamento Di√°rio</option>
                                    <option value="Or√ßamento de Campanha">Or√ßamento de Campanha</option>
                                </select>
                            </div>
                            <input type="number" step="0.01" id="cli_budget_value_traffic" placeholder="Valor (R$)" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                            
                            <!-- Meta de Convers√£o -->
                            <select id="cli_conversion_goals_traffic" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                <option value="">Principal Meta de Convers√£o</option>
                                <option value="Ligue">Ligue (Chamadas)</option>
                                <option value="Mensagem">Mensagem (Leads)</option>
                                <option value="Compras">Compras no Site</option>
                                <option value="Formul√°rio">Formul√°rio (Leads)</option>
                                <option value="Visualizacao">Visualiza√ß√£o de Conte√∫do</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <!-- FIM CAMPOS ESPEC√çFICOS DE TR√ÅFEGO PAGO -->

                        <!-- CAMPOS ESPEC√çFICOS DE SOCIAL MEDIA -->
                        <div id="socialMediaFields" class="hidden contents">
                            <!-- Foco de Plataforma SM -->
                            <select id="cli_sm_platform" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                <option value="Instagram">Foco Principal: Instagram</option>
                                <option value="TikTok">Foco Principal: TikTok</option>
                                <option value="LinkedIn">Foco Principal: LinkedIn</option>
                                <option value="Pinterest">Foco Principal: Pinterest</option>
                                <option value="AmbosSM">Ambos/M√∫ltiplos</option>
                            </select>

                            <!-- Fee Mensal SM -->
                            <input type="number" step="0.01" id="cli_sm_fee" placeholder="Fee Mensal (R$)" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                            
                            <!-- Necessidade de Conte√∫do SM -->
                            <select id="cli_sm_needs" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                <option value="Conteudo">Foco: Cria√ß√£o de Conte√∫do</option>
                                <option value="Design">Foco: Design/Branding</option>
                                <option value="Estrategia">Foco: Estrat√©gia/Planejamento</option>
                            </select>
                            
                            <div class="col-span-1"></div> <!-- Espa√ßador para manter o grid -->
                        </div>
                        <!-- FIM CAMPOS ESPEC√çFICOS DE SOCIAL MEDIA -->

                        <textarea id="cli_observacoes" placeholder="Observa√ß√µes gerais e Nicho" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary col-span-1 md:col-span-2 bg-gray-700 text-white"></textarea>

                        <button type="submit" id="clientSubmitButton" class="col-span-1 md:col-span-2 bg-novan-primary hover:bg-violet-700 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Cadastrar Cliente
                        </button>
                        <button type="button" id="clientCancelButton" onclick="resetClientForm()" class="hidden col-span-1 md:col-span-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Cancelar Edi√ß√£o
                        </button>
                    </form>
                </div>

                <!-- Lista de Clientes Cadastrados -->
                <div class="bg-novan-secondary p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-white">Clientes Ativos</h2>
                    <div id="clientList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Cards de clientes ser√£o injetados aqui via JS -->
                    </div>
                    <!-- O elemento noClients foi movido para fora do clientList para evitar ser apagado pelo innerHTML = '' -->
                    <p id="noClients" class="text-center text-gray-400 col-span-full hidden mt-4">Nenhum cliente cadastrado ainda.</p>
                </div>
            </section>

            <!-- Tab 5: Gest√£o de Tarefas (NOVA ABA) -->
            <section id="gestao" class="tab-content">
                <h1 class="text-4xl font-bold text-white mb-6">‚úÖ Gest√£o de Tarefas e Status</h1>
                
                <div class="bg-slate-800 p-4 rounded-xl shadow-lg mb-6 flex flex-wrap gap-4 items-center">
                    <h2 class="text-xl font-semibold text-novan-primary">Filtrar:</h2>
                    <select id="task_manager_filter_client" class="p-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                        <option value="">Todos os Clientes</option>
                    </select>
                    <select id="task_manager_filter_status" class="p-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                        <option value="">Todos os Status</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Concluido">Concluido</option>
                    </select>
                    <button onclick="renderTaskManagement()" class="bg-novan-primary hover:bg-violet-700 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                        Aplicar Filtros
                    </button>
                </div>

                <!-- Kanban-like Board (3 colunas para status) -->
                <div id="taskManagementBoard" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Colunas de Status ser√£o renderizadas aqui -->
                </div>
                
                <p id="noTasksMessage" class="text-center text-gray-400 mt-8 hidden">Nenhuma tarefa encontrada para os filtros selecionados.</p>
            </section>

            <!-- Tab 4: Relat√≥rios e Insights -->
            <section id="relatorios" class="tab-content">
                <h1 class="text-4xl font-bold text-white mb-6">üìä Relat√≥rios e Insights</h1>
                
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-novan-primary">Filtros de Relat√≥rio</h2>
                    <div class="flex flex-wrap gap-4 items-end">
                        <select id="report_cliente" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary flex-grow bg-gray-700 text-white">
                            <option value="">Todos os Clientes</option>
                        </select>
                        <input type="date" id="report_start_date" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        <span class="font-medium text-gray-300">at√©</span>
                        <input type="date" id="report_end_date" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        <button onclick="generateReport()" class="bg-novan-primary hover:bg-violet-700 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Gerar Relat√≥rio
                        </button>
                        <!-- BOT√ïES DE EXPORTA√á√ÉO SEPARADOS -->
                        <button onclick="exportReportAsCSV()" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Exportar Dados (CSV)
                        </button>
                        <button onclick="exportCombinedReportAsPNG()" class="bg-pink-700 hover:bg-pink-800 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Exportar Relat√≥rio (PNG)
                        </button>
                        <!-- FIM BOT√ïES DE EXPORTA√á√ÉO SEPARADOS -->
                    </div>
                </div>

                <div id="chartsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Gr√°fico 1: Gasto vs Faturamento -->
                    <div class="bg-novan-secondary p-6 rounded-xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-4 text-white">Gasto vs Faturamento (R$)</h3>
                        <canvas id="investimentoFaturamentoChart"></canvas>
                    </div>
                    
                    <!-- Gr√°fico 2: Impress√µes vs Cliques -->
                    <div class="bg-novan-secondary p-6 rounded-xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-4 text-white">Impress√µes vs Cliques (Volume)</h3>
                        <canvas id="impressoesCliquesChart"></canvas>
                    </div>

                    <!-- Gr√°fico 3: ROAS M√©dio por Per√≠odo -->
                    <div class="bg-novan-secondary p-6 rounded-xl shadow-lg lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-4 text-white">ROAS M√©dio Di√°rio (X)</h3>
                        <canvas id="roasChart"></canvas>
                    </div>
                    
                    <p id="noReportData" class="text-center text-gray-400 col-span-full hidden">Selecione filtros e gere o relat√≥rio para visualizar os gr√°ficos.</p>
                </div>

            </section>
        </main>
    </div>
    <!-- Fim Dashboard Principal -->

    <!-- Modal de Confirma√ß√£o de Conclus√£o (NOVO) -->
    <div id="completionConfirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-slate-800 p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-4 text-green-500">‚úÖ Confirmar Conclus√£o</h3>
            <p class="text-gray-300 mb-6">Tem certeza que deseja marcar esta tarefa como **Conclu√≠da**?</p>
            
            <div class="space-y-4">
                <label class="flex items-center text-gray-300">
                    <input type="checkbox" id="checkCompleted" required class="h-4 w-4 text-green-500 border-gray-600 rounded focus:ring-green-500 mr-2">
                    A tarefa foi realmente conclu√≠da e revisada.
                </label>
                <label class="flex items-center text-gray-300">
                    <input type="checkbox" id="checkDriveUpload" required class="h-4 w-4 text-green-500 border-gray-600 rounded focus:ring-green-500 mr-2">
                    Os arquivos finais foram hospedados/anexados no Google Drive/Cloud.
                </label>
            </div>

            <p id="completionWarning" class="text-xs text-red-400 mt-4 hidden">Por favor, marque as duas caixas de confirma√ß√£o para concluir a tarefa.</p>

            <div class="flex justify-between space-x-3 mt-6">
                <button id="cancelCompletionBtn" onclick="closeCompletionModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold p-2 rounded-lg flex-1">
                    Cancelar
                </button>
                <button id="confirmCompletionBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold p-2 rounded-lg flex-1">
                    Concluir e Salvar
                </button>
            </div>
        </div>
    </div>
    <!-- Fim Modal de Confirma√ß√£o de Conclus√£o -->

    <script type="module">
        // --- CONFIGURA√á√ÉO E INICIALIZA√á√ÉO DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged, 
            setPersistence, 
            browserSessionPersistence, 
            browserLocalPersistence,
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            addDoc, 
            deleteDoc, 
            onSnapshot,
            query,
            where,
            getDocs,
            updateDoc // Importar updateDoc
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        
        // Sua Configura√ß√£o Firebase (NOVA)
        const firebaseConfig = {
            apiKey: "AIzaSyCTj0St5odkB_t_7_gpbOAcAVDkoXWCFDk",
            authDomain: "novangestao.firebaseapp.com",
            projectId: "novangestao",
            storageBucket: "novangestao.firebasestorage.app",
            messagingSenderId: "740883145809",
            appId: "1:740883145809:web:7087959104b24526028470"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); // Inicializa o Firestore

        // --- Vari√°veis globais para armazenar dados e inst√¢ncias ---
        let clients = [];
        let results = [];
        let tasks = [];
        let currentMonth = new Date();
        let taskIdToConfirm = null; // Vari√°vel global para armazenar a tarefa sendo confirmada
        
        // Vari√°veis de cole√ß√µes (ser√£o definidas ap√≥s a autentica√ß√£o)
        let userId = null;
        let clientsCollection, resultsCollection, tasksCollection;
        
        let invFatChartInstance, imprCliquesChartInstance, roasChartInstance;
        let reportSummaryMetrics = null; // Armazena as m√©tricas de resumo
        let reportDetailedResults = []; // NOVO: Armazena os resultados filtrados para o relat√≥rio PNG

        // Lista global de respons√°veis da ag√™ncia
        const AGENCY_RESPONSIBLES = ["L√©o Begalli", "Fabio Franco", "Outro"];

        const COLORS = {
            primary: '#6D28D9', // Roxo principal
            secondary: '#0F172A',
            investimento: '#EF4444', // Red 500
            faturamento: '#10B981',  // Green 500
            impressoes: '#3B82F6',   // Blue 500
            cliques: '#EC4899',      // Pink 500
            roas: '#F59E0B'          // Amber 500
        };
        
        // Cores do Relat√≥rio PNG
        const NAVY_BLUE = '#0E1B31'; 
        const LIGHT_TEXT = '#E2E8F0'; // light gray/off-white

        // --- CONFIGURA√á√ÉO GEMINI API ---
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_KEY = ""; // Ser√° preenchida pelo Canvas
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;


        // --- FUN√á√ïES DE AUTENTICA√á√ÉO ---
        
        // Oculta a tela de login e mostra o dashboard
        function showDashboard() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');
            document.getElementById('dashboard-container').classList.add('flex');
            
            // A inicializa√ß√£o da aplica√ß√£o (initAppContent) agora √© chamada pelo onAuthStateChanged
        }

        // Oculta o dashboard e mostra a tela de login
        function showLogin() {
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('flex');
            document.getElementById('login-page').classList.remove('hidden');
        }

        /** Lida com o Login */
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login_email').value;
            const password = document.getElementById('login_password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const errorEl = document.getElementById('authError');
            errorEl.classList.add('hidden');
            
            const persistenceType = rememberMe ? browserLocalPersistence : browserSessionPersistence;
            
            try {
                // 1. Define a persist√™ncia
                await setPersistence(auth, persistenceType);
                
                // 2. Realiza o login
                await signInWithEmailAndPassword(auth, email, password);
                
                // O onAuthStateChanged lidar√° com a transi√ß√£o para o dashboard

            } catch (error) {
                let errorMessage = "Erro de Autentica√ß√£o. Verifique seu email e senha.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Credenciais inv√°lidas. Tente novamente.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "O endere√ßo de email √© inv√°lido.";
                }
                errorEl.textContent = errorMessage;
                errorEl.classList.remove('hidden');
                console.error("Erro de Login:", error);
            }
        }

        document.getElementById('loginForm').addEventListener('submit', handleLogin);

        /** Lida com o Logout */
        window.handleLogout = function() {
            signOut(auth).then(() => {
                // O onAuthStateChanged lidar√° com a transi√ß√£o para a tela de login
                showMessage("Sess√£o encerrada com sucesso.", 3000, true);
            }).catch((error) => {
                console.error("Erro ao fazer logout:", error);
                showMessage("Erro ao sair. Verifique sua conex√£o.", 3000, true);
            });
        }

        /** Observa o estado da autentica√ß√£o (chamado automaticamente pelo Firebase) */
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Usu√°rio logado
                userId = user.uid; // Define o userId global
                // Inicializa os listeners e o conte√∫do da aplica√ß√£o
                await initAppContent(); 
                showDashboard();
            } else {
                // Usu√°rio deslogado 
                showLogin();
                // O usu√°rio s√≥ conseguir√° acessar o dashboard se fizer login por email/senha.
                userId = null; 
            }
        });

        /** Alterna a visibilidade da senha no campo de login */
        window.togglePasswordVisibility = function() {
            const passwordInput = document.getElementById('login_password');
            const toggleIcon = document.getElementById('togglePasswordIcon');
            const path1 = document.getElementById('togglePasswordPath1');
            const path2 = document.getElementById('togglePasswordPath2');
            
            const isPassword = passwordInput.type === 'password';

            if (isPassword) {
                // Mudar para texto (Olho aberto)
                passwordInput.type = 'text';
                path1.setAttribute('d', 'M15 12a3 3 0 11-6 0 3 3 0 016 0z');
                path2.setAttribute('d', 'M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z');
                toggleIcon.setAttribute('title', 'Ocultar Senha');
                
            } else {
                // Mudar para senha (Olho fechado/slash)
                passwordInput.type = 'password';
                path1.setAttribute('d', 'M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7 1.274-4.057 5.065-7 9.542-7a10.05 10.05 0 011.875.175m-2.031 3.22A3.001 3.001 0 0012 15a3 3 0 003-3h-1.062a4.986 4.986 0 01-1.429-1.429m1.43-1.43a3 3 0 00-4.243 4.243M9.879 9.879l4.242 4.242M9.88 9.88l.585-.585M12 15a3 3 0 01-3-3h1.062a4.986 4.986 0 001.429 1.429m-1.43 1.43a3 3 0 014.243-4.243m-4.243 4.243l4.242-4.242'); // Simplifica√ß√£o para mostrar o olho cortado/slashed
                path2.setAttribute('d', 'M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7 1.274-4.057 5.065-7 9.542-7a10.05 10.05 0 011.875.175'); // Ajusta um path para ser mais consistente com o visual de olho fechado
                toggleIcon.setAttribute('title', 'Exibir Senha');

            }
        }


        // --- FUN√á√ïES DE UTILIDADE (SEM FIRESTORE) ---

        /** Exibe uma mensagem de feedback na tela */
        function showMessage(text, duration = 3000, isError = false) {
            const box = document.getElementById('messageBox');
            box.textContent = text;
            box.classList.remove('hidden', 'bg-red-500', 'bg-novan-primary');
            box.classList.add(isError ? 'bg-red-500' : 'bg-novan-primary');
            
            setTimeout(() => {
                box.classList.add('hidden');
            }, duration);
        }

        /** Formata um n√∫mero para moeda BRL (R$ 1.000,00) */
        function formatCurrency(value) {
            const num = parseFloat(value);
            return isNaN(num) ? 'R$ 0,00' : num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        /** * Formata um n√∫mero para o padr√£o brasileiro (1.000,32) sem o s√≠mbolo R$. */
        function formatValueBRL(value) {
            const num = parseFloat(value);
            if (isNaN(num)) return '0,00';
            const currencyString = num.toLocaleString('pt-BR', { 
                style: 'currency', 
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            return currencyString.replace('R$', '').trim();
        }

        /** Formata um n√∫mero para 2 casas decimais (ROAS) */
        function formatNumber(value) {
            const num = parseFloat(value);
            return isNaN(num) ? '0.00' : num.toFixed(2);
        }
        
        /** Fechad o modal de resumo */
        window.closeSummaryModal = function() {
            document.getElementById('summaryModal').classList.remove('flex');
            document.getElementById('summaryModal').classList.add('hidden');
        }

        /** Utility: Adiciona um offset para garantir que a data YYYY-MM-DD seja lida localmente (Fix Timezone Bug) */
        function getLocalDayDate(dateString) {
            return new Date(dateString + 'T12:00:00'); 
        }

        /** Calcula o Custo por Aquisi√ß√£o (CPA) */
        function calculateCPA(gasto, aquisicoes) {
            if (aquisicoes === 0 || gasto === 0) return 0;
            return gasto / aquisicoes;
        }

        /** Calcula o Retorno sobre o Investimento (ROAS) */
        function calculateROAS(investimento, vendas) {
            if (investimento === 0) return 0;
            return vendas / investimento;
        }
        
        /** Calcula o Custo por Mil Impress√µes (CPM) */
        function calculateCPM(investimento, impressoes) {
            if (impressoes === 0 || investimento === 0) return 0;
            return (investimento / impressoes) * 1000;
        }


        // --- GEST√ÉO DE TABS ---

        /** Muda a aba ativa na UI */
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tabId}`).classList.add('active');
            
            // A√ß√µes espec√≠ficas ao trocar de aba (Renderiza√ß√µes agora s√£o chamadas pelo onSnapshot)
        }

        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', () => switchTab(item.dataset.tab));
        });
        
        // --- ABA 3: CADASTRO DE CLIENTES (CRUD FIRESTORE) ---

        /** Aplica a m√°scara (00) 00000-0000 ao telefone */
        window.maskPhone = function(input) {
            let value = input.value.replace(/\D/g, ''); // Remove todos os caracteres n√£o num√©ricos

            // Limita a 11 d√≠gitos (incluindo o 9 extra de celular)
            if (value.length > 11) {
                value = value.substring(0, 11);
            }
            
            // Aplica a m√°scara (XX) XXXXX-XXXX
            value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
            value = value.replace(/(\d{5})(\d)/, '$1-$2');

            input.value = value;
        }

        /** Popula o dropdown de Respons√°veis */
        function populateResponsiblesSelect() {
            const select = document.getElementById('cli_responsavel');
            if (!select) return;

            // Limpa e adiciona a op√ß√£o padr√£o
            select.innerHTML = '<option value="">Selecione o Respons√°vel da Ag√™ncia</option>';

            AGENCY_RESPONSIBLES.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        
        /** Alterna a visualiza√ß√£o do formul√°rio entre Tr√°fego Pago e Social Media */
        window.showClientFormType = function(type) {
            const trafficFields = document.getElementById('trafficFields');
            const socialMediaFields = document.getElementById('socialMediaFields');
            const formTitle = document.getElementById('clientFormTitle');
            const btnTraffic = document.getElementById('btn_type_traffic');
            const btnSocial = document.getElementById('btn_type_social');
            const cliServiceType = document.getElementById('cli_service_type');

            if (type === 'traffic') {
                // Configura√ß√µes para Tr√°fego Pago
                trafficFields.classList.remove('hidden');
                socialMediaFields.classList.add('hidden');
                formTitle.textContent = 'Formul√°rio de Tr√°fego Pago';
                btnTraffic.classList.replace('bg-gray-700', 'bg-novan-primary');
                btnTraffic.classList.replace('text-white', 'text-white');
                btnSocial.classList.replace('bg-novan-primary', 'bg-gray-700');
                btnSocial.classList.replace('text-white', 'text-white');
                btnTraffic.classList.add('hover:bg-violet-700');
                btnSocial.classList.remove('hover:bg-violet-700');
                cliServiceType.value = 'traffic';

                // Torna campos de tr√°fego obrigat√≥rios e de SM n√£o-obrigat√≥rios
                document.getElementById('cli_plataforma_traffic').required = true;
                document.getElementById('cli_budget_type_traffic').required = true;
                document.getElementById('cli_budget_value_traffic').required = true;
                document.getElementById('cli_conversion_goals_traffic').required = true;
                document.getElementById('cli_sm_platform').required = false;
                document.getElementById('cli_sm_fee').required = false;
                document.getElementById('cli_sm_needs').required = false;
                
            } else if (type === 'social') {
                // Configura√ß√µes para Social Media
                trafficFields.classList.add('hidden');
                socialMediaFields.classList.remove('hidden');
                formTitle.textContent = 'Formul√°rio de Social Media';
                btnSocial.classList.replace('bg-gray-700', 'bg-novan-primary');
                btnSocial.classList.replace('text-white', 'text-white');
                btnTraffic.classList.replace('bg-novan-primary', 'bg-gray-700');
                btnTraffic.classList.replace('text-white', 'text-white');
                btnSocial.classList.add('hover:bg-violet-700');
                btnTraffic.classList.remove('hover:bg-violet-700');
                cliServiceType.value = 'social';

                // Torna campos de SM obrigat√≥rios e de tr√°fego n√£o-obrigat√≥rios
                document.getElementById('cli_plataforma_traffic').required = false;
                document.getElementById('cli_budget_type_traffic').required = false;
                document.getElementById('cli_budget_value_traffic').required = false;
                document.getElementById('cli_conversion_goals_traffic').required = false;
                document.getElementById('cli_sm_platform').required = true;
                document.getElementById('cli_sm_fee').required = true;
                document.getElementById('cli_sm_needs').required = true;
            }

            // Garante que o formul√°rio est√° no modo de cadastro ao trocar de tipo
            if (document.getElementById('cli_id_edit').value === "") {
                resetClientForm();
            }
        }
        
        /** Reseta o formul√°rio de cliente para o modo de Cadastro */
        window.resetClientForm = function() {
            document.getElementById('clientForm').reset();
            document.getElementById('cli_id_edit').value = "";
            document.getElementById('clientSubmitButton').textContent = "Cadastrar Cliente";
            document.getElementById('clientCancelButton').classList.add('hidden');
        }
        
        /** Carrega os dados do cliente no formul√°rio para edi√ß√£o */
        window.editClient = function(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                return showMessage('Cliente n√£o encontrado.', true);
            }
            
            // 1. Alterna o tipo de formul√°rio e define o ID para edi√ß√£o
            showClientFormType(client.serviceType);
            document.getElementById('cli_id_edit').value = clientId;

            // 2. Popula campos comuns
            document.getElementById('cli_nome').value = client.nome;
            document.getElementById('cli_responsavel').value = client.responsavel;
            document.getElementById('cli_telefone').value = client.telefone;
            document.getElementById('cli_link').value = client.link;
            document.getElementById('cli_observacoes').value = client.observacoes;

            // 3. Popula campos espec√≠ficos
            if (client.serviceType === 'traffic') {
                document.getElementById('cli_plataforma_traffic').value = client.platformTraffic;
                document.getElementById('cli_budget_type_traffic').value = client.budgetType;
                document.getElementById('cli_budget_value_traffic').value = client.budgetValue;
                document.getElementById('cli_conversion_goals_traffic').value = client.conversionGoal;
            } else if (client.serviceType === 'social') {
                document.getElementById('cli_sm_platform').value = client.platformSM;
                document.getElementById('cli_sm_fee').value = client.smFee;
                document.getElementById('cli_sm_needs').value = client.smNeeds;
            }

            // 4. Altera bot√µes de submiss√£o
            document.getElementById('clientSubmitButton').textContent = "Salvar Altera√ß√µes";
            document.getElementById('clientCancelButton').classList.remove('hidden');
            
            showMessage(`Modo de Edi√ß√£o ativado para ${client.nome}.`, false, true);
        }


        /** Renderiza a lista de clientes cadastrados */
        function renderClientList() {
            const listEl = document.getElementById('clientList');
            const noClientsEl = document.getElementById('noClients');
            
            // Checagem de nulidade
            if (!listEl || !noClientsEl) {
                return;
            }

            // Limpa apenas o container dos cards
            listEl.innerHTML = ''; 

            if (clients.length === 0) {
                noClientsEl.classList.remove('hidden');
                return;
            }
            noClientsEl.classList.add('hidden');

            clients.forEach(client => {
                const card = document.createElement('div');
                // Alterado de bg-white para bg-slate-800 e texto para claro
                card.className = 'bg-slate-800 p-4 rounded-xl shadow-md border-t-4 border-novan-primary text-gray-300'; 
                
                let detailListHtml = '';
                let mainPlatformDisplay = '';

                if (client.serviceType === 'traffic') {
                    // Dados de TR√ÅFEGO PAGO
                    const budgetLabel = client.budgetType || 'Or√ßamento';
                    // USANDO formatCurrency POIS √â O DISPLAY COMPLETO
                    const budgetValue = client.budgetValue ? formatCurrency(client.budgetValue) : 'N/A';
                    const goal = client.conversionGoal || 'N/A';
                    mainPlatformDisplay = client.platformTraffic || 'N/A';

                    detailListHtml = `
                        <li><span class="font-medium">${budgetLabel}:</span> ${budgetValue}</li> 
                        <li><span class="font-medium">Meta Principal:</span> ${goal}</li> 
                    `;
                    
                    // Adicionar hist√≥rico de or√ßamento para visualiza√ß√£o
                    if (client.budgetHistory && client.budgetHistory.length > 0) {
                        const latestHistory = client.budgetHistory[client.budgetHistory.length - 1];
                         detailListHtml += `<li title="Or√ßamento anterior: ${latestHistory.type} ${formatCurrency(latestHistory.value)} em ${new Date(latestHistory.date).toLocaleDateString('pt-BR')}" class="text-gray-400 text-xs mt-1">
                            Hist√≥rico (Hover)
                         </li>`;
                    }
                    
                } else if (client.serviceType === 'social') {
                    // Dados de SOCIAL MEDIA
                    // USANDO formatCurrency POIS √â O DISPLAY COMPLETO
                    const feeValue = client.smFee ? formatCurrency(client.smFee) : 'N/A';
                    const smNeeds = client.smNeeds || 'N/A';
                    mainPlatformDisplay = client.platformSM || 'N/A';

                    detailListHtml = `
                        <li><span class="font-medium">Fee Mensal:</span> ${feeValue}</li>
                        <li><span class="font-medium">Foco de Conte√∫do:</span> ${smNeeds}</li>
                    `;
                }

                card.innerHTML = `
                    <h4 class="font-bold text-lg text-white">${client.nome}</h4>
                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${client.serviceType === 'traffic' ? 'bg-purple-200 text-novan-primary' : 'bg-pink-200 text-pink-700'}">
                        ${client.serviceType === 'traffic' ? 'TR√ÅFEGO PAGO' : 'SOCIAL MEDIA'}
                    </span>
                    <p class="text-sm my-2">Respons√°vel: <span class="font-semibold">${client.responsavel}</span></p>
                    <p class="text-sm mb-2">${client.telefone}</p>
                    <ul class="text-xs space-y-1">
                        <li><span class="font-medium">Plataforma:</span> ${mainPlatformDisplay}</li>
                        ${detailListHtml}
                        <li><span class="font-medium">Link:</span> <a href="${client.link}" target="_blank" class="text-indigo-400 hover:underline">${client.link ? 'Acessar' : 'N/A'}</a></li>
                        <li class="mt-2"><span class="font-medium">Nicho/Obs.:</span> ${client.observacoes || 'N/A'}</li>
                    </ul>
                    <div class="flex space-x-3 mt-3">
                        <button onclick="editClient('${client.id}')" class="text-indigo-400 hover:text-indigo-300 text-xs font-semibold">Editar</button>
                        <button onclick="deleteClient('${client.id}')" class="text-red-500 hover:text-red-400 text-xs">Excluir</button>
                    </div>
                `;
                listEl.appendChild(card);
            });
        }

        /** Popula os dropdowns de cliente em todas as abas */
        function populateClientSelects() {
            const selects = [
                document.getElementById('res_cliente'),
                document.getElementById('task_cliente'),
                document.getElementById('filterClient'),
                document.getElementById('report_cliente'),
                document.getElementById('task_manager_filter_client'),
                document.getElementById('results_filter_cliente') // ADICIONADO: Novo filtro de cliente da Aba 1
            ];

            selects.forEach(select => {
                // Checa se o elemento existe antes de tentar manipul√°-lo
                if (!select) return;
                
                const selectedValue = select.value;
                select.innerHTML = select.id.includes('filter') || select.id.includes('report') || select.id.includes('manager_filter_client') || select.id.includes('results_filter') ? 
                                    '<option value="">Todos os Clientes</option>' : 
                                    '<option value="">Selecione o Cliente</option>';
                
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.nome;
                    if (client.id === selectedValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });
        }

        /** L√≥gica de submiss√£o do formul√°rio de cliente (Cadastro ou Edi√ß√£o) */
        document.getElementById('clientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) return showMessage('Erro de autentica√ß√£o. Recarregue a p√°gina.', 3000, true);
            
            const clientIdToEdit = document.getElementById('cli_id_edit').value;
            const isEditing = clientIdToEdit !== "";
            const clientIndex = clients.findIndex(c => c.id === clientIdToEdit);
            
            const serviceType = document.getElementById('cli_service_type').value;

            // Prepara o objeto de dados (sem o ID)
            let clientData = {};
            
            // Corrige a cor do cliente ao editar
            if (isEditing) {
                const existingClient = clients.find(c => c.id === clientIdToEdit);
                clientData.color = existingClient ? existingClient.color : generateClientColor(clients.length);
            } else {
                clientData.color = generateClientColor(clients.length);
            }


            // CAMPOS COMUNS
            clientData.serviceType = serviceType;
            clientData.nome = document.getElementById('cli_nome').value;
            clientData.responsavel = document.getElementById('cli_responsavel').value;
            clientData.telefone = document.getElementById('cli_telefone').value;
            clientData.link = document.getElementById('cli_link').value;
            clientData.observacoes = document.getElementById('cli_observacoes').value;
            
            // Guarda valores antigos para compara√ß√£o (apenas para Tr√°fego Pago)
            const oldBudgetType = isEditing ? clients[clientIndex]?.budgetType : null;
            const oldBudgetValue = isEditing ? clients[clientIndex]?.budgetValue : null;

            // Inicializa ou mant√©m o hist√≥rico de or√ßamento
            clientData.budgetHistory = isEditing && clients[clientIndex]?.budgetHistory ? clients[clientIndex].budgetHistory : [];


            if (serviceType === 'traffic') {
                // Coleta dados espec√≠ficos de Tr√°fego Pago
                clientData.platformTraffic = document.getElementById('cli_plataforma_traffic').value;
                clientData.budgetType = document.getElementById('cli_budget_type_traffic').value;
                clientData.budgetValue = parseFloat(document.getElementById('cli_budget_value_traffic').value);
                clientData.conversionGoal = document.getElementById('cli_conversion_goals_traffic').value;
                clientData.plataforma = clientData.platformTraffic; 
                
                // L√ìGICA DE HIST√ìRICO DE OR√áAMENTO (Apenas se estiver editando E houver mudan√ßa)
                if (isEditing && (oldBudgetType !== clientData.budgetType || oldBudgetValue !== clientData.budgetValue)) {
                    // Adiciona o or√ßamento *antigo* ao hist√≥rico
                    clientData.budgetHistory.push({
                        date: new Date().toISOString(),
                        type: oldBudgetType,
                        value: oldBudgetValue
                    });
                }


            } else if (serviceType === 'social') {
                // Coleta dados espec√≠ficos de Social Media
                clientData.platformSM = document.getElementById('cli_sm_platform').value;
                // CORRE√á√ÉO: Trata o smFee como float, mas permite que seja 0
                clientData.smFee = parseFloat(document.getElementById('cli_sm_fee').value || 0); 
                clientData.smNeeds = document.getElementById('cli_sm_needs').value;
                clientData.plataforma = clientData.platformSM;
                
                // Limpa campos de tr√°fego que podem existir de um modo anterior
                delete clientData.platformTraffic;
                delete clientData.budgetType;
                delete clientData.budgetValue;
                delete clientData.conversionGoal;
                clientData.budgetHistory = []; // Limpa o hist√≥rico se mudar para Social
            }

            try {
                if (!isEditing) {
                    // Adiciona um novo documento (CREATE)
                    await addDoc(clientsCollection, clientData);
                    showMessage(`Cliente ${clientData.nome} cadastrado com sucesso!`);
                } else {
                    // Atualiza um documento existente (UPDATE)
                    const docRef = doc(db, 'users', userId, 'clients', clientIdToEdit);
                    await setDoc(docRef, clientData, { merge: true }); // setDoc com merge atualiza ou cria
                    showMessage(`Cliente ${clientData.nome} atualizado com sucesso!`);
                    resetClientForm(); // Volta ao modo de cadastro ap√≥s salvar
                }
                
                document.getElementById('clientForm').reset();
                showClientFormType('traffic'); 
                // As renderiza√ß√µes s√£o feitas pelo onSnapshot

            } catch (error) {
                console.error("Erro ao salvar cliente:", error);
                showMessage(`Erro ao salvar cliente: ${error.message}`, 5000, true);
            }
        });

        /** Deleta um cliente e todos os dados associados - FIRESTORE */
        window.deleteClient = async function(clientId) {
            if (!userId) return showMessage('Erro de autentica√ß√£o. Recarregue a p√°gina.', 3000, true);
            
            try {
                // 1. Deletar o documento do cliente
                const clientDocRef = doc(db, 'users', userId, 'clients', clientId);
                await deleteDoc(clientDocRef);

                // 2. Deletar resultados associados
                const resultsQuery = query(resultsCollection, where("clientId", "==", clientId));
                const resultsSnapshot = await getDocs(resultsQuery);
                const deleteResultsPromises = resultsSnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deleteResultsPromises);

                // 3. Deletar tarefas associadas
                const tasksQuery = query(tasksCollection, where("clientId", "==", clientId));
                const tasksSnapshot = await getDocs(tasksQuery);
                const deleteTasksPromises = tasksSnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deleteTasksPromises);

                showMessage('Cliente e todos os dados associados exclu√≠dos.', 3000, true);
                // onSnapshot atualizar√° a UI
            } catch (error) {
                console.error("Erro ao deletar cliente:", error);
                showMessage(`Erro ao deletar cliente: ${error.message}`, 5000, true);
            }
        }
        
        // Fun√ß√£o para gerar uma cor de cliente pseudo-√∫nica
        function generateClientColor(index) {
            const colors = ['#6D28D9', '#059669', '#DC2626', '#FBBF24', '#3B82F6', '#EC4899', '#14B8A6'];
            return colors[index % colors.length];
        }


        // --- ABA 1: RESULTADOS DE CAMPANHAS (CRUD FIRESTORE) ---

        /** Renderiza os KPI Cards (Agregados) */
        function renderKpiCards(data, summary, containerId = 'kpiCardsContainer') {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Se n√£o houver dados, exibe zeros
            const defaultMetrics = { totalGasto: 0, totalFaturamento: 0, avgROAS: 0, avgCPA: 0, avgCPM: 0 };
            const metrics = data.length > 0 ? summary : defaultMetrics;
            
            const kpiCardsHtml = `
                <!-- KPI 1: Gasto Total -->
                <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-red-500">
                    <p class="text-sm font-medium text-gray-400">Gasto Total</p>
                    <p class="text-2xl font-bold text-red-500 mt-1">${formatCurrency(metrics.totalGasto)}</p>
                </div>
                <!-- KPI 2: Faturamento -->
                <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-green-500">
                    <p class="text-sm font-medium text-gray-400">Faturamento</p>
                    <p class="text-2xl font-bold text-green-500 mt-1">${formatCurrency(metrics.totalFaturamento)}</p>
                </div>
                <!-- KPI 3: ROAS M√©dio -->
                <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-yellow-500">
                    <p class="text-sm font-medium text-gray-400">ROAS M√©dio (X)</p>
                    <p class="text-2xl font-bold text-yellow-500 mt-1">${formatNumber(metrics.avgROAS)}X</p>
                </div>
                <!-- KPI 4: CPA M√©dio -->
                <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-indigo-500">
                    <p class="text-sm font-medium text-gray-400">CPA M√©dio (R$)</p>
                    <p class="text-2xl font-bold text-indigo-500 mt-1">${formatCurrency(metrics.avgCPA)}</p>
                </div>
                <!-- KPI 5: CPM M√©dio -->
                <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-blue-500">
                    <p class="text-sm font-medium text-gray-400">CPM M√©dio (R$)</p>
                    <p class="text-2xl font-bold text-blue-500 mt-1">${formatCurrency(metrics.avgCPM)}</p>
                </div>
            `;

            container.innerHTML = kpiCardsHtml;
        }

        /** Renderiza o hist√≥rico de resultados em formato de Cart√µes/Lista (Chamado pelo onSnapshot) */
        window.renderResultsTable = function() {
            const listContainer = document.getElementById('resultsListContainer');
            const resultsFilterClient = document.getElementById('results_filter_cliente')?.value; 
            const resultsFilterStartDate = document.getElementById('results_filter_start_date')?.value;
            const resultsFilterEndDate = document.getElementById('results_filter_end_date')?.value;
            
            if (!listContainer) return; 

            // Filtra apenas resultados de clientes de TR√ÅFEGO PAGO
            const trafficClientsIds = clients.filter(c => c.serviceType === 'traffic' || !c.serviceType).map(c => c.id);
            let filteredResults = results.filter(r => trafficClientsIds.includes(r.clientId));

            // Aplica Filtros
            if (resultsFilterClient) {
                filteredResults = filteredResults.filter(r => r.clientId === resultsFilterClient);
            }
            if (resultsFilterStartDate) {
                filteredResults = filteredResults.filter(r => r.data >= resultsFilterStartDate);
            }
            if (resultsFilterEndDate) {
                filteredResults = filteredResults.filter(r => r.data <= resultsFilterEndDate);
            }

            // --- C√ÅLCULO DAS M√âTRICAS DE RESUMO (Geral) ---
            let summaryMetrics = {
                totalGasto: 0, totalFaturamento: 0, totalConversoes: 0, totalImpressoes: 0,
                avgROAS: 0, avgCPA: 0, avgCPM: 0
            };

            if (filteredResults.length > 0) {
                summaryMetrics = filteredResults.reduce((acc, r) => {
                    acc.totalGasto += r.investimento;
                    acc.totalFaturamento += r.vendas;
                    acc.totalConversoes += r.conversionCount || 0;
                    acc.totalImpressoes += r.impressoes;
                    return acc;
                }, summaryMetrics);

                summaryMetrics.avgCPA = calculateCPA(summaryMetrics.totalGasto, summaryMetrics.totalConversoes);
                summaryMetrics.avgROAS = calculateROAS(summaryMetrics.totalGasto, summaryMetrics.totalFaturamento);
                summaryMetrics.avgCPM = calculateCPM(summaryMetrics.totalGasto, summaryMetrics.totalImpressoes);
            }
            
            // RENDERIZA√á√ÉO DOS KPI CARDS AGREGADOS (Topo)
            renderKpiCards(filteredResults, summaryMetrics);

            listContainer.innerHTML = '';

            if (filteredResults.length === 0) {
                document.getElementById('noResults').classList.remove('hidden');
                return;
            }
            document.getElementById('noResults').classList.add('hidden');

            // Ordena por data decrescente
            const sortedResults = filteredResults.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            let listHtml = '';

            sortedResults.forEach(res => {
                const client = clients.find(c => c.id === res.clientId);
                const clientName = client?.nome || 'Cliente Desconhecido';
                const clientColor = client?.color || COLORS.primary;
                const displayDate = getLocalDayDate(res.data).toLocaleDateString('pt-BR');
                
                const cpa = calculateCPA(res.investimento, res.conversionCount);
                const roas = calculateROAS(res.investimento, res.vendas);
                const cpm = calculateCPM(res.investimento, res.impressoes);
                const conversionType = res.conversionType || 'N/D';
                const conversionCount = res.conversionCount || 0;

                listHtml += `
                    <div class="bg-slate-800 p-4 rounded-xl shadow-md border-l-8 hover:bg-slate-700 transition duration-150" style="border-left-color: ${clientColor};">
                        
                        <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
                            <h3 class="text-lg font-bold text-white">${clientName}</h3>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-400">${displayDate}</span>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded bg-gray-700 text-gray-300">${res.plataforma}</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-2">
                            <div class="flex flex-col">
                                <span class="text-sm text-gray-400">Gasto</span>
                                <span class="font-bold text-red-500">${formatCurrency(res.investimento)}</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-sm text-gray-400">Faturamento</span>
                                <span class="font-bold text-green-500">${formatCurrency(res.vendas)}</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-sm text-gray-400">ROAS</span>
                                <span class="font-bold text-yellow-500">${formatNumber(roas)}X</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-sm text-gray-400">CPA</span>
                                <span class="font-bold text-indigo-500">${formatCurrency(cpa)}</span>
                            </div>
                        </div>

                        <div class="text-sm text-gray-400 border-t border-gray-700 pt-2">
                            <span class="font-semibold text-white">Convers√£o:</span> ${conversionType.substring(0, 5)}. (${conversionCount.toLocaleString('pt-BR')})
                            <span class="ml-4 font-semibold text-white">CPM:</span> ${formatCurrency(cpm)}
                        </div>

                        <!-- Observa√ß√µes e A√ß√µes -->
                        <p class="text-xs italic text-gray-500 mt-2">
                            Obs: ${res.observacoes || 'N/A'}
                        </p>
                        <div class="flex justify-end space-x-3 mt-3">
                            <button onclick="editResult('${res.id}')" class="text-indigo-400 hover:text-indigo-300 text-sm font-semibold">Editar</button>
                            <button onclick="deleteResult('${res.id}')" class="text-red-500 hover:text-red-400 text-sm">Excluir</button>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = listHtml;
        }
        
        /** Deleta um registro de resultado - FIRESTORE */
        window.deleteResult = async function(resultId) {
            if (!userId) return showMessage('Erro de autentica√ß√£o. Recarregue a p√°gina.', 3000, true);
            const docRef = doc(db, 'users', userId, 'results', resultId);
            await deleteDoc(docRef);
            showMessage('Registro exclu√≠do.', 3000, true);
            // onSnapshot atualizar√° a UI
        }

        /** L√≥gica de Parsing do texto (Mensagem Pronta) */
        window.parseAndFillMetrics = function() {
            const rawText = document.getElementById('rawMetricsInput').value;
            if (!rawText) {
                return showMessage('Cole o texto das m√©tricas na caixa acima primeiro.', 4000, true);
            }
            
            // Fun√ß√£o auxiliar para extrair um valor num√©rico (padr√£o BR)
            const extractValue = (keyPattern) => {
                const regex = new RegExp(`(?:${keyPattern})\\s*[:\\-\\sR$]*([\\d\\.\\,\\s]+)`, 'i');
                const match = rawText.match(regex);
                
                if (match && match[1]) {
                    let value = match[1].trim().replace(/\./g, '').replace(/,/g, '.');
                    const num = parseFloat(value);
                    return isNaN(num) ? 0 : num;
                }
                return 0;
            };

            // Mapeamento e Extra√ß√£o de M√©tricas (Baseado no formato do usu√°rio)
            const metrics = {
                investimento: extractValue('Investimento Total|Gasto'),
                vendas: extractValue('Faturamento Total|Faturamento|Vendas'),
                impressoes: extractValue('Impress√µes'),
                cliques: extractValue('Cliques'),
                alcance: extractValue('Alcance'),
                conversionCount: extractValue('Pedidos|Convers√µes|Compras|Leads')
            };

            // Preenchimento dos campos
            if (metrics.investimento > 0) document.getElementById('res_investimento').value = metrics.investimento.toFixed(2);
            if (metrics.vendas > 0) document.getElementById('res_vendas').value = metrics.vendas.toFixed(2);
            if (metrics.impressoes > 0) document.getElementById('res_impressoes').value = Math.round(metrics.impressoes);
            if (metrics.cliques > 0) document.getElementById('res_cliques').value = Math.round(metrics.cliques);
            if (metrics.alcance > 0) document.getElementById('res_alcance').value = Math.round(metrics.alcance);
            if (metrics.conversionCount > 0) document.getElementById('res_conversion_count').value = Math.round(metrics.conversionCount);
            
            updateMetricsDisplay();
            showMessage('M√©tricas principais preenchidas automaticamente!');
        }

        /** L√≥gica para c√°lculo em tempo real do CPA/ROAS/CPM no formul√°rio */
        function updateMetricsDisplay() {
            const investimento = parseFloat(document.getElementById('res_investimento').value) || 0;
            const vendas = parseFloat(document.getElementById('res_vendas').value) || 0;
            const impressoes = parseInt(document.getElementById('res_impressoes').value) || 0;
            const conversionCount = parseInt(document.getElementById('res_conversion_count').value) || 0; 

            const cpa = calculateCPA(investimento, conversionCount);
            const roas = calculateROAS(investimento, vendas);
            const cpm = calculateCPM(investimento, impressoes);

            document.getElementById('cpa_calc').textContent = formatValueBRL(cpa);
            document.getElementById('roas_calc').textContent = formatNumber(roas);
            document.getElementById('cpm_calc').textContent = formatValueBRL(cpm);
        }

        document.getElementById('res_investimento').addEventListener('input', updateMetricsDisplay);
        document.getElementById('res_vendas').addEventListener('input', updateMetricsDisplay);
        document.getElementById('res_impressoes').addEventListener('input', updateMetricsDisplay);
        document.getElementById('res_conversion_count').addEventListener('input', updateMetricsDisplay); 


        /** L√≥gica de submiss√£o do formul√°rio de resultados - FIRESTORE */
        document.getElementById('campaignForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) return showMessage('Erro de autentica√ß√£o. Recarregue a p√°gina.', 3000, true);
            
            const editId = document.getElementById('res_id_edit').value;
            const isEditing = editId !== "";
            
            const investimento = parseFloat(document.getElementById('res_investimento').value);
            const vendas = parseFloat(document.getElementById('res_vendas').value);
            const impressoes = parseInt(document.getElementById('res_impressoes').value);
            const conversionCount = parseInt(document.getElementById('res_conversion_count').value || 0);

            // Prepara o objeto de dados (sem o ID)
            const resultData = {
                data: document.getElementById('res_data').value,
                clientId: document.getElementById('res_cliente').value,
                plataforma: document.getElementById('res_plataforma').value,
                investimento: investimento,
                impressoes: impressoes,
                alcance: parseInt(document.getElementById('res_alcance').value),
                cliques: parseInt(document.getElementById('res_cliques').value), 
                conversionType: document.getElementById('res_conversion_type').value,
                conversionCount: conversionCount,
                vendas: vendas,
                cpa: calculateCPA(investimento, conversionCount),
                roas: calculateROAS(investimento, vendas),
                cpm: calculateCPM(investimento, impressoes),
                observacoes: document.getElementById('res_observacoes').value,
            };

            const displayDate = getLocalDayDate(resultData.data).toLocaleDateString('pt-BR');

            try {
                if (isEditing) {
                    const docRef = doc(db, 'users', userId, 'results', editId);
                    await setDoc(docRef, resultData, { merge: true });
                    showMessage(`Registro de ${resultData.plataforma} em ${displayDate} atualizado com sucesso!`);
                    document.getElementById('res_id_edit').value = "";
                    document.getElementById('resultsSubmitButton').textContent = 'Registrar Resultados';
                } else {
                    await addDoc(resultsCollection, resultData);
                    showMessage(`Resultado de ${resultData.plataforma} em ${displayDate} registrado!`);
                }
                
                document.getElementById('campaignForm').reset();
                updateMetricsDisplay(); // Limpa os campos de c√°lculo
                // onSnapshot atualizar√° a UI
            } catch (error) {
                console.error("Erro ao salvar resultado:", error);
                showMessage(`Erro ao salvar resultado: ${error.message}`, 5000, true);
            }
        });

        /** Gera resumo di√°rio */
        document.getElementById('btnResumoDiario').addEventListener('click', () => {
            const today = new Date().toISOString().split('T')[0];
            const dailyResults = results.filter(r => r.data === today);

            if (dailyResults.length === 0) {
                return showMessage('Nenhum registro encontrado para hoje.', true);
            }

            let html = '<ul class="space-y-3">';
            dailyResults.forEach(r => {
                const clientName = clients.find(c => c.id === r.clientId)?.nome || 'Desconhecido';
                
                const conversionType = r.conversionType || 'N/D';
                const conversionCount = r.conversionCount || 0;

                html += `
                    <li class="p-3 border rounded-lg bg-gray-700">
                        <p class="font-bold text-lg text-novan-primary">${clientName} (${r.plataforma})</p>
                        <p>Gasto: <span class="font-semibold">${formatCurrency(r.investimento)}</span></p>
                        <p>Vendas/Faturamento: <span class="font-semibold">${formatCurrency(r.vendas)}</span></p>
                        <p>CPM: <span class="font-bold text-blue-500">${formatCurrency(r.cpm)}</span></p>
                        <p>Convers√µes (${conversionType}): <span class="font-semibold">${conversionCount.toLocaleString('pt-BR')}</span></p>
                        <p>CPA: <span class="font-bold text-red-500">${formatCurrency(r.cpa)}</span> | ROAS: <span class="font-bold text-green-500">${formatNumber(r.roas)}</span></p>
                        <p class="text-xs text-gray-400 mt-1">Obs: ${r.observacoes || 'N/A'}</p>
                    </li>
                `;
            });
            html += '</ul>';

            const todayDateString = getLocalDayDate(today).toLocaleDateString('pt-BR');
            openSummaryModal('Resumo Di√°rio - ' + todayDateString, html);
        });

        /** Gera resumo quinzenal */
        document.getElementById('btnResumoQuinzenal').addEventListener('click', () => {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            
            const date15DaysAgo = new Date(today);
            date15DaysAgo.setDate(today.getDate() - 15); 
            const date15DaysAgoString = date15DaysAgo.toISOString().split('T')[0];

            const date30DaysAgo = new Date(today);
            date30DaysAgo.setDate(today.getDate() - 30); 
            const date30DaysAgoString = date30DaysAgo.toISOString().split('T')[0];

            // Este Per√≠odo (√öltimos 15 dias, incluindo hoje)
            const thisPeriod = results.filter(r => r.data >= date15DaysAgoString && r.data <= todayString);
            // Per√≠odo Anterior (16 a 30 dias atr√°s)
            const lastPeriod = results.filter(r => r.data >= date30DaysAgoString && r.data < date15DaysAgoString);
            
            const summarize = (data) => {
                return data.reduce((acc, r) => {
                    const clientId = r.clientId;
                    if (!acc[clientId]) {
                        acc[clientId] = { investimento: 0, vendas: 0, totalConversions: 0, impressoes: 0, roasSum: 0, roasCount: 0, cpmSum: 0, cpmCount: 0, count: 0 };
                    }
                    acc[clientId].investimento += r.investimento;
                    acc[clientId].vendas += r.vendas;
                    acc[clientId].totalConversions += r.conversionCount || 0; 
                    acc[clientId].impressoes += r.impressoes; 
                    acc[clientId].roasSum += r.roas;
                    acc[clientId].roasCount += r.roas > 0 ? 1 : 0;
                    acc[clientId].cpmSum += r.cpm; 
                    acc[clientId].cpmCount += r.cpm > 0 ? 1 : 0; 
                    acc[clientId].count += 1;
                    return acc;
                }, {});
            };

            const summaryThis = summarize(thisPeriod);
            const summaryLast = summarize(lastPeriod);
            
            let html = '<div class="space-y-4">';

            if (Object.keys(summaryThis).length === 0) {
                 html = '<p>Nenhum dado encontrado nos √∫ltimos 15 dias.</p>';
            } else {
                Object.keys(summaryThis).forEach(clientId => {
                    const clientName = clients.find(c => c.id === clientId)?.nome || 'Desconhecido';
                    const sThis = summaryThis[clientId];
                    const sLast = summaryLast[clientId] || { investimento: 0, vendas: 0, totalConversions: 0, impressoes: 0, roasSum: 0, roasCount: 0, cpmSum: 0, cpmCount: 0 };
                    
                    const roasThis = sThis.roasCount > 0 ? sThis.roasSum / sThis.roasCount : 0;
                    const roasLast = sLast.roasCount > 0 ? sLast.roasSum / sLast.roasCount : 0;
                    
                    const cpmAvgThis = sThis.cpmCount > 0 ? sThis.cpmSum / sThis.cpmCount : 0; 
                    const cpmAvgLast = sLast.cpmCount > 0 ? sLast.cpmSum / sLast.cpmCount : 0; 
                    
                    const percentChange = (current, previous) => previous === 0 ? (current > 0 ? '+‚àû' : '0%') : ((current - previous) / previous * 100).toFixed(1) + '%';
                    
                    html += `
                        <div class="bg-gray-700 p-4 rounded-lg shadow border-l-4 border-novan-primary">
                            <h4 class="font-bold text-xl mb-2 text-white">${clientName}</h4>
                            <p><strong>Per√≠odo Atual (15 dias):</strong></p>
                            <ul class="ml-4 list-disc text-sm">
                                <li>Gasto: ${formatCurrency(sThis.investimento)} 
                                    <span class="text-xs ${parseFloat(percentChange(sThis.investimento, sLast.investimento)) > 0 ? 'text-red-500' : 'text-green-500'}">(${percentChange(sThis.investimento, sLast.investimento)})</span>
                                </li>
                                <li>Faturamento: ${formatCurrency(sThis.vendas)} 
                                    <span class="text-xs ${parseFloat(percentChange(sThis.vendas, sLast.vendas)) > 0 ? 'text-green-500' : 'text-red-500'}">(${percentChange(sThis.vendas, sLast.vendas)})</span>
                                </li>
                                <li>ROAS M√©dio: ${formatNumber(roasThis)}X 
                                    <span class="text-xs ${parseFloat(percentChange(roasThis, roasLast)) > 0 ? 'text-green-500' : 'text-red-500'}">(${percentChange(roasThis, roasLast)})</span>
                                </li>
                                <li>CPM M√©dio: ${formatCurrency(cpmAvgThis)} 
                                    <span class="text-xs ${parseFloat(percentChange(cpmAvgThis, cpmAvgLast)) > 0 ? 'text-red-500' : 'text-green-500'}">(${percentChange(cpmAvgThis, cpmAvgLast)})</span>
                                </li>
                                <li>Convers√µes (Total): ${sThis.totalConversions}</li>
                            </ul>
                            <p class="text-xs text-gray-400 mt-2">Comparativo com os 15 dias anteriores.</p>
                        </div>
                    `;
                });
            }

            html += '</div>';

            openSummaryModal('Resumo Quinzenal (√öltimos 15 Dias)', html);
        });

        /** Abre o modal de resumo */
        function openSummaryModal(title, content) {
            document.getElementById('summaryTitle').textContent = title;
            document.getElementById('summaryContent').innerHTML = content;
            document.getElementById('summaryModal').classList.remove('hidden');
            document.getElementById('summaryModal').classList.add('flex');
        }


        // --- ABA 2: CALEND√ÅRIO DE TAREFAS ---
        
        /** Exibe um resumo de todas as tarefas para um dia espec√≠fico ao clicar no dia do calend√°rio. */
        window.showDaySummary = function(dateString) {
            const dateObj = getLocalDayDate(dateString); // Usando a nova fun√ß√£o para evitar erros de timezone
            
            // Filtra o array local 'tasks'
            const dayTasks = tasks.filter(t => t.date.startsWith(dateString)); 

            const title = `Resumo de Tarefas: ${dateObj.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' })}`;

            if (dayTasks.length === 0) {
                const content = `<p class="text-center text-gray-400">Nenhuma tarefa agendada para este dia.</p>`;
                return openSummaryModal(title, content);
            }

            let contentHtml = '<div class="space-y-3">';
            dayTasks.forEach(task => {
                const client = clients.find(c => c.id === task.clientId);
                const clientName = client?.nome || 'Cliente N/D';
                const taskTime = new Date(task.date).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                const statusColor = task.status === 'Concluido' ? 'text-green-500' : 
                                    task.status === 'Em Andamento' ? 'text-yellow-500' : 'text-red-500';
                
                contentHtml += `
                    <div class="p-3 border rounded-lg shadow-sm bg-gray-700">
                        <p class="font-bold text-white">${clientName} - ${task.type}</p>
                        <p class="text-sm font-semibold">${taskTime} <span class="${statusColor}">(${task.status})</span></p>
                        <p class="text-xs text-gray-400 italic mt-1">Obs: ${task.observacoes || 'Sem observa√ß√µes.'}</p>
                    </div>
                `;
            });
            contentHtml += '</div>';

            openSummaryModal(title, contentHtml);
        }

        /** Renderiza o calend√°rio (M√™s Atual) */
        window.renderCalendar = function() {
            const grid = document.getElementById('calendarGrid');
            const filterClientId = document.getElementById('filterClient').value; // Lendo o filtro

            grid.innerHTML = '';
            
            document.getElementById('currentMonthYear').textContent = currentMonth.toLocaleDateString('pt-BR', { year: 'numeric', month: 'long' });

            const today = new Date();
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const startingDay = firstDayOfMonth.getDay(); // 0 (Dom) a 6 (S√°b)

            // Preencher dias vazios no in√≠cio
            for (let i = 0; i < startingDay; i++) {
                grid.innerHTML += '<div class="calendar-day p-2 text-gray-600"></div>'; // Mantido cinza escuro para os dias fora do m√™s
            }

            // Renderizar dias do m√™s
            for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                const isToday = date.toDateString() === today.toDateString();
                
                // 1. FILTRAGEM PR√âVIA DAS TAREFAS
                const dayTasks = tasks.filter(t => {
                    const dateMatch = t.date.startsWith(dateString);
                    const clientMatch = !filterClientId || t.clientId === filterClientId; 
                    const monthMatch = new Date(t.date).getMonth() === month;

                    return dateMatch && clientMatch && monthMatch;
                });
                
                let tasksHtml = '';
                dayTasks.forEach(task => {
                    const client = clients.find(c => c.id === task.clientId);
                    const clientColor = client?.color || '#334155'; // Cor padr√£o
                    const clientName = client?.nome.substring(0, 10) || 'N/D';
                    
                    let statusClass = '';
                    if (task.status === 'Pendente') statusClass = 'bg-status-Pendente';
                    else if (task.status === 'Em Andamento') statusClass = 'bg-status-Em_Andamento';
                    else if (task.status === 'Concluido') statusClass = 'bg-status-Concluido';
                    
                    const taskDateTime = new Date(task.date).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                    const taskTitle = `CLIENTE: ${clientName}\nDATA/HORA: ${taskDateTime}\nTIPO: ${task.type}\nSTATUS: ${task.status}\nOBS: ${task.observacoes || 'N/A'}`;

                    tasksHtml += `
                        <div class="task-item text-white shadow-sm px-1 py-0.5 rounded-lg text-xs truncate ${statusClass}" 
                             style="border-left-color: ${clientColor};"
                             title="${taskTitle}">
                            ${clientName} - ${task.type.substring(0, 5)}
                        </div>
                    `;
                });

                grid.innerHTML += `
                    <div class="calendar-day p-2 rounded-lg ${isToday ? 'bg-novan-primary text-white shadow-lg' : 'hover:bg-slate-700'}" onclick="showDaySummary('${dateString}')">
                        <div class="font-bold mb-1 ${isToday ? 'text-white' : 'text-gray-300'}">${day}</div>
                        ${tasksHtml}
                    </div>
                `;
            }
        }

        /** Manipuladores de navega√ß√£o do calend√°rio */
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        });

        /** L√≥gica de submiss√£o do formul√°rio de tarefas */
        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) return showMessage('Erro de autentica√ß√£o. Recarregue a p√°gina.', 3000, true);

            const newTask = {
                clientId: document.getElementById('task_cliente').value,
                type: document.getElementById('task_tipo').value,
                date: document.getElementById('task_data').value, // Formato YYYY-MM-DDTHH:MM
                status: document.getElementById('task_status').value,
                observacoes: document.getElementById('task_observacoes').value,
                completionDate: null, // Novo campo
            };

            try {
                await addDoc(tasksCollection, newTask);
                document.getElementById('taskForm').reset();
                showMessage('Tarefa agendada com sucesso!');
                // onSnapshot atualizar√° a UI
            } catch (error) {
                console.error("Erro ao salvar tarefa:", error);
                showMessage(`Erro ao salvar tarefa: ${error.message}`, 5000, true);
            }
        });
        
        /** Renderiza as notifica√ß√µes de tarefas pr√≥ximas (pr√≥ximos 7 dias) */
        function renderTaskNotifications() {
            const notificationBox = document.getElementById('taskNotifications');
            const list = document.getElementById('notificationList');
            list.innerHTML = '';
            
            const now = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(now.getDate() + 7);

            const upcomingTasks = tasks.filter(t => {
                const taskDate = new Date(t.date);
                return taskDate >= now && taskDate <= nextWeek && t.status !== 'Concluido';
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            if (upcomingTasks.length === 0) {
                notificationBox.classList.add('hidden');
                return;
            }

            notificationBox.classList.remove('hidden');

            upcomingTasks.forEach(task => {
                const clientName = clients.find(c => c.id === task.clientId)?.nome || 'N/D';
                const taskDate = new Date(task.date);
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="font-semibold">${clientName}</span>: ${task.type} 
                    em ${taskDate.toLocaleDateString('pt-BR')} √†s ${taskDate.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})} 
                    <span class="text-xs text-gray-400">(${task.status})</span>
                `;
                list.appendChild(li);
            });
        }

        // --- ABA 5: GEST√ÉO DE TAREFAS (KANBAN) ---

        /** Abre o Modal de Confirma√ß√£o de Conclus√£o */
        window.openCompletionModal = function(taskId) {
            window.taskIdToConfirm = taskId;
            
            // Limpa o estado do modal
            document.getElementById('checkCompleted').checked = false;
            document.getElementById('checkDriveUpload').checked = false;
            document.getElementById('completionWarning').classList.add('hidden');
            
            // Exibe o modal
            document.getElementById('completionConfirmModal').classList.remove('hidden');
            document.getElementById('completionConfirmModal').classList.add('flex');
        }
        
        /** Fecha o Modal de Confirma√ß√£o de Conclus√£o */
        window.closeCompletionModal = function() {
            window.taskIdToConfirm = null;
            document.getElementById('completionConfirmModal').classList.remove('flex');
            document.getElementById('completionConfirmModal').classList.add('hidden');
            
            // Re-renderiza o Kanban para garantir que o dropdown volte ao estado original
            renderTaskManagement();
        }
        
        /** Lida com o clique no bot√£o "Concluir e Salvar" do modal */
        document.getElementById('confirmCompletionBtn').addEventListener('click', () => {
            const isCompleted = document.getElementById('checkCompleted').checked;
            const isUploaded = document.getElementById('checkDriveUpload').checked;
            
            if (isCompleted && isUploaded) {
                // Se ambas as caixas estiverem marcadas, atualiza o status
                updateTaskStatus(window.taskIdToConfirm, 'Concluido', true); // O 'true' for√ßa a conclus√£o
                closeCompletionModal();
            } else {
                // Caso contr√°rio, mostra o aviso
                document.getElementById('completionWarning').classList.remove('hidden');
            }
        });

        /** Atualiza o status de uma tarefa e salva/renderiza - FIRESTORE */
        window.updateTaskStatus = async function(taskId, newStatus, bypassCheck = false) {
            if (!userId) return showMessage('Erro de autentica√ß√£o. Recarregue a p√°gina.', 3000, true);
            
            // 1. Intercepta a mudan√ßa para "Conclu√≠do"
            if (newStatus === 'Concluido' && !bypassCheck) {
                openCompletionModal(taskId);
                return; // Impede a atualiza√ß√£o direta
            }
            
            // 2. Procede com a atualiza√ß√£o
            const docRef = doc(db, 'users', userId, 'tasks', taskId);
            let completionDate = null;
            
            if (newStatus === 'Concluido') {
                completionDate = new Date().toISOString();
            }
            
            try {
                await updateDoc(docRef, {
                    status: newStatus,
                    completionDate: completionDate
                });
                showMessage(`Status da tarefa atualizado para: ${newStatus}`);
                // onSnapshot atualizar√° a UI
            } catch (error) {
                console.error("Erro ao atualizar status:", error);
                showMessage(`Erro ao atualizar status: ${error.message}`, 5000, true);
                renderTaskManagement(); // Reverte a UI em caso de erro
            }
        }


        /** Renderiza o painel de gest√£o de tarefas (Kanban-like) (Chamado pelo onSnapshot) */
        window.renderTaskManagement = function() {
            const boardEl = document.getElementById('taskManagementBoard');
            const noTasksMessageEl = document.getElementById('noTasksMessage');
            
            if (!boardEl || !noTasksMessageEl) return;

            boardEl.innerHTML = '';
            
            const filterClientId = document.getElementById('task_manager_filter_client').value;
            const filterStatus = document.getElementById('task_manager_filter_status').value;

            let filteredTasks = tasks.filter(t => {
                const clientMatch = !filterClientId || t.clientId === filterClientId;
                const statusMatch = !filterStatus || t.status === filterStatus;
                return clientMatch && statusMatch;
            }).sort((a, b) => new Date(a.date) - new Date(b.date)); // Ordena por data

            if (filteredTasks.length === 0) {
                noTasksMessageEl.classList.remove('hidden');
                return;
            }
            noTasksMessageEl.classList.add('hidden');


            const statusGroups = {
                'Pendente': [],
                'Em Andamento': [],
                'Concluido': []
            };
            
            // Reagrupar tarefas
            filteredTasks.forEach(task => {
                if (statusGroups[task.status]) {
                    statusGroups[task.status].push(task);
                }
            });

            const allStatuses = ['Pendente', 'Em Andamento', 'Concluido'];
            const statusesToShow = filterStatus ? [filterStatus] : allStatuses;
            
            const statusColors = {
                'Pendente': { bg: 'bg-red-900/50', text: 'text-red-300', border: 'border-red-500' }, 
                'Em Andamento': { bg: 'bg-yellow-900/50', text: 'text-yellow-300', border: 'border-yellow-500' },
                'Concluido': { bg: 'bg-green-900/50', text: 'text-green-300', border: 'border-green-500' } 
            };

            statusesToShow.forEach(status => {
                const tasksInGroup = statusGroups[status] || [];
                const { bg, text, border } = statusColors[status];
                
                let taskCardsHtml = tasksInGroup.map(task => {
                    const client = clients.find(c => c.id === task.clientId);
                    const clientName = client?.nome || 'Cliente N/D';
                    const taskDateTime = new Date(task.date).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
                    const taskNotes = task.observacoes || 'N/A';

                    // Op√ß√µes de status (inclui o status atual como selecionado)
                    const statusOptions = allStatuses
                        .map(s => `<option value="${s}" ${s === status ? 'selected' : ''}>${s}</option>`)
                        .join('');
                    
                    // Exibir data de conclus√£o
                    let completionInfo = '';
                    if (task.status === 'Concluido' && task.completionDate) {
                        const completeDate = new Date(task.completionDate).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
                        completionInfo = `<p class="text-xs text-green-500 font-medium mt-1">Conclu√≠da em: ${completeDate}</p>`;
                    }

                    // Se o novo valor for 'Conclu√≠do', ele aciona o modal.
                    const onChangeHandler = `
                        if (this.value === 'Concluido') {
                            openCompletionModal('${task.id}');
                            this.value = '${task.status}'; // Mant√©m o valor atual temporariamente
                        } else {
                            updateTaskStatus('${task.id}', this.value, true);
                        }
                    `;

                    return `
                        <div class="bg-gray-700 p-4 rounded-lg shadow-md border-t-2 ${border} space-y-2 text-gray-300" title="Observa√ß√µes: ${taskNotes.replace(/"/g, '')}">
                            <p class="font-semibold text-sm text-white">${clientName} - ${task.type}</p>
                            <p class="text-xs text-gray-400">Prazo: ${taskDateTime}</p>
                            <p class="text-xs italic text-gray-400 overflow-hidden text-ellipsis whitespace-nowrap">
                                Obs: ${taskNotes}
                            </p>
                            ${completionInfo}
                            <div class="flex items-center space-x-2 pt-2">
                                <label class="text-xs font-medium text-gray-400">Mudar Status:</label>
                                <select onchange="${onChangeHandler}" class="p-1 border text-xs rounded-lg bg-gray-600 text-white focus:ring-novan-primary">
                                    ${statusOptions}
                                </select>
                                <button onclick="deleteTask('${task.id}')" class="text-red-500 hover:text-red-400 text-xs">Excluir</button>
                            </div>
                        </div>
                    `;
                }).join('');

                const column = document.createElement('div');
                column.className = `${bg} p-4 rounded-xl shadow-inner border-t-4 ${border}`;
                column.innerHTML = `
                    <h3 class="text-xl font-bold mb-4 ${text}">${status} (${tasksInGroup.length})</h3>
                    <div class="space-y-4 min-h-[50px]">
                        ${taskCardsHtml || `<p class="text-center text-sm italic ${text}">Nenhuma tarefa neste status.</p>`}
                    </div>
                `;
                boardEl.appendChild(column);
            });
        }
        
        /** Deleta uma tarefa espec√≠fica (Adicionado para completar a funcionalidade do Kanban) - FIRESTORE */
        window.deleteTask = async function(taskId) {
            if (!userId) return showMessage('Erro de autentica√ß√£o. Recarregue a p√°gina.', 3000, true);
            const docRef = doc(db, 'users', userId, 'tasks', taskId);
            await deleteDoc(docRef);
            showMessage('Tarefa exclu√≠da.', 3000, true);
            // onSnapshot atualizar√° a UI
        }

        // --- ABA 4: RELAT√ìRIOS E INSIGHTS (Chart.js) ---

        /** Inicializa um Chart.js (destr√≥i o anterior se existir) */
        function initChart(chartId, type, data, options) {
            const canvas = document.getElementById(chartId);
            // Destr√≥i a inst√¢ncia anterior se existir
            const existingChart = Chart.getChart(chartId);
            if (existingChart) {
                existingChart.destroy();
            }
            return new Chart(canvas, { type, data, options });
        }

        /** Renderiza os KPI Cards do Relat√≥rio (Separado para reuso) */
        function renderReportKpiCards(summary) {
            // Reuso da fun√ß√£o principal de KPI cards, mas usando o ID espec√≠fico para os Relat√≥rios
            renderKpiCards(summary.reportData || [], summary, 'reportKpiCardsContainer');
        }

        /** Gera os dados e gr√°ficos do relat√≥rio */
        window.generateReport = function() {
            const clientId = document.getElementById('report_cliente').value;
            const startDate = document.getElementById('report_start_date').value;
            const endDate = document.getElementById('report_end_date').value;

            // Filtra os resultados (do array local 'results', atualizado pelo onSnapshot)
            let filteredResults = results;
            if (clientId) {
                filteredResults = filteredResults.filter(r => r.clientId === clientId);
            }
            if (startDate) {
                filteredResults = filteredResults.filter(r => r.data >= startDate);
            }
            if (endDate) {
                filteredResults = filteredResults.filter(r => r.data <= endDate);
            }
            
            if (filteredResults.length === 0) {
                document.getElementById('noReportData').classList.remove('hidden');
                document.getElementById('chartsContainer').querySelectorAll('canvas').forEach(c => c.style.display = 'none');
                reportSummaryMetrics = null; 
                reportDetailedResults = [];
                // Renderiza KPIs zerados
                renderReportKpiCards({ reportData: [] }); 
                return showMessage('Nenhum dado encontrado para os filtros selecionados.', true);
            }

            document.getElementById('noReportData').classList.add('hidden');
            document.getElementById('chartsContainer').querySelectorAll('canvas').forEach(c => c.style.display = 'block');
            
            const groupedData = filteredResults.reduce((acc, r) => {
                if (!acc[r.data]) {
                    acc[r.data] = { investimento: 0, faturamento: 0, impressoes: 0, cliques: 0, roasSum: 0, roasCount: 0, conversionCount: 0 }; 
                }
                acc[r.data].investimento += r.investimento;
                acc[r.data].faturamento += r.vendas;
                acc[r.data].impressoes += r.impressoes;
                acc[r.data].cliques += r.cliques;
                acc[r.data].roasSum += r.roas;
                acc[r.data].roasCount += r.roas > 0 ? 1 : 0;
                acc[r.data].conversionCount += r.conversionCount;
                return acc;
            }, {});

            const sortedDates = Object.keys(groupedData).sort();
            reportDetailedResults = filteredResults.sort((a, b) => new Date(a.data) - new Date(b.data));
            const reportLabels = sortedDates.map(d => getLocalDayDate(d).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
            const invData = sortedDates.map(d => groupedData[d].investimento);
            const fatData = sortedDates.map(d => groupedData[d].faturamento);
            const imprData = sortedDates.map(d => groupedData[d].impressoes);
            const cliquesData = sortedDates.map(d => groupedData[d].cliques);
            const roasData = sortedDates.map(d => groupedData[d].roasCount > 0 ? groupedData[d].roasSum / groupedData[d].roasCount : 0);
            
            const totalGasto = filteredResults.reduce((sum, r) => sum + r.investimento, 0);
            const totalFaturamento = filteredResults.reduce((sum, r) => sum + r.vendas, 0);
            const totalConversoes = filteredResults.reduce((sum, r) => sum + (r.conversionCount || 0), 0);
            const totalImpressoes = filteredResults.reduce((sum, r) => sum + r.impressoes, 0);
            
            const avgROAS = calculateROAS(totalGasto, totalFaturamento);
            const avgCPA = calculateCPA(totalGasto, totalConversoes);
            const avgCPM = calculateCPM(totalGasto, totalImpressoes);
            
            const clientNameForReport = clientId 
                ? clients.find(c => c.id === clientId)?.nome || 'Cliente Desconhecido'
                : 'Todos os Clientes'; 

            reportSummaryMetrics = {
                totalGasto: totalGasto,
                totalFaturamento: totalFaturamento,
                avgROAS: avgROAS,
                avgCPA: avgCPA,
                avgCPM: avgCPM,
                totalConversoes: totalConversoes,
                clientName: clientNameForReport,
                period: reportLabels.length > 0 ? `${reportLabels[0]} a ${reportLabels[reportLabels.length - 1]}` : 'N/A',
                generationDate: new Date().toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' })
            };
            
            // Renderiza KPIs
            renderReportKpiCards(reportSummaryMetrics); 

            setTimeout(() => {
                
                const barChartOptions = {
                    responsive: true,
                    maintainAspectRatio: false, 
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: '#334155' }, 
                            ticks: { color: '#E2E8F0' } 
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#E2E8F0' } 
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#E2E8F0' } } 
                    },
                    datasets: { 
                        bar: {
                            categoryPercentage: 0.6,
                            barPercentage: 0.8
                        }
                    }
                };
                
                invFatChartInstance = initChart('investimentoFaturamentoChart', 'bar', {
                    labels: reportLabels,
                    datasets: [
                        { label: 'Gasto (R$)', data: invData, backgroundColor: COLORS.investimento, yAxisID: 'y' },
                        { label: 'Faturamento (R$)', data: fatData, backgroundColor: COLORS.faturamento, yAxisID: 'y' }
                    ]
                }, barChartOptions);

                imprCliquesChartInstance = initChart('impressoesCliquesChart', 'bar', { 
                    labels: reportLabels,
                    datasets: [
                        { label: 'Impress√µes', data: imprData, backgroundColor: COLORS.impressoes },
                        { label: 'Cliques', data: cliquesData, backgroundColor: COLORS.cliques }
                    ]
                }, barChartOptions);

                roasChartInstance = initChart('roasChart', 'bar', { 
                    labels: reportLabels,
                    datasets: [
                        { label: 'ROAS M√©dio', data: roasData, backgroundColor: COLORS.roas }
                    ]
                }, barChartOptions);

                showMessage('Relat√≥rio gerado com sucesso!');
                
            }, 50); 
        }

        /** Exporta os dados brutos como CSV */
        window.exportReportAsCSV = function() { 
            if (results.length === 0) {
                return showMessage('Nenhum dado de resultado para exportar.', true);
            }
            
            const csvData = results.map(r => {
                const clientName = clients.find(c => c.id === r.clientId)?.nome || 'Desconhecido';
                const conversionType = r.conversionType || 'N/D';
                const conversionCount = r.conversionCount || 0;
                const cpm = r.cpm || 0;

                return [
                    r.data, clientName, r.plataforma, r.investimento, r.impressoes, r.alcance, r.cliques, cpm, conversionType, conversionCount, r.vendas, r.cpa, r.roas, r.observacoes
                ].join(';');
            }).join('\n');
            
            const csvHeader = 'Data;Cliente;Plataforma;Gasto (R$);Impress√µes;Alcance;Cliques;CPM (R$);Tipo Convers√£o;Total Convers√µes;Vendas (R$);CPA (R$);ROAS (X);Observa√ß√µes\n';
            const fullCsv = csvHeader + csvData;
            
            const blob = new Blob([fullCsv], { type: 'text/csv;charset=utf-utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'Novan_Relatorio_Trafego.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('Exporta√ß√£o de dados para Planilha (CSV) iniciada.');
        }

        /** Exporta o Relat√≥rio Consolidado (TEXTO) como PNG */
        window.exportCombinedReportAsPNG = async function() { 
            try {
                if (!reportSummaryMetrics || reportDetailedResults.length === 0) {
                    return showMessage('Gere o relat√≥rio primeiro antes de exportar o PNG.', 5000, true);
                }
                
                const reportData = reportDetailedResults;
                
                const headerHeight = 280; 
                const margin = 20; 
                const dataRowHeight = 28; 
                const maxRows = Math.floor((1350 - headerHeight - (margin * 2)) / dataRowHeight) - 2; 

                const rowsToShow = reportData.slice(0, maxRows); 
                const totalDataHeight = rowsToShow.length * dataRowHeight;
                
                const totalHeight = headerHeight + totalDataHeight + margin * 3; 
                const totalWidth = 1080; 

                const compositeCanvas = document.createElement('canvas');
                compositeCanvas.width = totalWidth;
                compositeCanvas.height = totalHeight;
                const ctx = compositeCanvas.getContext('2d');
                
                ctx.font = 'Poppins, sans-serif'; 
                
                ctx.fillStyle = NAVY_BLUE; 
                ctx.fillRect(0, 0, totalWidth, totalHeight);
                
                ctx.font = '700 36px Poppins, sans-serif'; 
                ctx.fillStyle = COLORS.faturamento; 
                ctx.fillText('RELAT√ìRIO NOVAN AGENCY', margin, margin + 40); 
                
                ctx.font = '400 16px Poppins, sans-serif'; 
                ctx.fillStyle = LIGHT_TEXT;
                ctx.fillText(`Gerado em: ${reportSummaryMetrics.generationDate}`, margin, margin + 70); 

                ctx.font = '600 24px Poppins, sans-serif'; 
                ctx.fillStyle = LIGHT_TEXT;
                const clientDisplay = reportSummaryMetrics.clientName === 'Todos os Clientes' 
                    ? reportSummaryMetrics.clientName 
                    : `CLIENTE: ${reportSummaryMetrics.clientName}`;
                ctx.fillText(clientDisplay, margin, margin + 110); 
                
                ctx.font = '400 18px Poppins, sans-serif'; 
                ctx.fillStyle = LIGHT_TEXT;
                ctx.fillText(`Per√≠odo Analisado: ${reportSummaryMetrics.period}`, margin, margin + 140); 

                // Bloco de M√©tricas Chave (M√©tricas Totais) - ATUALIZADO
                let metricY = margin + 180; 
                ctx.font = '700 22px Poppins, sans-serif'; 
                const metricXSpacing = 350; 
                const metricYSpacing = 40; 

                // LINHA 1: GASTO e FATURAMENTO
                ctx.fillStyle = COLORS.investimento;
                ctx.fillText(`GASTO: R$ ${formatValueBRL(reportSummaryMetrics.totalGasto)}`, margin, metricY);
                
                ctx.fillStyle = COLORS.faturamento;
                ctx.fillText(`FATURAMENTO: R$ ${formatValueBRL(reportSummaryMetrics.totalFaturamento)}`, margin + metricXSpacing, metricY);
                
                metricY += metricYSpacing; 
                ctx.font = '700 22px Poppins, sans-serif'; 
                
                // LINHA 2: ROAS e CPA
                ctx.fillStyle = COLORS.roas;
                ctx.fillText(`ROAS: ${formatNumber(reportSummaryMetrics.avgROAS)}X`, margin, metricY);
                
                ctx.fillStyle = COLORS.cpa; 
                ctx.fillText(`CPA: R$ ${formatValueBRL(reportSummaryMetrics.avgCPA)}`, margin + metricXSpacing, metricY);

                metricY += metricYSpacing; 
                ctx.font = '700 22px Poppins, sans-serif'; 

                // LINHA 3: CPM e CONVERS√ïES (total)
                ctx.fillStyle = COLORS.impressoes;
                ctx.fillText(`CPM: R$ ${formatValueBRL(reportSummaryMetrics.avgCPM)}`, margin, metricY);
                
                ctx.fillStyle = COLORS.primary; 
                ctx.fillText(`CONVERS√ïES: ${reportSummaryMetrics.totalConversoes.toLocaleString('pt-BR')}`, margin + metricXSpacing, metricY);


                // --- 3. Desenha os Detalhes Di√°rios (Tabela de Texto) ---

                let currentY = headerHeight + margin; 
                
                ctx.font = '700 18px Poppins, sans-serif';
                ctx.fillStyle = LIGHT_TEXT;
                ctx.fillText('DETALHE DE PERFORMANCE DI√ÅRIA:', margin, currentY);
                currentY += margin;
                
                ctx.font = '600 15px Poppins, sans-serif'; 
                ctx.fillStyle = COLORS.primary; 
                const colDataCliente = 20;
                const colGasto = 260; 
                const colFaturamento = 400; 
                const colCPM = 550; 
                const colROAS = 680; 
                const colConv = 800; 
                
                ctx.fillText('DATA | CLIENTE', colDataCliente, currentY);
                ctx.fillText('GASTO (R$)', colGasto, currentY);
                ctx.fillText('FATO. (R$)', colFaturamento, currentY);
                ctx.fillText('CPM (R$)', colCPM, currentY);
                ctx.fillText('ROAS (X)', colROAS, currentY);
                ctx.fillText('CONVERS√ïES', colConv, currentY);
                currentY += 8; 

                // Desenho das Linhas de Dados
                rowsToShow.forEach(row => {
                    currentY += dataRowHeight - 5; 
                    
                    const cpa = calculateCPA(row.investimento, row.conversionCount); 
                    const roas = calculateROAS(row.investimento, row.vendas);
                    const cpm = calculateCPM(row.investimento, row.impressoes);

                    ctx.font = '400 14px Poppins, sans-serif'; 
                    
                    const clientName = clients.find(c => c.id === row.clientId)?.nome || 'N/D';
                    const dateDisplay = getLocalDayDate(row.data).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    ctx.fillStyle = LIGHT_TEXT;
                    ctx.fillText(`${dateDisplay} | ${clientName.substring(0, 10)}`, colDataCliente, currentY);
                    
                    ctx.fillStyle = COLORS.investimento; 
                    ctx.fillText(formatValueBRL(row.investimento), colGasto, currentY);
                    
                    ctx.fillStyle = COLORS.faturamento; 
                    ctx.fillText(formatValueBRL(row.vendas), colFaturamento, currentY);
                    
                    ctx.fillStyle = COLORS.impressoes; 
                    ctx.fillText(formatValueBRL(cpm), colCPM, currentY);
                    
                    ctx.fillStyle = COLORS.roas; 
                    ctx.fillText(`${formatNumber(roas)}X`, colROAS, currentY);
                    
                    ctx.fillStyle = LIGHT_TEXT;
                    ctx.fillText(`${row.conversionType.substring(0, 5)}. (${row.conversionCount})`, colConv, currentY);
                });

                if (reportData.length > maxRows) {
                    currentY += dataRowHeight;
                    ctx.fillStyle = LIGHT_TEXT;
                    ctx.font = '400 14px Poppins, sans-serif';
                    ctx.fillText(`... e mais ${reportData.length - maxRows} registros. Use o CSV para o detalhe completo.`, margin, currentY);
                }

                // CORRE√á√ÉO: Adicionado atraso para o download funcionar
                setTimeout(() => {
                    const dataUrl = compositeCanvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = `Novan_Relatorio_Feed_${reportSummaryMetrics.period.replace(/\s/g, '_').replace(/\//g, '-')}.png`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showMessage('Exporta√ß√£o do Relat√≥rio Consolidado (PNG) iniciada!');
                }, 100); // Atraso de 100ms

            } catch (error) {
                console.error("Erro fatal ao gerar PNG:", error);
                showMessage("Erro ao gerar o relat√≥rio PNG. Verifique o console para mais detalhes.", 5000, true);
            }
        }


        // --- FUN√á√ÉO PARA ANIMA√á√ÉO CODE RAIN (MATRIX) ---
        
        /** Inicializa o Efeito Code Rain (Matrix) */
        window.initMatrixEffect = function() {
            const canvas = document.getElementById('matrixCanvas');
            // Verifica se o elemento foi encontrado antes de prosseguir
            if (!canvas) return; 
            
            const ctx = canvas.getContext('2d');
            let width = canvas.width = window.innerWidth;
            let height = canvas.height = window.innerHeight;
            const fontSize = 16;
            const columns = Math.floor(width / fontSize);
            
            const drops = [];
            for(let i = 0; i < columns; i++) {
                drops[i] = 1;
            }
            
            // Caracteres para o efeito bin√°rio/digital
            const characters = '01'; 
            
            const draw = () => {
                // Fundo com opacidade baixa para o efeito de rastro
                ctx.fillStyle = 'rgba(14, 27, 49, 0.05)'; // Azul Marinho com opacidade
                ctx.fillRect(0, 0, width, height);
                
                ctx.font = `${fontSize}px monospace`;
                ctx.fillStyle = '#6D28D9'; // Cor Roxo Principal
                
                for(let i = 0; i < drops.length; i++) {
                    const text = characters.charAt(Math.floor(Math.random() * characters.length));
                    const x = i * fontSize;
                    const y = drops[i] * fontSize;
                    
                    ctx.fillText(text, x, y);
                    
                    // Re-inicia a gota se sair da tela (com chance de 97.5% de resetar)
                    if(y * fontSize > height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    
                    // Move a gota para baixo
                    drops[i]++;
                }
                requestAnimationFrame(draw);
            };

            const handleResize = () => {
                width = canvas.width = window.innerWidth;
                height = canvas.height = window.innerHeight;
            };

            window.addEventListener('resize', handleResize);
            // Inicia o loop de anima√ß√£o
            requestAnimationFrame(draw);
        }
        
        // Chamada da anima√ß√£o ap√≥s o DOM carregar
        document.addEventListener('DOMContentLoaded', initMatrixEffect);
        // --- FIM DA FUN√á√ÉO PARA ANIMA√á√ÉO CODE RAIN (MATRIX) ---


        // --- FUN√á√ïES LLM GEMINI ---

        /** Fun√ß√£o utilit√°ria para chamar a API Gemini */
        async function callGeminiApi(systemPrompt, userQuery) {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let attempts = 0;
            const maxRetries = 3;

            while (attempts < maxRetries) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        // Too Many Requests - Implementa Backoff Exponencial
                        const delay = Math.pow(2, attempts) * 1000;
                        console.warn(`Tentativa ${attempts + 1} falhou (429). Retentando em ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        attempts++;
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) {
                        console.error("Resposta Gemini vazia ou inesperada:", result);
                        return "Erro: O LLM n√£o retornou uma an√°lise v√°lida.";
                    }

                    return text;

                } catch (error) {
                    console.error("Erro na chamada da API Gemini:", error);
                    // Tenta novamente apenas para erros de rede/timeout, n√£o para erros 4xx/5xx diretos
                    if (attempts < maxRetries - 1) {
                        const delay = Math.pow(2, attempts) * 1000;
                        console.warn(`Tentativa ${attempts + 1} falhou. Retentando em ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        attempts++;
                    } else {
                        return "Erro: Falha na comunica√ß√£o com o LLM ap√≥s o limite de retentativas.";
                    }
                }
            }
            return "Erro: Falha na comunica√ß√£o com o LLM ap√≥s o limite de retentativas.";
        }

        /** Gera An√°lise de Performance usando o LLM (ABA RESULTADOS - Di√°rio) */
        window.generatePerformanceAnalysis = async function() {
            const today = document.getElementById('res_data').value;
            const dailyResults = results.filter(r => r.data === today);

            if (dailyResults.length === 0) {
                return showMessage('Nenhum registro encontrado para hoje para gerar a an√°lise.', 3000, true);
            }
            
            // Agrega√ß√£o dos dados para o LLM
            let summary = dailyResults.reduce((acc, r) => {
                acc.gasto += r.investimento;
                acc.vendas += r.vendas;
                acc.conversoes += r.conversionCount || 0;
                acc.impressoes += r.impressoes;
                
                // Adiciona observa√ß√µes e detalhes
                const clientName = clients.find(c => c.id === r.clientId)?.nome || 'Desconhecido';
                acc.detalhes.push({
                    cliente: clientName,
                    plataforma: r.plataforma,
                    investimento: r.investimento,
                    vendas: r.vendas,
                    cpa: calculateCPA(r.investimento, r.conversionCount),
                    roas: calculateROAS(r.investimento, r.vendas),
                    conversoes: r.conversionCount,
                    obs: r.observacoes
                });
                return acc;
            }, { gasto: 0, vendas: 0, conversoes: 0, impressoes: 0, detalhes: [] });

            const totalCPA = calculateCPA(summary.gasto, summary.conversoes);
            const totalROAS = calculateROAS(summary.gasto, summary.vendas);

            // Constr√≥i o prompt
            const systemPrompt = `Voc√™ √© um Analista de Tr√°fego S√™nior da Novan Agency. Sua tarefa √© fornecer uma an√°lise concisa, clara e orientada a a√ß√µes sobre o desempenho das campanhas di√°rias. Seu p√∫blico √© o gerente da ag√™ncia.
            Formate a sua resposta em dois par√°grafos:
            1. Resumo da Performance: Foco nas m√©tricas globais (GASTO, ROAS, CPA) e a tend√™ncia geral.
            2. A√ß√µes Recomendadas: Foco nas pr√≥ximas 2-3 a√ß√µes mais importantes ou anomalias encontradas nos detalhes.
            N√£o use formata√ß√£o Markdown (como ** ou cabe√ßalhos).`;

            const userQuery = `Analise a performance di√°ria de hoje (${new Date().toLocaleDateString('pt-BR')}) baseada nos seguintes dados agregados:
            - Gasto Total: ${formatCurrency(summary.gasto)}
            - Faturamento/Vendas Total: ${formatCurrency(summary.vendas)}
            - CPA Agregado: ${formatCurrency(totalCPA)}
            - ROAS Agregado: ${formatNumber(totalROAS)}X
            - Detalhes por Cliente (onde buscar anomalias): ${JSON.stringify(summary.detalhes.map(d => ({
                cliente: d.cliente,
                gasto: d.investimento,
                roas: formatNumber(d.roas),
                obs: d.obs.substring(0, 50)
            })))}`;

            // 1. Mostrar o modal de carregamento
            const loadingHtml = `<div class="spinner"></div><p class="text-gray-400 mt-4">A Gemini est√° a gerar a an√°lise...</p>`;
            openSummaryModal('‚ú® Gerando An√°lise de Desempenho', loadingHtml);

            // 2. Chamar a API
            const analysisText = await callGeminiApi(systemPrompt, userQuery);

            // 3. Formatar e exibir o resultado
            // Usando white-space: pre-wrap para respeitar quebras de linha do LLM.
            const finalHtml = `<div class="whitespace-pre-wrap text-base leading-relaxed">${analysisText}</div>`;
            openSummaryModal('‚ú® An√°lise de Desempenho Di√°rio', finalHtml);
        }

        /** Gera An√°lise Estrat√©gica comparando 7D, 15D, 30D usando o LLM (ABA RESULTADOS - Estrat√©gico) */
        window.generateStrategicAnalysis = async function() {
            const clientFilter = document.getElementById('results_filter_cliente').value;
            
            if (!clientFilter) {
                return showMessage('Selecione um cliente no filtro para realizar a An√°lise Estrat√©gica.', 5000, true);
            }
            
            const clientName = clients.find(c => c.id === clientFilter)?.nome || 'Cliente Desconhecido';
            
            // Fun√ß√£o auxiliar para calcular m√©tricas agregadas por per√≠odo
            const aggregateMetrics = (days) => {
                const today = new Date().toISOString().split('T')[0];
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - (days - 1));
                const startDateString = startDate.toISOString().split('T')[0];

                const periodResults = results.filter(r => r.clientId === clientFilter && r.data >= startDateString && r.data <= today);
                
                let summary = periodResults.reduce((acc, r) => {
                    acc.gasto += r.investimento;
                    acc.vendas += r.vendas;
                    acc.conversoes += r.conversionCount || 0;
                    return acc;
                }, { gasto: 0, vendas: 0, conversoes: 0 });

                return {
                    dias: days,
                    gasto: summary.gasto,
                    vendas: summary.vendas,
                    conversoes: summary.conversoes,
                    roas: calculateROAS(summary.gasto, summary.vendas),
                    cpa: calculateCPA(summary.gasto, summary.conversoes)
                };
            };

            const data7D = aggregateMetrics(7);
            const data15D = aggregateMetrics(15);
            const data30D = aggregateMetrics(30);

            if (data30D.gasto === 0) {
                 return showMessage('N√£o h√° dados suficientes dos √∫ltimos 30 dias para gerar uma an√°lise estrat√©gica.', 5000, true);
            }

            // Constr√≥i o Prompt Estrat√©gico
            const systemPrompt = `Voc√™ √© um Consultor Estrat√©gico de Marketing, focado em tend√™ncias de longo prazo. Sua tarefa √© analisar a evolu√ß√£o do desempenho de um cliente em janelas de 7, 15 e 30 dias e identificar OPORTUNIDADES E RISCOS.
            Sua resposta deve ter 3 sec√ß√µes:
            1. Tend√™ncias (Max. 3 linhas): Resuma a evolu√ß√£o de ROAS e Gasto (melhorou, piorou, estagnou).
            2. Oportunidades (Max. 3 sugest√µes): Sugira caminhos estrat√©gicos claros (ex: aumentar budget em 15D, testar novo p√∫blico, focar em convers√£o mais barata).
            3. Riscos (Max. 2 pontos): Aponte problemas de sustentabilidade (ex: CPA subindo em 30D).
            Formate a resposta usando Markdown para clareza (t√≠tulos de sec√ß√£o e listas de pontos).`;


            const userQuery = `Analise a performance do cliente ${clientName} em diferentes janelas:

            - √öltimos 7 dias: Gasto ${formatCurrency(data7D.gasto)}, ROAS ${formatNumber(data7D.roas)}X, CPA ${formatCurrency(data7D.cpa)}.
            - √öltimos 15 dias: Gasto ${formatCurrency(data15D.gasto)}, ROAS ${formatNumber(data15D.roas)}X, CPA ${formatCurrency(data15D.cpa)}.
            - √öltimos 30 dias: Gasto ${formatCurrency(data30D.gasto)}, ROAS ${formatNumber(data30D.roas)}X, CPA ${formatCurrency(data30D.cpa)}.
            
            Compare as tend√™ncias de 7D vs 30D.`;


            // 1. Mostrar o modal de carregamento
            const loadingHtml = `<div class="spinner"></div><p class="text-gray-400 mt-4">A Gemini est√° a gerar a an√°lise estrat√©gica...</p>`;
            openSummaryModal('‚ú® Gerando An√°lise Estrat√©gica', loadingHtml);

            // 2. Chamar a API
            const analysisText = await callGeminiApi(systemPrompt, userQuery);

            // 3. Formatar e exibir o resultado
            // Permite que o LLM use Markdown para formata√ß√£o de listas.
            const finalHtml = `<div class="text-base leading-relaxed text-left">${analysisText}</div>`; 
            openSummaryModal('‚ú® An√°lise Estrat√©gica de Tend√™ncias', finalHtml);
        }

        /** Otimiza as observa√ß√µes do cliente usando o LLM (ABA CADASTRO DE CLIENTES) */
        window.optimizeClientObservation = async function() {
            const obsEl = document.getElementById('cli_observacoes');
            const clientName = document.getElementById('cli_nome').value || 'Novo Cliente';
            const rawObs = obsEl.value;

            if (rawObs.trim().length < 10) {
                return showMessage('Insira pelo menos 10 caracteres de observa√ß√µes para otimizar.', 4000, true);
            }

            // 1. Mostrar o spinner na textarea de observa√ß√µes
            const originalObs = obsEl.value;
            obsEl.value = 'Gerando otimiza√ß√£o... Aguarde...';
            
            // Constr√≥i o prompt
            const systemPrompt = `Voc√™ √© um Copywriter Estrat√©gico da Novan Agency. Sua tarefa √© refinar e otimizar as observa√ß√µes brutas de um cliente em um resumo estrat√©gico conciso e de alto impacto, focado no nicho e nos desafios principais. O resumo deve ter no m√°ximo 4 linhas.`;

            const userQuery = `Refine o seguinte texto em um resumo estrat√©gico claro para o cliente '${clientName}':\n\n${rawObs}`;

            // 2. Chamar a API
            const refinedText = await callGeminiApi(systemPrompt, userQuery);
            
            // 3. Exibir o resultado
            obsEl.value = refinedText;

            showMessage('‚ú® Resumo estrat√©gico otimizado e inserido!');
        }


        // --- INICIALIZA√á√ÉO DA APLICA√á√ÉO PRINCIPAL (Ap√≥s Login) ---

        /** Inicializa os listeners do Firestore e o estado da UI */
        async function initRealtimeListeners(currentUserId) {
            if (!currentUserId) return;

            // Define as cole√ß√µes globais
            clientsCollection = collection(db, 'users', currentUserId, 'clients');
            resultsCollection = collection(db, 'users', currentUserId, 'results');
            tasksCollection = collection(db, 'users', currentUserId, 'tasks');

            // Listener para Clientes
            onSnapshot(clientsCollection, (snapshot) => {
                clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderClientList();
                populateClientSelects();
            });

            // Listener para Resultados
            onSnapshot(resultsCollection, (snapshot) => {
                results = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderResultsTable(); // Atualiza a tabela/cart√µes de resultados
            });

            // Listener para Tarefas
            onSnapshot(tasksCollection, (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCalendar();
                renderTaskManagement();
                renderTaskNotifications();
            });
        }

        /** Fun√ß√£o principal chamada pelo onAuthStateChanged */
        async function initAppContent() {
            // O userId j√° deve estar definido pelo onAuthStateChanged
            if (!userId) {
                console.error("Auth n√£o est√° pronto, aguardando...");
                return;
            }
            
            // 1. Inicia os listeners de dados
            await initRealtimeListeners(userId); 
            
            // 2. Configura a UI inicial (que n√£o depende de dados)
            populateResponsiblesSelect(); 
            document.getElementById('res_data').valueAsDate = new Date();
            updateMetricsDisplay();
            
            // 3. Define a aba inicial (conforme o HTML mais recente)
            switchTab('clientes'); // Inicia em Clientes

            // 4. CORRE√á√ÉO: Move listeners que dependem do DOM para aqui.
            document.getElementById('task_manager_filter_client').addEventListener('change', renderTaskManagement);
            document.getElementById('task_manager_filter_status').addEventListener('change', renderTaskManagement);

            document.getElementById('results_filter_cliente').addEventListener('change', renderResultsTable);
            document.getElementById('results_filter_start_date').addEventListener('change', renderResultsTable);
            document.getElementById('results_filter_end_date').addEventListener('change', renderResultsTable);
        }

    </script>
</body>
</html>