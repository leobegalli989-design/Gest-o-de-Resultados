<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novan Agency | Painel de Gest√£o de Tr√°fego e Tarefas</title>
    <!-- Carrega Tailwind CSS para estiliza√ß√£o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega Chart.js para gera√ß√£o de gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Configura√ß√£o da fonte Poppins e cores personalizadas do Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'novan-primary': '#6D28D9', // Roxo principal
                        'novan-secondary': '#0F172A', // Preto/Cinza Escuro (fundo)
                        'novan-light': '#F8FAFC', // Cinza Claro (cards/inputs)
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        /* Estilos globais para a aplica√ß√£o */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1E293B; /* Fundo Escuro para o conte√∫do principal (Slate-800) */
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .sidebar-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        .sidebar-item.active {
            background-color: '#5B21B6'; /* Roxo mais escuro */
            border-left: 4px solid #FBBF24; /* Destaque amarelo para contraste */
        }
        /* Estilo para a tabela de resultados: Fontes menores e padding corrigido */
        #resultsTable th {
            padding: 8px 6px; /* Aumenta o espa√ßamento nas c√©lulas do cabe√ßalho */
            border-bottom: 1px solid #334155; /* Borda escura */
            white-space: nowrap;
            font-size: 0.75rem; /* text-xs */
            text-transform: uppercase;
            letter-spacing: 0.05em; /* tracking-wider */
            color: #F8FAFC; /* Texto claro */
        }
        #resultsTable td {
            padding: 8px 6px; /* Aumenta o espa√ßamento nas c√©lulas de dados */
            border-bottom: 1px solid #334155; /* Borda escura */
            white-space: nowrap;
            font-size: 0.75rem; /* text-xs */
            color: #E2E8F0; /* Texto claro */
        }
        /* Estilos do calend√°rio */
        .calendar-day {
            min-height: 100px;
            border: 1px solid #334155; /* Borda escura */
            background-color: #1E293B; /* Fundo escuro */
            transition: transform 0.1s;
            color: #E2E8F0; /* Texto claro */
        }
        .calendar-day:hover {
            transform: scale(1.02);
            cursor: pointer; /* Adiciona cursor de ponteiro para indicar que √© clic√°vel */
            background-color: #334155; /* Darker hover */
        }
        /* Cor dos dias do m√™s (o padr√£o Tailwind √© aplicado no HTML, mas garantindo aqui) */
        .calendar-day div {
            color: #E2E8F0; 
        }
        
        /* --- ESTILOS DE LOGIN (FUNDO ANIMADO) --- */
        #login-page {
            background-color: #0E1B31; /* Azul Marinho Escuro */
            position: relative;
            overflow: hidden;
        }

        /* NOVO: Estilo para o Canvas Matrix */
        #matrixCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; 
            opacity: 0.6;
        }
        
        #login-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Padr√£o de Grid Sutil */
            background-image: linear-gradient(to right, rgba(109, 40, 217, 0.1) 1px, transparent 1px), 
                              linear-gradient(to bottom, rgba(109, 40, 217, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.5;
            animation: pulseGlow 15s infinite alternate;
            z-index: 0; /* Manter o grid no fundo */
        }
        @keyframes pulseGlow {
            0% { opacity: 0.3; transform: scale(1); }
            100% { opacity: 0.6; transform: scale(1.05); }
        }

        /* PE√áAS DE JOGO ANIMADAS */
        .futuristic-piece {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #a78bfa 0%, #6D28D9 100%);
            box-shadow: 0 0 15px #6D28D9, inset 0 0 8px rgba(255, 255, 255, 0.5);
            z-index: 1;
            opacity: 0.7;
            animation: floatPiece 15s ease-in-out infinite alternate, pulsePiece 3s ease-in-out infinite;
        }

        .piece-1 { top: 10%; left: 10%; transform: scale(0.8); }
        .piece-2 { bottom: 15%; right: 10%; width: 90px; height: 90px; background: radial-gradient(circle at 70% 70%, #d8b4fe 0%, #6D28D9 100%); animation-delay: 2s; }
        .piece-3 { top: 50%; left: 5%; transform: scale(0.6); animation-delay: 4s; }
        .piece-4 { bottom: 5%; left: 40%; width: 40px; height: 40px; animation-delay: 6s; }

        @keyframes floatPiece {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(50px, -50px) rotate(10deg); }
        }

        @keyframes pulsePiece {
            0% { box-shadow: 0 0 15px #6D28D9, inset 0 0 8px rgba(255, 255, 255, 0.5); }
            50% { box-shadow: 0 0 25px #c4b5fd, inset 0 0 15px #a78bfa; }
            100% { box-shadow: 0 0 15px #6D28D9, inset 0 0 8px rgba(255, 255, 255, 0.5); }
        }
        /* FIM PE√áAS DE JOGO ANIMADAS */
        
        /* ANIMA√á√ÉO DE CARREGAMENTO (SPINNER) */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #6D28D9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Estilos para diferencia√ß√£o de cor nas c√©lulas da tabela */
        .text-investimento { color: #EF4444; font-weight: 600; } /* Red 500 (GASTO) */
        .text-faturamento { color: #10B981; font-weight: 600; }  /* Green 500 (FATURAMENTO/VENDAS) */
        .text-cpa { color: #F59E0B; font-weight: 600; }          /* Amber 500 (CPA) */
        .text-roas { color: #DC2626; font-weight: 600; }          /* Red 600 (ROAS - mantendo a cor forte de retorno) */
        .text-cpm { color: #3B82F6; font-weight: 600; }           /* Blue 500 (CPM) */
        
        .text-impressoes { color: #3B82F6; font-weight: 600; }   /* Blue 500 (IMPRESS√ïES - mesma cor do CPM para consist√™ncia) */
        .text-cliques { color: #EC4899; font-weight: 600; }      /* Pink 500 (CLIQUES) */
        .text-conversoes { color: #6D28D9; font-weight: 600; }    /* Novan Primary (Purple) (CONVERS√ïES) */
        

    </style>
</head>
<body class="flex flex-col lg:flex-row min-h-screen">
    
    <!-- Tela de Login -->
    <div id="login-page" class="flex items-center justify-center min-h-screen w-full bg-novan-secondary">
        <!-- NOVO: CANVAS PARA EFEITO CASCATA DE C√ìDIGO (Matrix) -->
        <canvas id="matrixCanvas"></canvas>
        
        <!-- Pe√ßas de Jogo Animadas para Fundo Futurista -->
        <div class="futuristic-piece piece-1"></div>
        <div class="futuristic-piece piece-2"></div>
        <div class="futuristic-piece piece-3"></div>
        <div class="futuristic-piece piece-4"></div>
        <!-- Fim Pe√ßas de Jogo Animadas -->

        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md z-10">
            <h1 class="text-4xl font-bold text-center text-novan-primary mb-6">Novan Agency</h1>
            <p class="text-center text-gray-600 mb-8">Acesso restrito. Fa√ßa login para continuar.</p>
            
            <form id="loginForm" class="space-y-4">
                <input type="email" id="login_email" placeholder="Email" required 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-novan-primary focus:border-novan-primary" />
                
                <!-- CAMPO DE SENHA COM TOGGLE DE VISIBILIDADE -->
                <div class="relative">
                    <input type="password" id="login_password" placeholder="Senha" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-novan-primary focus:border-novan-primary pr-10" />
                    <button type="button" onclick="togglePasswordVisibility()" 
                        class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-novan-primary transition-colors">
                        <!-- SVG do Olho Aberto (Padr√£o) -->
                        <svg id="togglePasswordIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <!-- Path 1 (Center dot/circle) -->
                            <path id="togglePasswordPath1" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <!-- Path 2 (Eye outline) -->
                            <path id="togglePasswordPath2" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </button>
                </div>
                <!-- FIM CAMPO DE SENHA COM TOGGLE DE VISIBILIDADE -->
                
                <div class="flex items-center justify-between">
                    <label for="rememberMe" class="flex items-center text-sm text-gray-600">
                        <input type="checkbox" id="rememberMe" checked class="h-4 w-4 text-novan-primary border-gray-300 rounded focus:ring-novan-primary mr-2">
                        Lembrar de Mim (Salvar Login)
                    </label>
                </div>

                <button type="submit" id="loginButton" class="w-full bg-novan-primary hover:bg-violet-700 text-white font-semibold p-3 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                    Entrar
                </button>
            </form>
            <p id="authError" class="text-center text-red-500 mt-4 text-sm hidden"></p>
        </div>
    </div>
    <!-- Fim Tela de Login -->

    <!-- Dashboard Principal (Escondido at√© o Login) -->
    <div id="dashboard-container" class="hidden contents">

        <!-- Sidebar de Navega√ß√£o (Menu) -->
        <aside id="sidebar" class="bg-novan-secondary text-white w-full lg:w-64 flex-shrink-0 p-4 shadow-2xl lg:shadow-none">
            <div class="text-3xl font-bold mb-8 text-novan-primary border-b border-gray-700 pb-4">
                Novan Agency
            </div>
            
            <!-- Menu Items -->
            <nav>
                <div id="nav-resultados" class="sidebar-item p-3 rounded-lg flex items-center mb-2 active" data-tab="resultados">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-2 7v-4m-2 2h4M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                    Resultados de Campanhas
                </div>
                <div id="nav-calendario" class="sidebar-item p-3 rounded-lg flex items-center mb-2" data-tab="calendario">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-4 10h.01M3 21h18a2 2 0 002-2V7a2 2 0 00-2-2H3a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    Calend√°rio de Tarefas
                </div>
                <div id="nav-clientes" class="sidebar-item p-3 rounded-lg flex items-center mb-2" data-tab="clientes">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M7 14v-4a5 5 0 0110 0v4M7 14l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17" /></svg>
                    Cadastro de Clientes
                </div>
                
                <!-- NOVA ABA: GEST√ÉO DE TAREFAS -->
                <div id="nav-gestao" class="sidebar-item p-3 rounded-lg flex items-center mb-2" data-tab="gestao">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-2 4l-2 2m0 0l-2-2m2 2V5" /></svg>
                    Gest√£o de Tarefas
                </div>

                <div id="nav-relatorios" class="sidebar-item p-3 rounded-lg flex items-center mb-2" data-tab="relatorios">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>
                    Relat√≥rios e Insights
                </div>
                
                <!-- Bot√£o de SAIR / LOGOUT -->
                <div onclick="handleLogout()" class="sidebar-item p-3 rounded-lg flex items-center mb-2 mt-8 bg-red-600 hover:bg-red-700 text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    Sair (Logout)
                </div>
            </nav>
        </aside>

        <!-- Conte√∫do Principal -->
        <main class="flex-grow p-4 md:p-8 overflow-x-hidden">
            
            <!-- Mensagem de feedback/alerta -->
            <div id="messageBox" class="fixed top-4 right-4 bg-novan-primary text-white p-3 rounded-lg shadow-xl hidden z-50 transition-all duration-300"></div>

            <!-- Tab 1: Resultados de Campanhas -->
            <section id="resultados" class="tab-content active">
                <h1 class="text-4xl font-bold text-white mb-6">üßæ Resultados de Campanhas</h1>
                
                <!-- Formul√°rio de Registro Di√°rio -->
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-novan-primary">Registro Di√°rio de Performance</h2>
                    <form id="campaignForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <!-- LINHA 1 -->
                        <input type="date" id="res_data" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" value="" />
                        <select id="res_cliente" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                            <option value="">Selecione o Cliente</option>
                        </select>
                        <select id="res_plataforma" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                            <option value="Meta">Meta Ads</option>
                            <option value="Google">Google Ads</option>
                            <option value="Outra">Outra</option>
                        </select>
                        <input type="number" step="0.01" id="res_investimento" placeholder="Gasto (R$)" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        
                        <!-- LINHA 2 (M√©tricas Prim√°rias e Vendas) -->
                        <input type="number" id="res_impressoes" placeholder="Impress√µes" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        <input type="number" id="res_alcance" placeholder="Alcance" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        <input type="number" id="res_cliques" placeholder="Cliques no Site" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        <!-- Vendas / Faturamento movido para a 4¬™ coluna da Linha 2 -->
                        <input type="number" step="0.01" id="res_vendas" placeholder="Vendas (incl. Compras) / Faturamento (R$)" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        
                        <!-- LINHA 3 (Convers√£o e M√©tricas Calculadas) -->
                        <!-- BLOCO DE CONVERS√ÉO - Agora ocupa 2 colunas para mais visibilidade -->
                        <div class="col-span-1 md:col-span-2 flex items-center space-x-2">
                            <select id="res_conversion_type" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary w-1/2 bg-gray-700 text-white">
                                <option value="">Tipo Convers√£o</option>
                                <option value="Ligue">Ligue</option>
                                <option value="Mensagem">Mensagem</option>
                                <option value="Compras">Compras</option>
                                <option value="Formulario">Formul√°rio</option>
                                <option value="Visualizacao">Visualiza√ß√£o</option>
                                <option value="Outro">Outro</option>
                            </select>
                            <input type="number" id="res_conversion_count" placeholder="Total de Convers√µes" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary w-1/2 bg-gray-700 text-white" />
                        </div>
                        <!-- M√©tricas Calculadas (CPA, ROAS, CPM) - Ocupa as 2 colunas restantes -->
                        <div class="col-span-1 md:col-span-2 flex items-center space-x-4">
                            <div class="text-sm font-medium text-gray-300">CPA: R$ <span id="cpa_calc" class="font-bold text-red-500">0.00</span></div>
                            <div class="text-sm font-medium text-gray-300">ROAS: <span id="roas_calc" class="font-bold text-green-500">0.00</span></div>
                            <div class="text-sm font-medium text-gray-300">CPM: R$ <span id="cpm_calc" class="font-bold text-blue-500">0.00</span></div>
                        </div>
                        
                        <!-- LINHA 4 (Observa√ß√µes e Bot√µes) -->
                        <textarea id="res_observacoes" placeholder="Observa√ß√µes do dia" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary col-span-1 md:col-span-4 bg-gray-700 text-white"></textarea>

                        <button type="submit" class="col-span-1 md:col-span-2 bg-novan-primary hover:bg-violet-700 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Registrar Resultados
                        </button>
                        <button type="button" id="btnResumoDiario" class="col-span-1 bg-green-500 hover:bg-green-600 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Gerar Resumo Di√°rio
                        </button>
                        <button type="button" id="btnResumoQuinzenal" class="col-span-1 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Gerar Resumo Quinzenal
                        </button>
                    </form>
                </div>

                <!-- Modal para Resumos -->
                <div id="summaryModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
                    <div class="bg-novan-secondary p-6 rounded-xl shadow-2xl w-full max-w-lg">
                        <h3 id="summaryTitle" class="text-2xl font-bold mb-4 text-novan-primary"></h3>
                        <div id="summaryContent" class="mb-4 text-gray-300 max-h-96 overflow-y-auto"></div>
                        <button onclick="closeSummaryModal()" class="bg-red-500 hover:bg-red-600 text-white font-semibold p-2 rounded-lg w-full">Fechar</button>
                    </div>
                </div>

                <!-- NOVO BLOCO DE FILTROS PARA O HIST√ìRICO -->
                <div class="bg-slate-800 p-4 rounded-xl shadow-lg mb-6 flex flex-wrap gap-4 items-end">
                    <h2 class="text-xl font-semibold text-white flex-grow basis-full md:basis-auto">Filtrar:</h2>
                    <select id="results_filter_cliente" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary flex-grow bg-gray-700 text-white">
                        <option value="">Selecione o Cliente</option>
                    </select>
                    <input type="date" id="results_filter_start_date" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                    <span class="font-medium text-gray-300">at√©</span>
                    <input type="date" id="results_filter_end_date" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                    <button onclick="renderResultsTable()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                        Aplicar Filtros
                    </button>
                </div>
                <!-- FIM NOVO BLOCO DE FILTROS -->

                <!-- NOVO BLOCO: KPI Cards de Resumo (AGREGADO) -->
                <div id="kpiCardsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                    <!-- Cards KPI ser√£o injetados aqui (Gasto Total, Faturamento, ROAS M√©dio, CPA M√©dio, CPM M√©dio) -->
                </div>
                <!-- FIM NOVO BLOCO: KPI Cards de Resumo -->

                <!-- Container do Resumo Di√°rio (Substituto da Tabela de Hist√≥rico) -->
                <div class="bg-novan-secondary p-6 rounded-xl shadow-lg overflow-x-auto">
                    <h2 class="text-xl font-semibold mb-4 text-white">M√©tricas Agregadas por Filtro</h2>
                    
                    <!-- SPINNER DE CARREGAMENTO PARA FILTRO -->
                    <div id="resultsLoading" class="hidden text-center py-8">
                        <div class="spinner"></div>
                        <p class="text-gray-400 mt-2">Carregando m√©tricas...</p>
                    </div>
                    <!-- FIM SPINNER -->

                    <!-- NOVO: KPI Cards Detalhados de Resumo -->
                    <div id="dailySummaryKpis" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-4 gap-4">
                        <!-- Os 8 KPIs di√°rios/agregados ser√£o injetados aqui -->
                    </div>
                    <!-- FIM NOVO: KPI Cards Detalhados de Resumo -->

                    <p id="noResults" class="text-center text-gray-400 mt-4 hidden">Nenhuma m√©trica registrada ou cliente selecionado.</p>
                </div>
            </section>

            <!-- Tab 2: Calend√°rio de Tarefas -->
            <section id="calendario" class="tab-content">
                <h1 class="text-4xl font-bold text-white mb-6">üìÖ Calend√°rio de Tarefas</h1>
                
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    
                    <!-- Card de Cadastro de Tarefas -->
                    <div class="lg:col-span-1 bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold mb-4 text-novan-primary">Cadastrar Nova Tarefa</h2>
                        <form id="taskForm" class="space-y-3">
                            <select id="task_cliente" required class="w-full p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                <option value="">Selecione o Cliente</option>
                            </select>
                            <select id="task_tipo" required class="w-full p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                <option value="">Tipo de Tarefa</option>
                                <option value="Campanha">Campanha Ads</option>
                                <option value="Post">Post/Conte√∫do</option>
                                <option value="Reuniao">Reuni√£o</option>
                                <option value="Video">Entrega de V√≠deo</option>
                                <option value="Relatorio">Relat√≥rio</option>
                                <option value="Outro">Outro</option>
                            </select>
                            <input type="datetime-local" id="task_data" required class="w-full p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                            <select id="task_status" required class="w-full p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                <option value="Pendente">Pendente</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Concluido">Conclu√≠do</option>
                            </select>
                            <textarea id="task_observacoes" placeholder="Observa√ß√µes" class="w-full p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white"></textarea>
                            <button type="submit" class="w-full bg-novan-primary hover:bg-violet-700 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                                Salvar Tarefa
                            </button>
                        </form>
                    </div>

                    <!-- Card de Visualiza√ß√£o do Calend√°rio e Filtros -->
                    <div class="lg:col-span-3 bg-novan-secondary p-6 rounded-xl shadow-lg">
                        <div class="flex flex-wrap items-center justify-between mb-4">
                            <div class="flex space-x-2 mb-4 md:mb-0">
                                <button id="prevMonth" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-lg font-bold transition-transform transform hover:scale-[1.05]">&lt;</button>
                                <h2 id="currentMonthYear" class="text-2xl font-bold text-white self-center"></h2>
                                <button id="nextMonth" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-lg font-bold transition-transform transform hover:scale-[1.05]">&gt;</button>
                            </div>
                            <div class="flex space-x-2">
                                <select id="filterClient" class="p-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-white">
                                    <option value="">Filtrar por Cliente</option>
                                </select>
                                <select id="filterType" class="p-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-white">
                                    <option value="">Filtrar por Tipo</option>
                                    <option value="Campanha">Campanha Ads</option>
                                    <option value="Post">Post/Conte√∫do</option>
                                    <option value="Reuniao">Reuni√£o</option>
                                    <option value="Video">Entrega de V√≠deo</option>
                                    <option value="Relatorio">Relat√≥rio</option>
                                <option value="Outro">Outro</option>
                            </select>
                                <button class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-lg text-sm">Ver M√™s</button>
                                <!-- Adicionar 'Ver Semana' se houver tempo, por enquanto 'Ver M√™s' -->
                            </div>
                        </div>

                        <!-- Grade do Calend√°rio -->
                        <div class="grid grid-cols-7 text-center font-semibold text-novan-primary border-b-2 border-gray-600 pb-2 mb-2">
                            <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>S√°b</span>
                        </div>
                        <div id="calendarGrid" class="grid grid-cols-7 gap-1">
                            <!-- Dias ser√£o injetados aqui -->
                        </div>

                        <!-- Notifica√ß√µes de Tarefas Pr√≥ximas -->
                        <div id="taskNotifications" class="mt-6 p-3 bg-yellow-900/50 border-l-4 border-yellow-500 text-yellow-300 rounded-lg hidden">
                            <h4 class="font-semibold">‚ö†Ô∏è Alerta de Prazos Pr√≥ximos:</h4>
                            <ul id="notificationList" class="list-disc list-inside mt-1"></ul>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Tab 3: Cadastro de Clientes -->
            <section id="clientes" class="tab-content">
                <h1 class="text-4xl font-bold text-white mb-6">üë• Cadastro de Clientes</h1>
                
                <!-- Bot√£o e Modal para Cadastrar Novo Cliente (NOVO FLUXO) -->
                <div class="mb-6 flex justify-center">
                    <button onclick="openClientTypeSelectionModal()" class="bg-novan-primary hover:bg-violet-700 text-white font-semibold p-3 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                        + Cadastrar Novo Cliente
                    </button>
                </div>

                <!-- Modal de Sele√ß√£o de Tipo de Cliente -->
                <div id="clientTypeSelectionModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
                    <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
                        <h3 class="text-2xl font-bold mb-6 text-white">Qual o tipo de servi√ßo?</h3>
                        <div class="space-y-4">
                            <button onclick="selectClientType('traffic')" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold p-3 rounded-lg shadow-md transition-transform transform hover:scale-[1.02]">
                                Tr√°fego Pago
                            </button>
                            <button onclick="selectClientType('social')" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-semibold p-3 rounded-lg shadow-md transition-transform transform hover:scale-[1.02]">
                                Social Media
                            </button>
                            <button onclick="closeClientTypeSelectionModal()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold p-2 rounded-lg mt-4">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Formul√°rio de Cadastro -->
                <!-- clientFormContainer est√° oculto por padr√£o -->
                <div id="clientFormContainer" class="bg-slate-800 p-6 rounded-xl shadow-lg mb-8 max-w-2xl mx-auto hidden">
                    <h2 class="text-xl font-semibold mb-4 text-novan-primary" id="clientFormTitle">Formul√°rio de Cliente</h2>
                    <form id="clientForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Campo oculto para armazenar o tipo de servi√ßo ativo -->
                        <input type="hidden" id="cli_service_type" value="traffic">
                        <!-- Campo oculto para ID de edi√ß√£o -->
                        <input type="hidden" id="cli_id_edit" value="">


                        <!-- CAMPOS COMUNS -->
                        <input type="text" id="cli_nome" placeholder="Nome da Empresa" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        <select id="cli_responsavel" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                            <option value="">Selecione o Respons√°vel da Ag√™ncia</option>
                        </select>
                        <input type="tel" id="cli_telefone" placeholder="Telefone / WhatsApp" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" oninput="maskPhone(this)" maxlength="15" />
                        <input type="url" id="cli_link" placeholder="Link (Site/Card√°pio/Perfil)" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        <!-- FIM CAMPOS COMUNS -->

                        <!-- CAMPOS ESPEC√çFICOS DE TR√ÅFEGO PAGO -->
                        <div id="trafficFields" class="contents">
                            <!-- Plataforma Principal -->
                            <select id="cli_plataforma_traffic" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                <option value="Meta">Plataforma Principal: Meta Ads</option>
                                <option value="Google">Plataforma Principal: Google Ads</option>
                                <option value="Ambos">Plataforma Principal: Ambos</option>
                            </select>
                            
                            <!-- Tipo e Valor do Or√ßamento -->
                            <div>
                                <select id="cli_budget_type_traffic" required class="w-full p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                    <option value="">Selecione o Tipo de Or√ßamento</option>
                                    <option value="Or√ßamento Di√°rio">Or√ßamento Di√°rio</option>
                                    <option value="Or√ßamento de Campanha">Or√ßamento de Campanha</option>
                                </select>
                            </div>
                            <input type="number" step="0.01" id="cli_budget_value_traffic" placeholder="Valor (R$)" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                            
                            <!-- Meta de Convers√£o -->
                            <select id="cli_conversion_goals_traffic" required class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                <option value="">Principal Meta de Convers√£o</option>
                                <option value="Ligue">Ligue (Chamadas)</option>
                                <option value="Mensagem">Mensagem (Leads)</option>
                                <option value="Compras">Compras no Site</option>
                                <option value="Formul√°rio">Formul√°rio (Leads)</option>
                                <option value="Visualizacao">Visualiza√ß√£o de Conte√∫do</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <!-- FIM CAMPOS ESPEC√çFICOS DE TR√ÅFEGO PAGO -->

                        <!-- CAMPOS ESPEC√çFICOS DE SOCIAL MEDIA -->
                        <div id="socialMediaFields" class="hidden contents">
                            <!-- Foco de Plataforma SM -->
                            <select id="cli_sm_platform" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                <option value="Instagram">Foco Principal: Instagram</option>
                                <option value="TikTok">Foco Principal: TikTok</option>
                                <option value="LinkedIn">Foco Principal: LinkedIn</option>
                                <option value="Pinterest">Foco Principal: Pinterest</option>
                                <option value="AmbosSM">Ambos/M√∫ltiplos</option>
                            </select>

                            <!-- Fee Mensal SM -->
                            <input type="number" step="0.01" id="cli_sm_fee" placeholder="Fee Mensal (R$)" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                            
                            <!-- Necessidade de Conte√∫do SM -->
                            <select id="cli_sm_needs" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white">
                                <option value="Conteudo">Foco: Cria√ß√£o de Conte√∫do</option>
                                <option value="Design">Foco: Design/Branding</option>
                                <option value="Estrategia">Foco: Estrat√©gia/Planejamento</option>
                            </select>
                            
                            <div class="col-span-1"></div> <!-- Espa√ßador para manter o grid -->
                        </div>
                        <!-- FIM CAMPOS ESPEC√çFICOS DE SOCIAL MEDIA -->

                        <textarea id="cli_observacoes" placeholder="Observa√ß√µes gerais e Nicho" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary col-span-1 md:col-span-2 bg-gray-700 text-white"></textarea>

                        <button type="submit" id="clientSubmitButton" class="col-span-1 md:col-span-2 bg-novan-primary hover:bg-violet-700 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Cadastrar Cliente
                        </button>
                        <button type="button" id="clientCancelButton" onclick="resetClientForm()" class="hidden col-span-1 md:col-span-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Cancelar Edi√ß√£o
                        </button>
                    </form>
                </div>

                <!-- Lista de Clientes Cadastrados -->
                <div class="bg-novan-secondary p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-white">Clientes Ativos</h2>
                    <div id="clientList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Cards de clientes ser√£o injetados aqui via JS -->
                    </div>
                    <!-- O elemento noClients foi movido para fora do clientList para evitar ser apagado pelo innerHTML = '' -->
                    <p id="noClients" class="text-center text-gray-400 col-span-full hidden mt-4">Nenhum cliente cadastrado ainda.</p>
                </div>
            </section>

            <!-- Tab 5: Gest√£o de Tarefas (NOVA ABA) -->
            <section id="gestao" class="tab-content">
                <h1 class="text-4xl font-bold text-white mb-6">‚úÖ Gest√£o de Tarefas e Status</h1>
                
                <div class="bg-slate-800 p-4 rounded-xl shadow-lg mb-6 flex flex-wrap gap-4 items-center">
                    <h2 class="text-xl font-semibold text-novan-primary">Filtrar:</h2>
                    <select id="task_manager_filter_client" class="p-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                        <option value="">Todos os Clientes</option>
                    </select>
                    <select id="task_manager_filter_status" class="p-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                        <option value="">Todos os Status</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Concluido">Concluido</option>
                    </select>
                    <button onclick="renderTaskManagement()" class="bg-novan-primary hover:bg-violet-700 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                        Aplicar Filtros
                    </button>
                </div>

                <!-- Kanban-like Board (3 colunas para status) -->
                <div id="taskManagementBoard" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Colunas de Status ser√£o renderizadas aqui -->
                </div>
                
                <p id="noTasksMessage" class="text-center text-gray-400 mt-8 hidden">Nenhuma tarefa encontrada para os filtros selecionados.</p>
            </section>

            <!-- Tab 4: Relat√≥rios e Insights -->
            <section id="relatorios" class="tab-content">
                <h1 class="text-4xl font-bold text-white mb-6">üìä Relat√≥rios e Insights</h1>
                
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-novan-primary">Filtros de Relat√≥rio</h2>
                    <div class="flex flex-wrap gap-4 items-end">
                        <select id="report_cliente" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary flex-grow bg-gray-700 text-white">
                            <option value="">Todos os Clientes</option>
                        </select>
                        <input type="date" id="report_start_date" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        <span class="font-medium text-gray-300">at√©</span>
                        <input type="date" id="report_end_date" class="p-2 border border-gray-600 rounded-lg focus:ring-novan-primary focus:border-novan-primary bg-gray-700 text-white" />
                        <button onclick="generateReport()" class="bg-novan-primary hover:bg-violet-700 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Gerar Relat√≥rio
                        </button>
                        <!-- BOT√ïES DE EXPORTA√á√ÉO SEPARADOS -->
                        <button onclick="exportReportAsCSV()" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Exportar Dados (CSV)
                        </button>
                        <button onclick="exportCombinedReportAsPNG()" class="bg-pink-700 hover:bg-pink-800 text-white font-semibold p-2 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                            Exportar Relat√≥rio (PNG)
                        </button>
                        <!-- FIM BOT√ïES DE EXPORTA√á√ÉO SEPARADOS -->
                    </div>
                </div>

                <div id="chartsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Gr√°fico 1: Gasto vs Faturamento -->
                    <div class="bg-novan-secondary p-6 rounded-xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-4 text-white">Gasto vs Faturamento (R$)</h3>
                        <canvas id="investimentoFaturamentoChart"></canvas>
                    </div>
                    
                    <!-- Gr√°fico 2: Impress√µes vs Cliques -->
                    <div class="bg-novan-secondary p-6 rounded-xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-4 text-white">Impress√µes vs Cliques (Volume)</h3>
                        <canvas id="impressoesCliquesChart"></canvas>
                    </div>

                    <!-- Gr√°fico 3: ROAS M√©dio por Per√≠odo -->
                    <div class="bg-novan-secondary p-6 rounded-xl shadow-lg lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-4 text-white">ROAS M√©dio Di√°rio (X)</h3>
                        <canvas id="roasChart"></canvas>
                    </div>
                    
                    <p id="noReportData" class="text-center text-gray-400 col-span-full hidden">Selecione filtros e gere o relat√≥rio para visualizar os gr√°ficos.</p>
                </div>

            </section>
        </main>
    </div>
    <!-- Fim Dashboard Principal -->

    <!-- Modal de Detalhes e Gest√£o de Tarefa (NOVO) -->
    <div id="taskDetailModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-slate-800 p-6 rounded-xl shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                <h3 class="text-2xl font-bold text-white" id="modalTaskTitle">Detalhes da Tarefa</h3>
                <button onclick="closeTaskDetailModal()" class="text-gray-400 hover:text-red-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div class="text-gray-300 space-y-3">
                <p><strong>Cliente:</strong> <span id="modalClientName" class="font-semibold text-novan-primary"></span></p>
                <p><strong>Tipo:</strong> <span id="modalTaskType"></span></p>
                <p><strong>Prazo:</strong> <span id="modalTaskDate"></span></p>
                <p><strong>Status Atual:</strong> <span id="modalTaskStatus" class="font-semibold"></span></p>
                
                <div class="bg-gray-700 p-3 rounded-lg mt-4">
                    <p class="font-bold text-white mb-1">Observa√ß√µes:</p>
                    <p id="modalTaskObs" class="text-sm italic whitespace-pre-wrap"></p>
                </div>
            </div>

            <div class="mt-6 border-t border-gray-700 pt-4 space-y-4">
                <div class="flex items-center space-x-3">
                    <label class="text-sm font-medium text-gray-300">Mudar Status:</label>
                    <select id="modalStatusSelect" class="p-2 border text-sm rounded-lg bg-gray-700 text-white focus:ring-novan-primary">
                        <option value="Pendente">Pendente</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Concluido">Conclu√≠do</option>
                    </select>
                    <button onclick="applyStatusChange()" class="bg-green-600 hover:bg-green-700 text-white font-semibold p-2 rounded-lg text-sm">Aplicar</button>
                </div>

                <div class="flex justify-between space-x-2">
                    <!-- Bot√£o de Edi√ß√£o (apenas abre a aba de cadastro, o modal atual √© fechado) -->
                    <button id="modalEditButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold p-2 rounded-lg flex-grow">Editar Tarefa</button>
                    <button id="modalDeleteButton" onclick="deleteTask(document.getElementById('modalTaskId').value); closeTaskDetailModal()" class="bg-red-600 hover:bg-red-700 text-white font-semibold p-2 rounded-lg">Excluir</button>
                </div>
            </div>
            <!-- Campo oculto para armazenar o ID da tarefa -->
            <input type="hidden" id="modalTaskId" value="">
        </div>
    </div>
    <!-- Fim Modal de Detalhes da Tarefa -->

    <script type="module">
        // --- CONFIGURA√á√ÉO E INICIALIZA√á√ÉO DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        
        // Sua Configura√ß√£o Firebase (fornecida pelo usu√°rio)
        const firebaseConfig = {
            apiKey: "AIzaSyAJsx1cHtEsFoCFjk08OLz5bZCiUp8N7lw",
            authDomain: "controle-de-agendamento-97eab.firebaseapp.com",
            projectId: "controle-de-agendamento-97eab",
            storageBucket: "controle-de-agendamento-97eab.firebasestorage.app",
            messagingSenderId: "689700524307",
            appId: "1:689700524307:web:816122032e551c2c6ecae6"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- Vari√°veis globais para armazenar dados e inst√¢ncias ---
        let clients = [];
        let results = [];
        let tasks = [];
        let currentMonth = new Date();
        
        let invFatChartInstance, imprCliquesChartInstance, roasChartInstance;
        let reportSummaryMetrics = null; // Armazena as m√©tricas de resumo
        let reportDetailedResults = []; // NOVO: Armazena os resultados filtrados para o relat√≥rio PNG

        // Lista global de respons√°veis da ag√™ncia
        const AGENCY_RESPONSIBLES = ["L√©o Begalli", "Fabio Franco", "Outro"];

        const COLORS = {
            primary: '#6D28D9',
            secondary: '#0F172A',
            investimento: '#EF4444', // Red 500
            faturamento: '#10B981',  // Green 500
            impressoes: '#3B82F6',   // Blue 500
            cliques: '#EC4899',      // Pink 500
            roas: '#F59E0B'          // Amber 500
        };
        
        // Cores do Relat√≥rio PNG
        const NAVY_BLUE = '#0E1B31'; 
        const LIGHT_TEXT = '#E2E8F0'; // light gray/off-white

        // --- FUN√á√ïES DE AUTENTICA√á√ÉO ---
        
        // Oculta a tela de login e mostra o dashboard
        function showDashboard() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');
            document.getElementById('dashboard-container').classList.add('flex');
            
            // Chama a inicializa√ß√£o da aplica√ß√£o principal
            initAppContent();
        }

        // Oculta o dashboard e mostra a tela de login
        function showLogin() {
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('flex');
            document.getElementById('login-page').classList.remove('hidden');
        }

        /** Lida com o Login */
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login_email').value;
            const password = document.getElementById('login_password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const errorEl = document.getElementById('authError');
            errorEl.classList.add('hidden');
            
            const persistenceType = rememberMe ? browserLocalPersistence : browserSessionPersistence;
            
            try {
                // 1. Define a persist√™ncia
                await setPersistence(auth, persistenceType);
                
                // 2. Realiza o login
                await signInWithEmailAndPassword(auth, email, password);
                
                // O onAuthStateChanged lidar√° com a transi√ß√£o para o dashboard

            } catch (error) {
                let errorMessage = "Erro de Autentica√ß√£o. Verifique seu email e senha.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Credenciais inv√°lidas. Tente novamente.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "O endere√ßo de email √© inv√°lido.";
                }
                errorEl.textContent = errorMessage;
                errorEl.classList.remove('hidden');
                console.error("Erro de Login:", error);
            }
        }

        document.getElementById('loginForm').addEventListener('submit', handleLogin);

        /** Lida com o Logout */
        window.handleLogout = function() {
            signOut(auth).then(() => {
                // O onAuthStateChanged lidar√° com a transi√ß√£o para a tela de login
                showMessage("Sess√£o encerrada com sucesso.", true);
            }).catch((error) => {
                console.error("Erro ao fazer logout:", error);
                showMessage("Erro ao sair. Verifique sua conex√£o.", true);
            });
        }

        /** Observa o estado da autentica√ß√£o (chamado automaticamente pelo Firebase) */
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usu√°rio logado
                showDashboard();
            } else {
                // Usu√°rio deslogado
                showLogin();
            }
        });

        /** Alterna a visibilidade da senha no campo de login */
        window.togglePasswordVisibility = function() {
            const passwordInput = document.getElementById('login_password');
            const toggleIcon = document.getElementById('togglePasswordIcon');
            const path1 = document.getElementById('togglePasswordPath1');
            const path2 = document.getElementById('togglePasswordPath2');
            
            const isPassword = passwordInput.type === 'password';

            if (isPassword) {
                // Mudar para texto (Olho aberto)
                passwordInput.type = 'text';
                // √çcone de Olho Aberto (Ajustar paths se necess√°rio)
                // Os paths j√° s√£o do olho aberto, mas se fosse mudar para olho slash
                path1.setAttribute('d', 'M15 12a3 3 0 11-6 0 3 3 0 016 0z');
                path2.setAttribute('d', 'M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z');
                toggleIcon.setAttribute('title', 'Ocultar Senha');
                
            } else {
                // Mudar para senha (Olho fechado/slash)
                passwordInput.type = 'password';
                // √çcone de Olho Fechado
                path1.setAttribute('d', 'M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7 1.274-4.057 5.065-7 9.542-7a10.05 10.05 0 011.875.175m-2.031 3.22A3.001 3.001 0 0012 15a3 3 0 003-3h-1.062a4.986 4.986 0 01-1.429-1.429m1.43-1.43a3 3 0 00-4.243 4.243M9.879 9.879l4.242 4.242M9.88 9.88l.585-.585M12 15a3 3 0 01-3-3h1.062a4.986 4.986 0 001.429 1.429m-1.43 1.43a3 3 0 014.243-4.243m-4.243 4.243l4.242-4.242'); // Simplifica√ß√£o para mostrar o olho cortado/slashed
                path2.setAttribute('d', 'M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7 1.274-4.057 5.065-7 9.542-7a10.05 10.05 0 011.875.175'); // Ajusta um path para ser mais consistente com o visual de olho fechado
                toggleIcon.setAttribute('title', 'Ocultar Senha');

            }
        }


        // --- FUN√á√ïES DE UTILIDADE E ARMAZENAMENTO (localStorage) ---

        /** Carrega todos os dados do localStorage */
        function loadData() {
            clients = JSON.parse(localStorage.getItem('novan_clients')) || [];
            results = JSON.parse(localStorage.getItem('novan_results')) || [];
            tasks = JSON.parse(localStorage.getItem('novan_tasks')) || [];
        }

        /** Salva todos os dados no localStorage */
        function saveData() {
            localStorage.setItem('novan_clients', JSON.stringify(clients));
            localStorage.setItem('novan_results', JSON.stringify(results));
            localStorage.setItem('novan_tasks', JSON.stringify(tasks));
        }

        /** Exibe uma mensagem de feedback na tela */
        function showMessage(text, duration = 3000, isError = false) {
            const box = document.getElementById('messageBox');
            box.textContent = text;
            box.classList.remove('hidden', 'bg-red-500', 'bg-novan-primary');
            box.classList.add(isError ? 'bg-red-500' : 'bg-novan-primary');
            
            setTimeout(() => {
                box.classList.add('hidden');
            }, duration);
        }

        /** Formata um n√∫mero para moeda BRL (R$ 1.000,00) */
        function formatCurrency(value) {
            // Garante que o valor seja um n√∫mero v√°lido antes de formatar
            const num = parseFloat(value);
            return isNaN(num) ? 'R$ 0,00' : num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        /** * Formata um n√∫mero para o padr√£o brasileiro (1.000,32) sem o s√≠mbolo R$.
         * Usado em contextos onde o R$ √© redundante ou n√£o desejado (ex: cabe√ßalho do PNG).
         */
        function formatValueBRL(value) {
            const num = parseFloat(value);
            if (isNaN(num)) return '0,00';
            
            // 1. Usa toLocaleString para obter o formato monet√°rio pt-BR com 2 casas decimais
            const currencyString = num.toLocaleString('pt-BR', { 
                style: 'currency', 
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });

            // 2. Remove o s√≠mbolo R$ e espa√ßos adjacentes
            // A formata√ß√£o do toLocaleString garante o padr√£o 1.000,32
            return currencyString.replace('R$', '').trim();
        }

        /** Formata um n√∫mero para 2 casas decimais (ROAS) */
        function formatNumber(value) {
            const num = parseFloat(value);
            return isNaN(num) ? '0.00' : num.toFixed(2);
        }
        
        /** Fechad o modal de resumo (usado no Resumo Di√°rio/Quinzenal e Calend√°rio) */
        window.closeSummaryModal = function() {
            document.getElementById('summaryModal').classList.remove('flex');
            document.getElementById('summaryModal').classList.add('hidden');
        }

        /** Utility: Adiciona um offset para garantir que a data YYYY-MM-DD seja lida localmente (Fix Timezone Bug) */
        function getLocalDayDate(dateString) {
            // Adiciona um componente de tempo no meio do dia para garantir que o fuso hor√°rio local n√£o mova a data para o dia anterior.
            // Isso √© um fix comum para inputs type="date" no JS.
            return new Date(dateString + 'T12:00:00'); 
        }


        // --- GEST√ÉO DE TABS ---

        /** Muda a aba ativa na UI */
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tabId}`).classList.add('active');
            
            // A√ß√µes espec√≠ficas ao trocar de aba
            if (tabId === 'clientes') {
                renderClientList();
                // Garante que o formul√°rio de Tr√°fego Pago √© o padr√£o ao entrar na aba
                // showClientFormType('traffic'); // Removido, pois o modal de sele√ß√£o √© o novo padr√£o
                document.getElementById('clientFormContainer').classList.add('hidden'); // Garante que o form comece escondido
            } else if (tabId === 'resultados') {
                populateClientSelects();
                renderResultsTable();
            } else if (tabId === 'calendario') {
                populateClientSelects();
                renderCalendar();
                renderTaskNotifications();
            } else if (tabId === 'gestao') {
                populateClientSelects();
                renderTaskManagement();
            } else if (tabId === 'relatorios') {
                populateClientSelects();
                // O gr√°fico √© gerado sob demanda, mas garante que os clientes estejam na lista
                document.getElementById('noReportData').classList.remove('hidden');
            }
        }

        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', () => switchTab(item.dataset.tab));
        });
        
        // --- ABA 3: CADASTRO DE CLIENTES ---

        /** Abre o modal de sele√ß√£o de tipo de cliente */
        window.openClientTypeSelectionModal = function() {
            document.getElementById('clientTypeSelectionModal').classList.remove('hidden');
            document.getElementById('clientTypeSelectionModal').classList.add('flex');
        }

        /** Fechad o modal de sele√ß√£o de tipo de cliente */
        window.closeClientTypeSelectionModal = function() {
            document.getElementById('clientTypeSelectionModal').classList.add('hidden');
            document.getElementById('clientTypeSelectionModal').classList.remove('flex');
        }

        /** Seleciona o tipo de cliente e abre o formul√°rio */
        window.selectClientType = function(type) {
            closeClientTypeSelectionModal(); // Fechamos o modal
            resetClientForm(); // Limpamos o formul√°rio antes de abrir
            showClientFormType(type); // Configuramos os campos
            document.getElementById('clientFormContainer').classList.remove('hidden'); // Mostramos o formul√°rio
        }

        /** Aplica a m√°scara (00) 00000-0000 ao telefone */
        window.maskPhone = function(input) {
            let value = input.value.replace(/\D/g, ''); // Remove todos os caracteres n√£o num√©ricos

            // Limita a 11 d√≠gitos (incluindo o 9 extra de celular)
            if (value.length > 11) {
                value = value.substring(0, 11);
            }
            
            // Aplica a m√°scara (XX) XXXXX-XXXX
            value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
            value = value.replace(/(\d{5})(\d)/, '$1-$2');

            input.value = value;
        }

        /** Popula o dropdown de Respons√°veis */
        function populateResponsiblesSelect() {
            const select = document.getElementById('cli_responsavel');
            if (!select) return;

            // Limpa e adiciona a op√ß√£o padr√£o
            select.innerHTML = '<option value="">Selecione o Respons√°vel da Ag√™ncia</option>';

            AGENCY_RESPONSIBLES.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        
        /** Alterna a visualiza√ß√£o do formul√°rio entre Tr√°fego Pago e Social Media */
        window.showClientFormType = function(type) {
            const trafficFields = document.getElementById('trafficFields');
            const socialMediaFields = document.getElementById('socialMediaFields');
            const formTitle = document.getElementById('clientFormTitle');
            const cliServiceType = document.getElementById('cli_service_type');

            // Torna campos de tr√°fego n√£o-obrigat√≥rios e de SM n√£o-obrigat√≥rios por padr√£o
            document.getElementById('cli_plataforma_traffic').required = false;
            document.getElementById('cli_budget_type_traffic').required = false;
            document.getElementById('cli_budget_value_traffic').required = false;
            document.getElementById('cli_conversion_goals_traffic').required = false;
            document.getElementById('cli_sm_platform').required = false;
            document.getElementById('cli_sm_fee').required = false;
            document.getElementById('cli_sm_needs').required = false;


            if (type === 'traffic') {
                // Configura√ß√µes para Tr√°fego Pago
                trafficFields.classList.remove('hidden');
                socialMediaFields.classList.add('hidden');
                formTitle.textContent = 'Formul√°rio de Tr√°fego Pago';
                cliServiceType.value = 'traffic';

                // Torna campos de tr√°fego obrigat√≥rios
                document.getElementById('cli_plataforma_traffic').required = true;
                document.getElementById('cli_budget_type_traffic').required = true;
                document.getElementById('cli_budget_value_traffic').required = true;
                document.getElementById('cli_conversion_goals_traffic').required = true;
                
            } else if (type === 'social') {
                // Configura√ß√µes para Social Media
                trafficFields.classList.add('hidden');
                socialMediaFields.classList.remove('hidden');
                formTitle.textContent = 'Formul√°rio de Social Media';
                cliServiceType.value = 'social';

                // Torna campos de SM obrigat√≥rios
                document.getElementById('cli_sm_platform').required = true;
                document.getElementById('cli_sm_fee').required = true;
                document.getElementById('cli_sm_needs').required = true;
            }

            // Garante que o formul√°rio est√° no modo de cadastro ao trocar de tipo
            if (document.getElementById('cli_id_edit').value === "") {
                resetClientForm();
            }
        }
        
        /** Reseta o formul√°rio de cliente para o modo de Cadastro */
        window.resetClientForm = function() {
            document.getElementById('clientForm').reset();
            document.getElementById('cli_id_edit').value = "";
            document.getElementById('clientSubmitButton').textContent = "Cadastrar Cliente";
            document.getElementById('clientCancelButton').classList.add('hidden');
            // Oculta o container do formul√°rio ao resetar
            document.getElementById('clientFormContainer').classList.add('hidden');
        }
        
        /** Carrega os dados do cliente no formul√°rio para edi√ß√£o */
        window.editClient = function(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                return showMessage('Cliente n√£o encontrado.', true);
            }
            
            // 1. Alterna o tipo de formul√°rio e define o ID para edi√ß√£o
            showClientFormType(client.serviceType);
            document.getElementById('cli_id_edit').value = clientId;

            // 2. Popula campos comuns
            document.getElementById('cli_nome').value = client.nome;
            document.getElementById('cli_responsavel').value = client.responsavel;
            document.getElementById('cli_telefone').value = client.telefone;
            document.getElementById('cli_link').value = client.link;
            document.getElementById('cli_observacoes').value = client.observacoes;

            // 3. Popula campos espec√≠ficos
            if (client.serviceType === 'traffic') {
                document.getElementById('cli_plataforma_traffic').value = client.platformTraffic;
                document.getElementById('cli_budget_type_traffic').value = client.budgetType;
                document.getElementById('cli_budget_value_traffic').value = client.budgetValue;
                document.getElementById('cli_conversion_goals_traffic').value = client.conversionGoal;
            } else if (client.serviceType === 'social') {
                document.getElementById('cli_sm_platform').value = client.platformSM;
                document.getElementById('cli_sm_fee').value = client.smFee;
                document.getElementById('cli_sm_needs').value = client.smNeeds;
            }

            // 4. Altera bot√µes de submiss√£o e mostra o container
            document.getElementById('clientSubmitButton').textContent = "Salvar Altera√ß√µes";
            document.getElementById('clientCancelButton').classList.remove('hidden');
            document.getElementById('clientFormContainer').classList.remove('hidden');
            
            showMessage(`Modo de Edi√ß√£o ativado para ${client.nome}.`, false, true);
        }


        /** Renderiza a lista de clientes cadastrados */
        function renderClientList() {
            const listEl = document.getElementById('clientList');
            const noClientsEl = document.getElementById('noClients');
            
            // Checagem de nulidade
            if (!listEl || !noClientsEl) {
                return;
            }

            // Limpa apenas o container dos cards
            listEl.innerHTML = ''; 

            if (clients.length === 0) {
                noClientsEl.classList.remove('hidden');
                return;
            }
            noClientsEl.classList.add('hidden');

            clients.forEach(client => {
                const card = document.createElement('div');
                // Alterado de bg-white para bg-slate-800 e texto para claro
                card.className = 'bg-slate-800 p-4 rounded-xl shadow-md border-t-4 border-novan-primary text-gray-300'; 
                
                let detailListHtml = '';
                let mainPlatformDisplay = '';

                if (client.serviceType === 'traffic') {
                    // Dados de TR√ÅFEGO PAGO
                    const budgetLabel = client.budgetType || 'Or√ßamento';
                    // USANDO formatCurrency POIS √â O DISPLAY COMPLETO
                    const budgetValue = client.budgetValue ? formatCurrency(client.budgetValue) : 'N/A';
                    const goal = client.conversionGoal || 'N/A';
                    mainPlatformDisplay = client.platformTraffic || 'N/A';

                    detailListHtml = `
                        <li><span class="font-medium">${budgetLabel}:</span> ${budgetValue}</li> 
                        <li><span class="font-medium">Meta Principal:</span> ${goal}</li> 
                    `;
                    
                    // Adicionar hist√≥rico de or√ßamento para visualiza√ß√£o
                    if (client.budgetHistory && client.budgetHistory.length > 0) {
                        const latestHistory = client.budgetHistory[client.budgetHistory.length - 1];
                         detailListHtml += `<li title="Or√ßamento anterior: ${latestHistory.type} ${formatCurrency(latestHistory.value)} em ${new Date(latestHistory.date).toLocaleDateString('pt-BR')}" class="text-gray-400 text-xs mt-1">
                            Hist√≥rico (Hover)
                         </li>`;
                    }
                    
                } else if (client.serviceType === 'social') {
                    // Dados de SOCIAL MEDIA
                    // USANDO formatCurrency POIS √â O DISPLAY COMPLETO
                    const feeValue = client.smFee ? formatCurrency(client.smFee) : 'N/A';
                    const smNeeds = client.smNeeds || 'N/A';
                    mainPlatformDisplay = client.platformSM || 'N/A';

                    detailListHtml = `
                        <li><span class="font-medium">Fee Mensal:</span> ${feeValue}</li>
                        <li><span class="font-medium">Foco de Conte√∫do:</span> ${smNeeds}</li>
                    `;
                }

                card.innerHTML = `
                    <h4 class="font-bold text-lg text-white">${client.nome}</h4>
                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${client.serviceType === 'traffic' ? 'bg-purple-200 text-novan-primary' : 'bg-pink-200 text-pink-700'}">
                        ${client.serviceType === 'traffic' ? 'TR√ÅFEGO PAGO' : 'SOCIAL MEDIA'}
                    </span>
                    <p class="text-sm my-2">Respons√°vel: <span class="font-semibold">${client.responsavel}</span></p>
                    <p class="text-sm mb-2">${client.telefone}</p>
                    <ul class="text-xs space-y-1">
                        <li><span class="font-medium">Plataforma:</span> ${mainPlatformDisplay}</li>
                        ${detailListHtml}
                        <li><span class="font-medium">Link:</span> <a href="${client.link}" target="_blank" class="text-indigo-400 hover:underline">${client.link ? 'Acessar' : 'N/A'}</a></li>
                        <li class="mt-2"><span class="font-medium">Nicho/Obs.:</span> ${client.observacoes || 'N/A'}</li>
                    </ul>
                    <div class="flex space-x-3 mt-3">
                        <button onclick="editClient('${client.id}')" class="text-indigo-400 hover:text-indigo-300 text-xs font-semibold">Editar</button>
                        <button onclick="deleteClient('${client.id}')" class="text-red-500 hover:text-red-400 text-xs">Excluir</button>
                    </div>
                `;
                listEl.appendChild(card);
            });
        }

        /** Popula os dropdowns de cliente em todas as abas */
        function populateClientSelects() {
            const selects = [
                document.getElementById('res_cliente'),
                document.getElementById('task_cliente'),
                document.getElementById('filterClient'),
                document.getElementById('report_cliente'),
                document.getElementById('task_manager_filter_client'),
                document.getElementById('results_filter_cliente') // ADICIONADO: Novo filtro de cliente da Aba 1
            ];

            selects.forEach(select => {
                // Checa se o elemento existe antes de tentar manipul√°-lo
                if (!select) return;
                
                const selectedValue = select.value;
                
                // Define o texto da op√ß√£o inicial e se deve ser "Todos os Clientes"
                let initialOptionText = 'Selecione o Cliente';
                if (select.id.includes('filter') || select.id.includes('report') || select.id.includes('manager_filter_client')) {
                    initialOptionText = 'Todos os Clientes';
                }

                // Exce√ß√£o: O filtro de resultados (results_filter_cliente) deve for√ßar a sele√ß√£o de um cliente
                if (select.id === 'results_filter_cliente') {
                    initialOptionText = 'Selecione o Cliente'; 
                }

                // Limpa e adiciona a op√ß√£o padr√£o
                select.innerHTML = `<option value="">${initialOptionText}</option>`;

                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.nome;
                    if (client.id === selectedValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });
        }

        /** L√≥gica de submiss√£o do formul√°rio de cliente (Cadastro ou Edi√ß√£o) */
        document.getElementById('clientForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const clientIdToEdit = document.getElementById('cli_id_edit').value;
            const isEditing = clientIdToEdit !== "";
            const clientIndex = clients.findIndex(c => c.id === clientIdToEdit);
            
            const serviceType = document.getElementById('cli_service_type').value;

            let clientData = isEditing ? clients[clientIndex] : {
                id: crypto.randomUUID(),
                color: generateClientColor(clients.length),
                budgetHistory: [] // Inicializa hist√≥rico de or√ßamento
            };

            // CAMPOS COMUNS
            clientData.serviceType = serviceType;
            clientData.nome = document.getElementById('cli_nome').value;
            clientData.responsavel = document.getElementById('cli_responsavel').value;
            clientData.telefone = document.getElementById('cli_telefone').value;
            clientData.link = document.getElementById('cli_link').value;
            clientData.observacoes = document.getElementById('cli_observacoes').value;
            
            // Guarda valores antigos para compara√ß√£o (apenas para Tr√°fego Pago)
            const oldBudgetType = clientData.budgetType;
            const oldBudgetValue = clientData.budgetValue;


            if (serviceType === 'traffic') {
                // Coleta dados espec√≠ficos de Tr√°fego Pago
                clientData.platformTraffic = document.getElementById('cli_plataforma_traffic').value;
                clientData.budgetType = document.getElementById('cli_budget_type_traffic').value;
                clientData.budgetValue = parseFloat(document.getElementById('cli_budget_value_traffic').value);
                clientData.conversionGoal = document.getElementById('cli_conversion_goals_traffic').value;
                clientData.plataforma = clientData.platformTraffic; 
                
                // L√ìGICA DE HIST√ìRICO DE OR√áAMENTO (Apenas se estiver editando E houver mudan√ßa)
                if (isEditing && (oldBudgetType !== clientData.budgetType || oldBudgetValue !== clientData.budgetValue)) {
                    if (!clientData.budgetHistory) {
                        clientData.budgetHistory = [];
                    }
                    // Adiciona o or√ßamento *antigo* ao hist√≥rico
                    clientData.budgetHistory.push({
                        date: new Date().toISOString(),
                        type: oldBudgetType,
                        value: oldBudgetValue
                    });
                }


            } else if (serviceType === 'social') {
                // Coleta dados espec√≠ficos de Social Media
                clientData.platformSM = document.getElementById('cli_sm_platform').value;
                clientData.smFee = parseFloat(document.getElementById('cli_sm_fee').value);
                clientData.smNeeds = document.getElementById('cli_sm_needs').value;
                clientData.plataforma = clientData.platformSM;
            }

            if (!isEditing) {
                clients.push(clientData);
                showMessage(`Cliente ${clientData.nome} cadastrado com sucesso!`);
            } else {
                clients[clientIndex] = clientData;
                showMessage(`Cliente ${clientData.nome} atualizado com sucesso!`);
                resetClientForm(); // Volta ao modo de cadastro ap√≥s salvar
            }

            saveData();
            // Chamando as fun√ß√µes de renderiza√ß√£o novamente para garantir a atualiza√ß√£o IMEDIATA
            renderClientList(); 
            populateClientSelects();
            document.getElementById('clientForm').reset();
            
            // Reverte para o formul√°rio padr√£o de Tr√°fego Pago
            // showClientFormType('traffic'); // J√° √© tratado pelo resetClientForm
        });

        /** Deleta um cliente e todos os dados associados */
        window.deleteClient = function(clientId) {
            // REMOVIDO 'confirm()' para evitar bloqueio no ambiente. A exclus√£o √© imediata.
            
            clients = clients.filter(c => c.id !== clientId);
            results = results.filter(r => r.clientId !== clientId);
            tasks = tasks.filter(t => t.id !== clientId);
            
            saveData();
            renderClientList();
            populateClientSelects();
            renderResultsTable();
            renderCalendar();
            renderTaskManagement(); // Atualiza a nova aba tamb√©m
            showMessage('Cliente e todos os dados associados exclu√≠dos.', true);
        }
        
        // Fun√ß√£o para gerar uma cor de cliente pseudo-√∫nica
        function generateClientColor(index) {
            const colors = ['#6D28D9', '#059669', '#DC2626', '#FBBF24', '#3B82F6', '#EC4899', '#14B8A6'];
            return colors[index % colors.length];
        }


        // --- ABA 1: RESULTADOS DE CAMPANHAS ---
        
        /** Renderiza os KPI Cards (Agregados) */
        function renderKpiCards(data, summary) {
            const container = document.getElementById('kpiCardsContainer');
            if (!container) return;

            // Se n√£o houver dados, exibe zeros
            const defaultMetrics = { totalGasto: 0, totalFaturamento: 0, avgROAS: 0, avgCPA: 0, avgCPM: 0 };
            const metrics = data.length > 0 ? summary : defaultMetrics;
            
            // CPA e ROAS j√° s√£o calculados no summary

            const kpiCardsHtml = `
                <!-- KPI 1: Gasto Total -->
                <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-red-500">
                    <p class="text-sm font-medium text-gray-400">Gasto Total</p>
                    <p class="text-2xl font-bold text-red-500 mt-1">${formatCurrency(metrics.totalGasto)}</p>
                </div>
                <!-- KPI 2: Faturamento -->
                <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-green-500">
                    <p class="text-sm font-medium text-gray-400">Faturamento</p>
                    <p class="text-2xl font-bold text-green-500 mt-1">${formatCurrency(metrics.totalFaturamento)}</p>
                </div>
                <!-- KPI 3: ROAS M√©dio -->
                <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-yellow-500">
                    <p class="text-sm font-medium text-gray-400">ROAS M√©dio (X)</p>
                    <p class="text-2xl font-bold text-yellow-500 mt-1">${formatNumber(metrics.avgROAS)}X</p>
                </div>
                <!-- KPI 4: CPA M√©dio -->
                <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-indigo-500">
                    <p class="text-sm font-medium text-gray-400">CPA M√©dio (R$)</p>
                    <p class="text-2xl font-bold text-indigo-500 mt-1">${formatCurrency(metrics.avgCPA)}</p>
                </div>
                <!-- KPI 5: CPM M√©dio -->
                <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-blue-500">
                    <p class="text-sm font-medium text-gray-400">CPM M√©dio (R$)</p>
                    <p class="text-2xl font-bold text-blue-500 mt-1">${formatCurrency(metrics.avgCPM)}</p>
                </div>
            `;

            container.innerHTML = kpiCardsHtml;
        }
        
        /** Renderiza os KPI Cards de Resumo Detalhado (Substituto da Tabela) */
        function renderDailySummaryKpis(data) {
            const container = document.getElementById('dailySummaryKpis');
            if (!container) return;

            // Zera o container
            container.innerHTML = '';
            
            // Define o objeto de m√©tricas totais a ser exibido (agregado de todos os resultados filtrados)
            let totalMetrics = {
                investimento: 0,
                vendas: 0,
                impressoes: 0,
                cliques: 0,
                conversionCount: 0,
            };

            if (data.length > 0) {
                totalMetrics = data.reduce((acc, r) => ({
                    investimento: acc.investimento + r.investimento,
                    vendas: acc.vendas + r.vendas,
                    impressoes: acc.impressoes + r.impressoes,
                    cliques: acc.cliques + r.cliques,
                    conversionCount: acc.conversionCount + (r.conversionCount || 0)
                }), totalMetrics);
            }
            
            // Calcula as m√©tricas derivadas do total
            const avgCPA = calculateCPA(totalMetrics.investimento, totalMetrics.conversionCount);
            const avgROAS = calculateROAS(totalMetrics.investimento, totalMetrics.vendas);
            const avgCPM = calculateCPM(totalMetrics.investimento, totalMetrics.impressoes);
            
            // Array de KPIs Detalhados para Inje√ß√£o
            // As cores foram ajustadas para o estilo Novan (roxo, vermelho, verde, etc.)
            const detailedKpis = [
                // Gasto (R$)
                { title: "Gasto (R$)", value: formatCurrency(totalMetrics.investimento), color: 'red-500', icon: 'R$', valueClass: 'text-investimento' },
                // Faturamento (R$)
                { title: "Vendas (R$)", value: formatCurrency(totalMetrics.vendas), color: 'green-500', icon: 'R$', valueClass: 'text-faturamento' },
                // Impress√µes
                { title: "Impress√µes", value: totalMetrics.impressoes.toLocaleString('pt-BR'), color: 'blue-500', icon: 'üëÅÔ∏è', valueClass: 'text-impressoes' },
                // Cliques
                { title: "Cliques", value: totalMetrics.cliques.toLocaleString('pt-BR'), color: 'pink-500', icon: 'üñ±Ô∏è', valueClass: 'text-cliques' },
                // Convers√£o
                { title: "Convers√£o (Total)", value: totalMetrics.conversionCount.toLocaleString('pt-BR'), color: 'novan-primary', icon: '‚úÖ', valueClass: 'text-conversoes' },
                // CPA M√©dio
                { title: "CPA M√©dio (R$)", value: formatCurrency(avgCPA), color: 'yellow-500', icon: 'R$', valueClass: 'text-cpa' },
                // ROAS M√©dio
                { title: "ROAS M√©dio (X)", value: `${formatNumber(avgROAS)}X`, color: 'red-600', icon: '‚¨ÜÔ∏è', valueClass: 'text-roas' },
                // CPM M√©dio
                { title: "CPM M√©dio (R$)", value: formatCurrency(avgCPM), color: 'indigo-500', icon: 'R$', valueClass: 'text-cpm' },
            ];

            const kpisHtml = detailedKpis.map(kpi => `
                <div class="bg-slate-800 p-4 rounded-xl shadow-lg border-l-4 border-${kpi.color}">
                    <p class="text-sm font-medium text-gray-400">${kpi.title}</p>
                    <p class="text-xl font-bold mt-1 ${kpi.valueClass}">${kpi.value}</p>
                </div>
            `).join('');

            container.innerHTML = kpisHtml;
        }


        /** Renderiza os KPIs agregados de todo o per√≠odo filtrado */
        window.renderResultsTable = function() {
            const resultsFilterClient = document.getElementById('results_filter_cliente')?.value;
            const resultsFilterStartDate = document.getElementById('results_filter_start_date')?.value;
            const resultsFilterEndDate = document.getElementById('results_filter_end_date')?.value;
            
            const resultsTable = document.getElementById('resultsTable');
            const dailySummaryKpis = document.getElementById('dailySummaryKpis');
            const loadingSpinner = document.getElementById('resultsLoading');
            const noResultsEl = document.getElementById('noResults');

            // 1. MOSTRA O SPINNER E ESCONDE AS SE√á√ïES
            dailySummaryKpis.classList.add('hidden');
            noResultsEl.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            // Valida√ß√£o: Se o filtro de cliente √© obrigat√≥rio e n√£o foi selecionado, n√£o renderiza
            if (!resultsFilterClient) {
                renderKpiCards([], {}); 
                loadingSpinner.classList.add('hidden');
                noResultsEl.classList.remove('hidden');
                noResultsEl.textContent = "Selecione um Cliente para visualizar as m√©tricas.";
                return;
            }
            
            // Simula um atraso de carregamento de 500ms
            setTimeout(() => {
                
                // Filtra apenas resultados de clientes de TR√ÅFEGO PAGO
                const trafficClientsIds = clients.filter(c => c.serviceType === 'traffic' || !c.serviceType).map(c => c.id);
                let filteredResults = results.filter(r => trafficClientsIds.includes(r.clientId));

                // 1. Aplica Filtro de Cliente (J√Å SABEMOS QUE resultsFilterClient TEM VALOR)
                filteredResults = filteredResults.filter(r => r.clientId === resultsFilterClient);
                

                // 2. Aplica Filtro de Data
                if (resultsFilterStartDate) {
                    filteredResults = filteredResults.filter(r => r.data >= resultsFilterStartDate);
                }
                if (resultsFilterEndDate) {
                    filteredResults = filteredResults.filter(r => r.data <= resultsFilterEndDate);
                }

                // --- C√ÅLCULO DAS M√âTRICAS DE RESUMO (Geral) ---
                let summaryMetrics = {
                    totalGasto: 0, totalFaturamento: 0, totalConversoes: 0, totalImpressoes: 0,
                    avgROAS: 0, avgCPA: 0, avgCPM: 0
                };

                if (filteredResults.length > 0) {
                    summaryMetrics = filteredResults.reduce((acc, r) => {
                        acc.totalGasto += r.investimento;
                        acc.totalFaturamento += r.vendas;
                        acc.totalConversoes += r.conversionCount || 0;
                        acc.totalImpressoes += r.impressoes;
                        return acc;
                    }, summaryMetrics);

                    summaryMetrics.avgCPA = calculateCPA(summaryMetrics.totalGasto, summaryMetrics.totalConversoes);
                    summaryMetrics.avgROAS = calculateROAS(summaryMetrics.totalGasto, summaryMetrics.totalFaturamento);
                    summaryMetrics.avgCPM = calculateCPM(summaryMetrics.totalGasto, summaryMetrics.totalImpressoes);
                }
                
                // RENDERIZA√á√ÉO DOS KPI CARDS AGREGADOS (Topo)
                renderKpiCards(filteredResults, summaryMetrics);
                
                // RENDERIZA√á√ÉO DOS KPI CARDS DETALHADOS (Substituto da Tabela)
                renderDailySummaryKpis(filteredResults);
                
                // 3. ESCONDE O SPINNER
                loadingSpinner.classList.add('hidden');
                
                if (filteredResults.length === 0) {
                    noResultsEl.textContent = "Nenhum resultado encontrado para o cliente e per√≠odo selecionados.";
                    noResultsEl.classList.remove('hidden');
                    return;
                }
                
                // 4. MOSTRA O NOVO CONTAINER DE KPIS DETALHADOS
                dailySummaryKpis.classList.remove('hidden');

            }, 500); // Atraso de 500ms
        }
        
        /** Deleta um registro de resultado */
        window.deleteResult = function(resultId) {
            // Removido 'confirm()'
            results = results.filter(r => r.id !== resultId);
            saveData();
            renderResultsTable();
            showMessage('Registro exclu√≠do.', true);
        }

        /** Calcula o Custo por Aquisi√ß√£o (CPA) */
        function calculateCPA(gasto, aquisicoes) {
            // CPA = Gasto / Total de Aquisi√ß√µes (Convers√µes)
            if (aquisicoes === 0 || gasto === 0) return 0;
            return gasto / aquisicoes;
        }

        /** Calcula o Retorno sobre o Investimento (ROAS) */
        function calculateROAS(investimento, vendas) {
            if (investimento === 0) return 0;
            return vendas / investimento;
        }
        
        /** Calcula o Custo por Mil Impress√µes (CPM) */
        function calculateCPM(investimento, impressoes) {
            if (impressoes === 0 || investimento === 0) return 0;
            return (investimento / impressoes) * 1000;
        }


        /** L√≥gica para c√°lculo em tempo real do CPA/ROAS/CPM no formul√°rio */
        function updateMetricsDisplay() {
            const investimento = parseFloat(document.getElementById('res_investimento').value) || 0;
            const vendas = parseFloat(document.getElementById('res_vendas').value) || 0;
            const impressoes = parseInt(document.getElementById('res_impressoes').value) || 0; // Adicionado Impress√µes
            const conversionCount = parseInt(document.getElementById('res_conversion_count').value) || 0; // NOVO: Total de Convers√µes

            const cpa = calculateCPA(investimento, conversionCount); // ATUALIZADO: Usando conversionCount
            const roas = calculateROAS(investimento, vendas);
            const cpm = calculateCPM(investimento, impressoes); // NOVO CPM

            // USANDO formatValueBRL para o formato 1.000,32 (sem R$)
            document.getElementById('cpa_calc').textContent = formatValueBRL(cpa);
            document.getElementById('roas_calc').textContent = formatNumber(roas);
            document.getElementById('cpm_calc').textContent = formatValueBRL(cpm);
        }

        document.getElementById('res_investimento').addEventListener('input', updateMetricsDisplay);
        document.getElementById('res_vendas').addEventListener('input', updateMetricsDisplay);
        document.getElementById('res_impressoes').addEventListener('input', updateMetricsDisplay);
        document.getElementById('res_conversion_count').addEventListener('input', updateMetricsDisplay); // Adicionado listener para convers√µes


        /** L√≥gica de submiss√£o do formul√°rio de resultados */
        document.getElementById('campaignForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const investimento = parseFloat(document.getElementById('res_investimento').value);
            const vendas = parseFloat(document.getElementById('res_vendas').value);
            const impressoes = parseInt(document.getElementById('res_impressoes').value); // Obt√©m Impress√µes
            const conversionCount = parseInt(document.getElementById('res_conversion_count').value || 0); // Obt√©m Total de Convers√µes

            const newResult = {
                id: crypto.randomUUID(),
                data: document.getElementById('res_data').value,
                clientId: document.getElementById('res_cliente').value,
                plataforma: document.getElementById('res_plataforma').value,
                investimento: investimento,
                impressoes: impressoes, // Salva Impress√µes
                alcance: parseInt(document.getElementById('res_alcance').value),
                cliques: parseInt(document.getElementById('res_cliques').value),
                
                // Novos campos unificados de convers√£o
                conversionType: document.getElementById('res_conversion_type').value,
                conversionCount: conversionCount,

                vendas: vendas,
                cpa: calculateCPA(investimento, conversionCount), // ATUALIZADO: Usando conversionCount
                roas: calculateROAS(investimento, vendas),
                cpm: calculateCPM(investimento, impressoes), // NOVO CPM SALVO
                observacoes: document.getElementById('res_observacoes').value,
            };

            results.push(newResult);
            saveData();
            renderResultsTable();
            document.getElementById('campaignForm').reset();
            updateMetricsDisplay(); // Limpa os campos de c√°lculo
            showMessage(`Resultado de ${newResult.plataforma} em ${new Date(newResult.data).toLocaleDateString('pt-BR')} registrado!`);
        });

        /** Gera resumo di√°rio */
        document.getElementById('btnResumoDiario').addEventListener('click', () => {
            const today = new Date().toISOString().split('T')[0];
            const dailyResults = results.filter(r => r.data === today);

            if (dailyResults.length === 0) {
                return showMessage('Nenhum registro encontrado para hoje.', true);
            }

            let html = '<ul class="space-y-3">';
            dailyResults.forEach(r => {
                const clientName = clients.find(c => c.id === r.clientId)?.nome || 'Desconhecido';
                
                // Novos campos de convers√£o unificados
                const conversionType = r.conversionType || 'N/D';
                const conversionCount = r.conversionCount || 0;

                html += `
                    <li class="p-3 border rounded-lg bg-gray-700">
                        <p class="font-bold text-lg text-novan-primary">${clientName} (${r.plataforma})</p>
                        <p>Gasto: <span class="font-semibold">${formatCurrency(r.investimento)}</span></p>
                        <p>Vendas/Faturamento: <span class="font-semibold">${formatCurrency(r.vendas)}</span></p>
                        
                        <!-- NOVO DETALHE CPM -->
                        <p>CPM: <span class="font-bold text-blue-500">${formatCurrency(r.cpm)}</span></p>
                        <!-- FIM NOVO DETALHE CPM -->

                        <!-- NOVO DETALHE DE CONVERS√ÉO -->
                        <p>Convers√µes (${conversionType}): <span class="font-semibold">${conversionCount.toLocaleString('pt-BR')}</span></p>
                        <!-- FIM NOVO DETALHE -->
                        
                        <p>CPA: <span class="font-bold text-red-500">${formatCurrency(r.cpa)}</span> | ROAS: <span class="font-bold text-green-500">${formatNumber(r.roas)}</span></p>
                        <p class="text-xs text-gray-400 mt-1">Obs: ${r.observacoes || 'N/A'}</p>
                    </li>
                `;
            });
            html += '</ul>';

            openSummaryModal('Resumo Di√°rio - ' + new Date().toLocaleDateString('pt-BR'), html);
        });

        /** Gera resumo quinzenal */
        document.getElementById('btnResumoQuinzenal').addEventListener('click', () => {
            const today = new Date();
            const date15DaysAgo = new Date(today);
            date15DaysAgo.setDate(today.getDate() - 15);

            const thisPeriod = results.filter(r => new Date(r.data) >= date15DaysAgo && new Date(r.data) <= today);
            
            // Per√≠odo anterior (16 a 30 dias atr√°s)
            const date30DaysAgo = new Date(today);
            date30DaysAgo.setDate(today.getDate() - 30);
            const lastPeriod = results.filter(r => new Date(r.data) >= date30DaysAgo && new Date(r.data) < date15DaysAgo);

            const summarize = (data) => {
                return data.reduce((acc, r) => {
                    const clientId = r.clientId;
                    if (!acc[clientId]) {
                        acc[clientId] = { investimento: 0, vendas: 0, totalConversions: 0, impressoes: 0, roasSum: 0, roasCount: 0, cpmSum: 0, cpmCount: 0, count: 0 };
                    }
                    acc[clientId].investimento += r.investimento;
                    acc[clientId].vendas += r.vendas;
                    acc[clientId].totalConversions += r.conversionCount || 0; // totalConversions is available
                    acc[clientId].impressoes += r.impressoes; // Adicionado Impress√µes
                    acc[clientId].roasSum += r.roas;
                    acc[clientId].roasCount += r.roas > 0 ? 1 : 0;
                    acc[clientId].cpmSum += r.cpm; // Adicionado CPM
                    acc[clientId].cpmCount += r.cpm > 0 ? 1 : 0; // Adicionado contagem CPM
                    acc[clientId].count += 1;
                    return acc;
                }, {});
            };

            const summaryThis = summarize(thisPeriod);
            const summaryLast = summarize(lastPeriod);
            
            let html = '<div class="space-y-4">';

            if (Object.keys(summaryThis).length === 0) {
                 html = '<p>Nenhum dado encontrado nos √∫ltimos 15 dias.</p>';
            } else {
                Object.keys(summaryThis).forEach(clientId => {
                    const clientName = clients.find(c => c.id === clientId)?.nome || 'Desconhecido';
                    const sThis = summaryThis[clientId];
                    const sLast = summaryLast[clientId] || { investimento: 0, vendas: 0, totalConversions: 0, impressoes: 0, roasSum: 0, roasCount: 0, cpmSum: 0, cpmCount: 0 };
                    
                    const roasThis = sThis.roasCount > 0 ? sThis.roasSum / sThis.roasCount : 0;
                    const roasLast = sLast.roasCount > 0 ? sLast.roasSum / sLast.roasCount : 0;
                    
                    const cpmAvgThis = sThis.cpmCount > 0 ? sThis.cpmSum / sThis.cpmCount : 0; // NOVO CPM M√©dio
                    const cpmAvgLast = sLast.cpmCount > 0 ? sLast.cpmSum / sLast.cpmCount : 0; // NOVO CPM M√©dio Anterior
                    
                    const percentChange = (current, previous) => previous === 0 ? (current > 0 ? '+‚àû' : '0%') : ((current - previous) / previous * 100).toFixed(1) + '%';
                    
                    html += `
                        <div class="bg-gray-700 p-4 rounded-lg shadow border-l-4 border-novan-primary">
                            <h4 class="font-bold text-xl mb-2 text-white">${clientName}</h4>
                            <p><strong>Per√≠odo Atual (15 dias):</strong></p>
                            <ul class="ml-4 list-disc text-sm">
                                <li>Gasto: ${formatCurrency(sThis.investimento)} 
                                    <span class="text-xs ${parseFloat(percentChange(sThis.investimento, sLast.investimento)) > 0 ? 'text-red-500' : 'text-green-500'}">(${percentChange(sThis.investimento, sLast.investimento)})</span>
                                </li>
                                <li>Faturamento: ${formatCurrency(sThis.vendas)} 
                                    <span class="text-xs ${parseFloat(percentChange(sThis.vendas, sLast.vendas)) > 0 ? 'text-green-500' : 'text-red-500'}">(${percentChange(sThis.vendas, sLast.vendas)})</span>
                                </li>
                                <li>ROAS M√©dio: ${formatNumber(roasThis)}X 
                                    <span class="text-xs ${parseFloat(percentChange(roasThis, roasLast)) > 0 ? 'text-green-500' : 'text-red-500'}">(${percentChange(roasThis, roasLast)})</span>
                                </li>
                                <!-- NOVO CPM M√âDIO -->
                                <li>CPM M√©dio: ${formatCurrency(cpmAvgThis)} 
                                    <span class="text-xs ${parseFloat(percentChange(cpmAvgThis, cpmAvgLast)) > 0 ? 'text-red-500' : 'text-green-500'}">(${percentChange(cpmAvgThis, cpmAvgLast)})</span>
                                </li>
                                <!-- FIM NOVO CPM M√âDIO -->
                                <li>Convers√µes (Total): ${sThis.totalConversions}</li>
                            </ul>
                            <p class="text-xs text-gray-400 mt-2">Comparativo com os 15 dias anteriores.</p>
                        </div>
                    `;
                });
            }

            html += '</div>';

            openSummaryModal('Resumo Quinzenal (√öltimos 15 Dias)', html);
        });

        /** Abre o modal de resumo */
        function openSummaryModal(title, content) {
            document.getElementById('summaryTitle').textContent = title;
            document.getElementById('summaryContent').innerHTML = content;
            document.getElementById('summaryModal').classList.remove('hidden');
            document.getElementById('summaryModal').classList.add('flex');
        }


        // --- ABA 2: CALEND√ÅRIO DE TAREFAS ---
        
        /** Exibe um resumo de todas as tarefas para um dia espec√≠fico ao clicar no dia do calend√°rio. */
        window.showDaySummary = function(dateString) {
            const dateObj = getLocalDayDate(dateString); // Usando a nova fun√ß√£o para evitar erros de timezone
            
            // Filtra as tarefas para o dia clicado
            const dayTasks = tasks.filter(t => t.date.startsWith(dateString));

            const title = `Resumo de Tarefas: ${dateObj.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' })}`;

            if (dayTasks.length === 0) {
                const content = `<p class="text-center text-gray-400">Nenhuma tarefa agendada para este dia.</p>`;
                return openSummaryModal(title, content);
            }

            let contentHtml = '<div class="space-y-3">';
            dayTasks.forEach(task => {
                const client = clients.find(c => c.id === task.clientId);
                const clientName = client?.nome || 'Cliente N/D';
                const taskTime = new Date(task.date).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                // Define a cor de acordo com o status
                const statusColor = task.status === 'Concluido' ? 'text-green-500' : 
                                    task.status === 'Em Andamento' ? 'text-yellow-500' : 'text-red-500';
                
                contentHtml += `
                    <div class="p-3 border rounded-lg shadow-sm bg-gray-700">
                        <p class="font-bold text-white">${clientName} - ${task.type}</p>
                        <p class="text-sm font-semibold">${taskTime} <span class="${statusColor}">(${task.status})</span></p>
                        <p class="text-xs text-gray-400 italic mt-1">Obs: ${task.observacoes || 'Sem observa√ß√µes.'}</p>
                    </div>
                `;
            });
            contentHtml += '</div>';

            openSummaryModal(title, contentHtml);
        }

        /** Renderiza o calend√°rio (M√™s Atual) */
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            document.getElementById('currentMonthYear').textContent = currentMonth.toLocaleDateString('pt-BR', { year: 'numeric', month: 'long' });

            const today = new Date();
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const startingDay = firstDayOfMonth.getDay(); // 0 (Dom) a 6 (S√°b)

            // Preencher dias vazios no in√≠cio
            for (let i = 0; i < startingDay; i++) {
                grid.innerHTML += '<div class="calendar-day p-2 text-gray-600"></div>'; // Mantido cinza escuro para os dias fora do m√™s
            }

            // Renderizar dias do m√™s
            for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                const isToday = date.toDateString() === today.toDateString();
                
                // OTIMIZA√á√ÉO: Filtra tasks apenas para o dia em quest√£o
                const dayTasks = tasks.filter(t => t.date.startsWith(dateString));
                
                let tasksHtml = '';
                dayTasks.forEach(task => {
                    const client = clients.find(c => c.id === task.clientId);
                    const clientName = client?.nome || 'N/D'; // Nome completo
                    
                    // Define a cor de acordo com o status
                    let statusColorClass = 'bg-gray-700/50'; // Cor de fundo padr√£o
                    if (task.status === 'Concluido') statusColorClass = 'bg-green-700/70';
                    else if (task.status === 'Em Andamento') statusColorClass = 'bg-yellow-700/70';
                    else if (task.status === 'Pendente') statusColorClass = 'bg-red-700/70';

                    // A tarefa agora s√≥ mostra o nome do cliente e usa a cor baseada no status
                    tasksHtml += `
                        <div class="task-item text-white shadow-sm px-1 py-0.5 rounded text-xs truncate ${statusColorClass}" title="${clientName} - ${task.type} (${task.status})">
                            ${clientName}
                        </div>
                    `;
                });

                // A CLIQUE J√Å ESTAVA IMPLEMENTADA AQUI
                grid.innerHTML += `
                    <div class="calendar-day p-2 rounded-lg ${isToday ? 'bg-novan-primary text-white shadow-lg' : 'hover:bg-slate-700'}" onclick="showDaySummary('${dateString}')">
                        <div class="font-bold mb-1 ${isToday ? 'text-white' : 'text-gray-300'}">${day}</div>
                        ${tasksHtml}
                    </div>
                `;
            }
        }

        /** Manipuladores de navega√ß√£o do calend√°rio */
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        });

        /** L√≥gica de submiss√£o do formul√°rio de tarefas */
        document.getElementById('taskForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const newTask = {
                id: crypto.randomUUID(),
                clientId: document.getElementById('task_cliente').value,
                type: document.getElementById('task_tipo').value,
                date: document.getElementById('task_data').value, // Formato YYYY-MM-DDTHH:MM
                status: document.getElementById('task_status').value,
                observacoes: document.getElementById('task_observacoes').value,
                completionDate: null, // Novo campo
            };

            tasks.push(newTask);
            saveData();
            renderCalendar();
            renderTaskNotifications();
            renderTaskManagement(); // Atualiza a nova aba
            document.getElementById('taskForm').reset();
            showMessage('Tarefa agendada com sucesso!');
        });
        
        /** Renderiza as notifica√ß√µes de tarefas pr√≥ximas (pr√≥ximos 7 dias) */
        function renderTaskNotifications() {
            const notificationBox = document.getElementById('taskNotifications');
            const list = document.getElementById('notificationList');
            list.innerHTML = '';
            
            const now = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(now.getDate() + 7);

            // OTIMIZA√á√ÉO: Filtra tarefas em uma √∫nica passagem
            const upcomingTasks = tasks.filter(t => {
                const taskDate = new Date(t.date);
                return taskDate >= now && taskDate <= nextWeek && t.status !== 'Concluido';
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            if (upcomingTasks.length === 0) {
                notificationBox.classList.add('hidden');
                return;
            }

            notificationBox.classList.remove('hidden');

            upcomingTasks.forEach(task => {
                const clientName = clients.find(c => c.id === task.clientId)?.nome || 'N/D';
                const taskDate = new Date(task.date);
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="font-semibold">${clientName}</span>: ${task.type} 
                    em ${taskDate.toLocaleDateString('pt-BR')} √†s ${taskDate.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})} 
                    <span class="text-xs text-gray-400">(${task.status})</span>
                `;
                list.appendChild(li);
            });
        }

        // --- ABA 5: GEST√ÉO DE TAREFAS (KANBAN) ---
        
        // Fun√ß√£o para fechar o modal de detalhes da tarefa
        window.closeTaskDetailModal = function() {
            document.getElementById('taskDetailModal').classList.add('hidden');
            document.getElementById('taskDetailModal').classList.remove('flex');
        }

        // Fun√ß√£o para abrir o modal de detalhes
        window.openTaskDetailModal = function(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return showMessage('Tarefa n√£o encontrada.', true);

            const client = clients.find(c => c.id === task.clientId);
            const clientName = client?.nome || 'Cliente N/D';
            
            const taskDateTime = new Date(task.date).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
            
            // Define a cor de acordo com o status
            let statusColorClass = 'text-gray-400';
            if (task.status === 'Concluido') statusColorClass = 'text-green-500';
            else if (task.status === 'Em Andamento') statusColorClass = 'text-yellow-500';
            else if (task.status === 'Pendente') statusColorClass = 'text-red-500';
            
            // Preenche o modal
            document.getElementById('modalTaskId').value = taskId;
            document.getElementById('modalTaskTitle').textContent = `${clientName} - ${task.type}`;
            document.getElementById('modalClientName').textContent = clientName;
            document.getElementById('modalTaskType').textContent = task.type;
            document.getElementById('modalTaskDate').textContent = taskDateTime;
            
            const statusEl = document.getElementById('modalTaskStatus');
            statusEl.textContent = task.status;
            statusEl.className = `font-semibold ${statusColorClass}`;
            
            document.getElementById('modalTaskObs').textContent = task.observacoes || 'Nenhuma observa√ß√£o detalhada.';
            
            // Define o valor do dropdown de status no modal
            document.getElementById('modalStatusSelect').value = task.status;
            
            // Atribui a fun√ß√£o de edi√ß√£o ao bot√£o (simula a abertura da aba de cadastro)
            document.getElementById('modalEditButton').onclick = () => {
                // Fechamos este modal
                closeTaskDetailModal();
                // Alternamos para a aba de cadastro
                switchTab('calendario'); 
                // Preenchemos o form da aba 'calendario' com os dados da tarefa para edi√ß√£o
                // (Isso requer uma fun√ß√£o de preenchimento no form de cadastro de tarefas, que pode ser adicionada se necess√°rio)
                showMessage('Implementar edi√ß√£o direta no formul√°rio de cadastro de tarefas.', false, true);
            };

            // Exibe o modal
            document.getElementById('taskDetailModal').classList.remove('hidden');
            document.getElementById('taskDetailModal').classList.add('flex');
        }

        // Fun√ß√£o para aplicar a mudan√ßa de status a partir do modal
        window.applyStatusChange = function() {
            const taskId = document.getElementById('modalTaskId').value;
            const newStatus = document.getElementById('modalStatusSelect').value;
            updateTaskStatus(taskId, newStatus);
            closeTaskDetailModal();
        }

        /** Atualiza o status de uma tarefa e salva/renderiza */
        window.updateTaskStatus = function(taskId, newStatus) {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                
                // L√ìGICA DE REGISTRO DE DATA DE CONCLUS√ÉO
                if (newStatus === 'Concluido') {
                    tasks[taskIndex].completionDate = new Date().toISOString();
                } else {
                    tasks[taskIndex].completionDate = null; // Limpa se for reaberta
                }
                
                tasks[taskIndex].status = newStatus;
                
                saveData();
                renderCalendar(); 
                renderTaskManagement(); 
                showMessage(`Status da tarefa atualizado para: ${newStatus}`);
            }
        }

        /** Renderiza o painel de gest√£o de tarefas (Kanban-like) */
        window.renderTaskManagement = function() {
            const boardEl = document.getElementById('taskManagementBoard');
            const noTasksMessageEl = document.getElementById('noTasksMessage');
            
            if (!boardEl || !noTasksMessageEl) return;

            boardEl.innerHTML = '';
            
            const filterClientId = document.getElementById('task_manager_filter_client').value;
            const filterStatus = document.getElementById('task_manager_filter_status').value;

            // OTIMIZA√á√ÉO: Filtra tarefas em uma √∫nica passagem
            let filteredTasks = tasks.filter(t => {
                const clientMatch = !filterClientId || t.clientId === filterClientId;
                const statusMatch = !filterStatus || t.status === filterStatus;
                return clientMatch && statusMatch;
            }).sort((a, b) => new Date(a.date) - new Date(b.date)); // Ordena por data

            if (filteredTasks.length === 0) {
                noTasksMessageEl.classList.remove('hidden');
                return;
            }
            noTasksMessageEl.classList.add('hidden');


            const statusGroups = {
                'Pendente': [],
                'Em Andamento': [],
                'Concluido': []
            };
            
            // Reagrupar tarefas
            filteredTasks.forEach(task => {
                if (statusGroups[task.status]) {
                    statusGroups[task.status].push(task);
                }
            });

            const allStatuses = ['Pendente', 'Em Andamento', 'Concluido'];
            const statusesToShow = filterStatus ? [filterStatus] : allStatuses;
            
            const statusColors = {
                'Pendente': { bg: 'bg-red-900/50', text: 'text-red-300', border: 'border-red-500' }, // Darker background
                'Em Andamento': { bg: 'bg-yellow-900/50', text: 'text-yellow-300', border: 'border-yellow-500' }, // Darker background
                'Concluido': { bg: 'bg-green-900/50', text: 'text-green-300', border: 'border-green-500' } // Darker background
            };

            statusesToShow.forEach(status => {
                const tasksInGroup = statusGroups[status] || [];
                const { bg, text, border } = statusColors[status];
                
                let taskCardsHtml = tasksInGroup.map(task => {
                    const client = clients.find(c => c.id === task.clientId);
                    const clientName = client?.nome || 'Cliente N/D';
                    const taskDateTime = new Date(task.date).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });

                    // Exibir data de conclus√£o
                    let completionInfo = '';
                    if (task.status === 'Concluido' && task.completionDate) {
                        const completeDate = new Date(task.completionDate).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
                        completionInfo = `<p class="text-xs text-green-500 font-medium mt-1">Conclu√≠da em: ${completeDate}</p>`;
                    }

                    return `
                        <div class="bg-gray-700 p-4 rounded-lg shadow-md border-t-2 ${border} space-y-2 text-gray-300 cursor-pointer hover:bg-gray-600 transition" 
                             onclick="openTaskDetailModal('${task.id}')">
                            <p class="font-semibold text-sm text-white">${clientName} - ${task.type}</p>
                            <p class="text-xs text-gray-400">Prazo: ${taskDateTime}</p>
                            <p class="text-xs italic text-gray-400">${task.observacoes.substring(0, 50)}...</p>
                            ${completionInfo}
                            <div class="flex justify-end pt-2">
                                <button onclick="event.stopPropagation(); deleteTask('${task.id}');" class="text-red-500 hover:text-red-400 text-xs font-semibold">Excluir</button>
                            </div>
                        </div>
                    `;
                }).join('');

                const column = document.createElement('div');
                column.className = `${bg} p-4 rounded-xl shadow-inner border-t-4 ${border}`;
                column.innerHTML = `
                    <h3 class="text-xl font-bold mb-4 ${text}">${status} (${tasksInGroup.length})</h3>
                    <div class="space-y-4 min-h-[50px]">
                        ${taskCardsHtml || `<p class="text-center text-sm italic ${text}">Nenhuma tarefa neste status.</p>`}
                    </div>
                `;
                boardEl.appendChild(column);
            });
        }
        
        /** Deleta uma tarefa espec√≠fica (Adicionado para completar a funcionalidade do Kanban) */
        window.deleteTask = function(taskId) {
            // Removido 'confirm()'
            tasks = tasks.filter(t => t.id !== taskId);
            saveData();
            renderCalendar();
            renderTaskNotifications();
            renderTaskManagement();
            showMessage('Tarefa exclu√≠da.', true);
        }

        // --- ABA 4: RELAT√ìRIOS E INSIGHTS (Chart.js) ---

        /** Inicializa um Chart.js (destr√≥i o anterior se existir) */
        function initChart(chartId, type, data, options) {
            const canvas = document.getElementById(chartId);
            // Destr√≥i a inst√¢ncia anterior para evitar duplicidade
            const existingChart = Chart.getChart(chartId);
            if (existingChart) {
                existingChart.destroy();
            }
            return new Chart(canvas, { type, data, options });
        }

        /** Gera os dados e gr√°ficos do relat√≥rio */
        window.generateReport = function() {
            const clientId = document.getElementById('report_cliente').value;
            const startDate = document.getElementById('report_start_date').value;
            const endDate = document.getElementById('report_end_date').value;

            // Filtra os resultados
            let filteredResults = results;
            if (clientId) {
                filteredResults = filteredResults.filter(r => r.clientId === clientId);
            }
            if (startDate) {
                filteredResults = filteredResults.filter(r => r.data >= startDate);
            }
            if (endDate) {
                filteredResults = filteredResults.filter(r => r.data <= endDate);
            }
            
            if (filteredResults.length === 0) {
                document.getElementById('noReportData').classList.remove('hidden');
                document.getElementById('chartsContainer').querySelectorAll('canvas').forEach(c => c.style.display = 'none');
                reportSummaryMetrics = null; // Limpa o resumo
                reportDetailedResults = []; // Limpa detalhes
                return showMessage('Nenhum dado encontrado para os filtros selecionados.', true);
            }

            document.getElementById('noReportData').classList.add('hidden');
            document.getElementById('chartsContainer').querySelectorAll('canvas').forEach(c => c.style.display = 'block');
            
            // Agrupar e somar os dados por dia (para o eixo X)
            const groupedData = filteredResults.reduce((acc, r) => {
                if (!acc[r.data]) {
                    acc[r.data] = { investimento: 0, faturamento: 0, impressoes: 0, cliques: 0, roasSum: 0, roasCount: 0, conversionCount: 0 }; // Adicionado conversionCount
                }
                acc[r.data].investimento += r.investimento;
                acc[r.data].faturamento += r.vendas;
                acc[r.data].impressoes += r.impressoes;
                acc[r.data].cliques += r.cliques;
                acc[r.data].roasSum += r.roas;
                acc[r.data].roasCount += r.roas > 0 ? 1 : 0;
                acc[r.data].conversionCount += r.conversionCount; // Adicionado conversionCount
                return acc;
            }, {});

            const sortedDates = Object.keys(groupedData).sort();

            // SALVA OS DETALHES ORDENADOS PARA EXPORTA√á√ÉO EM TEXTO
            reportDetailedResults = filteredResults.sort((a, b) => new Date(a.data) - new Date(b.data));

            // CORRE√á√ÉO DE DATA: Usando a fun√ß√£o getLocalDayDate para evitar o bug de timezone
            const reportLabels = sortedDates.map(d => getLocalDayDate(d).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
            const invData = sortedDates.map(d => groupedData[d].investimento);
            const fatData = sortedDates.map(d => groupedData[d].faturamento);
            const imprData = sortedDates.map(d => groupedData[d].impressoes);
            const cliquesData = sortedDates.map(d => groupedData[d].cliques);
            const roasData = sortedDates.map(d => groupedData[d].roasCount > 0 ? groupedData[d].roasSum / groupedData[d].roasCount : 0);
            
            // NOVO: C√°lculo das M√©tricas de Resumo
            const totalGasto = filteredResults.reduce((sum, r) => sum + r.investimento, 0);
            const totalFaturamento = filteredResults.reduce((sum, r) => sum + r.vendas, 0);
            const totalConversoes = filteredResults.reduce((sum, r) => sum + (r.conversionCount || 0), 0);
            const totalImpressoes = filteredResults.reduce((sum, r) => sum + r.impressoes, 0);
            
            const avgROAS = calculateROAS(totalGasto, totalFaturamento);
            const avgCPA = calculateCPA(totalGasto, totalConversoes);
            const avgCPM = calculateCPM(totalGasto, totalImpressoes);
            
            // Determina o nome do cliente para o t√≠tulo do relat√≥rio
            const clientNameForReport = clientId 
                ? clients.find(c => c.id === clientId)?.nome || 'Cliente Desconhecido'
                : 'Todos os Clientes'; // Se nenhum cliente for selecionado

            reportSummaryMetrics = {
                totalGasto: totalGasto,
                totalFaturamento: totalFaturamento,
                avgROAS: avgROAS,
                avgCPA: avgCPA,
                avgCPM: avgCPM,
                clientName: clientNameForReport, // ADICIONADO: Nome do cliente para o cabe√ßalho PNG
                // Garantindo que a string de per√≠odo √© baseada nos r√≥tulos gerados
                period: reportLabels.length > 0 ? `${reportLabels[0]} a ${reportLabels[reportLabels.length - 1]}` : 'N/A',
                // Data de Gera√ß√£o - CORRIGIDO: Usando toLocaleString para incluir data e hora
                generationDate: new Date().toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' })
            };


            // Usando setTimeout para garantir que o navegador calculou o tamanho do canvas
            // antes de o Chart.js tentar desenhar.
            // ... (restante da l√≥gica do gr√°fico)
            
            setTimeout(() => {
                
                // Op√ß√µes para tornar as barras mais finas
                const barChartOptions = {
                    responsive: true,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: '#334155' }, // Cor da grade escura
                            ticks: { color: '#E2E8F0' } // Cor dos r√≥tulos
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#E2E8F0' } // Cor dos r√≥tulos
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#E2E8F0' } } // Cor da legenda
                    },
                    // Op√ß√µes para reduzir a espessura das barras
                    datasets: { 
                        bar: {
                            categoryPercentage: 0.6, // Espa√ßo entre grupos de barras
                            barPercentage: 0.8 // Espessura individual das barras
                        }
                    }
                };
                
                // 1. Gr√°fico de Gasto vs Faturamento (BARRA)
                invFatChartInstance = initChart('investimentoFaturamentoChart', 'bar', {
                    labels: reportLabels,
                    datasets: [
                        {
                            label: 'Gasto (R$)',
                            data: invData,
                            backgroundColor: COLORS.investimento,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Faturamento (R$)',
                            data: fatData,
                            backgroundColor: COLORS.faturamento,
                            yAxisID: 'y'
                        }
                    ]
                }, barChartOptions);

                // 2. Gr√°fico de Impress√µes vs Cliques (BARRA)
                imprCliquesChartInstance = initChart('impressoesCliquesChart', 'bar', { 
                    labels: reportLabels,
                    datasets: [
                        {
                            label: 'Impress√µes',
                            data: imprData,
                            backgroundColor: COLORS.impressoes, // Blue 500
                        },
                        {
                            label: 'Cliques',
                            data: cliquesData,
                            backgroundColor: COLORS.cliques, // Pink 500
                        }
                    ]
                }, barChartOptions);

                // NOVO: Op√ß√µes para Gr√°fico de Linha (ROAS)
                const lineChartOptions = {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { color: '#E2E8F0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#E2E8F0' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#E2E8F0' } }
                    },
                    elements: {
                        line: {
                            tension: 0.4, // Suaviza a linha
                            borderWidth: 3,
                        },
                        point: {
                            radius: 5,
                            hoverRadius: 7,
                            backgroundColor: COLORS.roas,
                        }
                    }
                };

                // 3. Gr√°fico de ROAS M√©dio Di√°rio (LINHA)
                roasChartInstance = initChart('roasChart', 'line', { 
                    labels: reportLabels,
                    datasets: [
                        {
                            label: 'ROAS M√©dio',
                            data: roasData,
                            borderColor: COLORS.roas, // Cor da linha (√Çmbar/Amarelo)
                            backgroundColor: 'rgba(245, 158, 11, 0.2)', // Fundo sutil
                            fill: true,
                        }
                    ]
                }, lineChartOptions);

                showMessage('Relat√≥rio gerado com sucesso!');
                
            }, 50); // Atraso de 50ms


        }

        /** Exporta os dados brutos como CSV */
        window.exportReportAsCSV = function() { // RENOMEADO
            if (results.length === 0) {
                return showMessage('Nenhum dado de resultado para exportar.', true);
            }
            
            // Simula√ß√£o de exporta√ß√£o de dados brutos como JSON/CSV (simulando Excel)
            const csvData = results.map(r => {
                const clientName = clients.find(c => c.id === r.clientId)?.nome || 'Desconhecido';
                
                // Lidando com a nova estrutura de Convers√£o
                const conversionType = r.conversionType || 'N/D';
                const conversionCount = r.conversionCount || 0;
                const cpm = r.cpm || 0; // NOVO CPM

                return [
                    r.data, clientName, r.plataforma, r.investimento, r.impressoes, r.alcance, r.cliques, cpm, conversionType, conversionCount, r.vendas, r.cpa, r.roas, r.observacoes
                ].join(';');
            }).join('\n');
            
            const csvHeader = 'Data;Cliente;Plataforma;Gasto (R$);Impress√µes;Alcance;Cliques;CPM (R$);Tipo Convers√£o;Total Convers√µes;Vendas (R$);CPA (R$);ROAS (X);Observa√ß√µes\n';
            const fullCsv = csvHeader + csvData;
            
            // Download (simula√ß√£o de planilha Excel/CSV)
            const blob = new Blob([fullCsv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'Novan_Relatorio_Trafego.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Simula√ß√£o de Exporta√ß√£o para PDF (apenas mensagem)
            showMessage('Exporta√ß√£o de dados para Planilha (CSV) iniciada. Para PDF, utilize a fun√ß√£o de impress√£o do navegador (Ctrl+P) na aba de relat√≥rios!');
        }
        
        /** Wrapper Promise para carregar as imagens do Chart.js */
        const loadChartImage = (canvas, chartName) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve({ img: img, canvas: canvas });
                img.onerror = () => reject(new Error(`Falha ao carregar imagem para ${chartName}`));
                img.src = canvas.toDataURL('image/png');
            });
        };


        /** Exporta o Relat√≥rio Consolidado (TEXTO) como PNG */
        window.exportCombinedReportAsPNG = async function() { 
            if (!reportSummaryMetrics || reportDetailedResults.length === 0) {
                return showMessage('Gere o relat√≥rio primeiro antes de exportar o PNG.', true);
            }
            
            const reportData = reportDetailedResults;
            
            const headerHeight = 240; 
            const margin = 20; 
            const dataRowHeight = 28; // Altura para cada linha de dados
            const maxRows = Math.floor((1350 - headerHeight - (margin * 2)) / dataRowHeight) - 2; // ~35 linhas

            const rowsToShow = reportData.slice(0, maxRows); 
            const totalDataHeight = rowsToShow.length * dataRowHeight;
            
            // Altura total ajustada ao conte√∫do (m√°x 1350)
            const totalHeight = headerHeight + totalDataHeight + margin * 3; // +3 margens para espa√ßamento
            const totalWidth = 1080; 

            const compositeCanvas = document.createElement('canvas');
            compositeCanvas.width = totalWidth;
            compositeCanvas.height = totalHeight;
            const ctx = compositeCanvas.getContext('2d');
            
            // Define a fonte base para o canvas
            ctx.font = 'Poppins';
            
            // 1. Fundo (Azul Marinho)
            ctx.fillStyle = NAVY_BLUE; 
            ctx.fillRect(0, 0, totalWidth, totalHeight);
            
            // --- 2. Desenha o Cabe√ßalho e M√©tricas (RESUMO) ---
            
            // T√≠tulo Principal
            ctx.font = '700 36px Poppins'; 
            ctx.fillStyle = COLORS.faturamento; 
            ctx.fillText('RELAT√ìRIO NOVAN AGENCY', margin, margin + 40); 
            
            // Data de Gera√ß√£o 
            ctx.font = '400 16px Poppins'; 
            ctx.fillStyle = LIGHT_TEXT;
            ctx.fillText(`Gerado em: ${reportSummaryMetrics.generationDate}`, margin, margin + 70); 

            // Nome do Cliente
            ctx.font = '600 24px Poppins'; 
            ctx.fillStyle = LIGHT_TEXT;
            const clientDisplay = reportSummaryMetrics.clientName === 'Todos os Clientes' 
                ? reportSummaryMetrics.clientName 
                : `CLIENTE: ${reportSummaryMetrics.clientName}`;
            ctx.fillText(clientDisplay, margin, margin + 110); 
            
            // Per√≠odo 
            ctx.font = '400 18px Poppins'; 
            ctx.fillStyle = LIGHT_TEXT;
            ctx.fillText(`Per√≠odo Analisado: ${reportSummaryMetrics.period}`, margin, margin + 140); 

            // Bloco de M√©tricas Chave (M√©tricas Totais)
            let metricY = margin + 180; 
            ctx.font = '700 22px Poppins'; 
            const metricXSpacing = 300; 
            
            // GASTO TOTAL (Usando formatValueBRL para 1.000,32)
            ctx.fillStyle = COLORS.investimento;
            ctx.fillText(`GASTO TOTAL: R$ ${formatValueBRL(reportSummaryMetrics.totalGasto)}`, margin, metricY);
            
            // FATURAMENTO (MODIFICADO)
            ctx.fillStyle = COLORS.faturamento;
            ctx.fillText(`FATURAMENTO: R$ ${formatValueBRL(reportSummaryMetrics.totalFaturamento)}`, margin + metricXSpacing, metricY);
            
            metricY += 40; 
            ctx.font = '700 22px Poppins'; 
            
            // ROAS M√âDIO
            ctx.fillStyle = COLORS.roas;
            ctx.fillText(`ROAS M√âDIO: ${formatNumber(reportSummaryMetrics.avgROAS)}X`, margin, metricY);
            
            // CPM M√âDIO
            ctx.fillStyle = COLORS.impressoes;
            ctx.fillText(`CPM M√âDIO: R$ ${formatValueBRL(reportSummaryMetrics.avgCPM)}`, margin + metricXSpacing, metricY);


            // --- 3. Desenha os Detalhes Di√°rios (Tabela de Texto) ---

            let currentY = headerHeight + margin; 
            
            // T√≠tulo da Tabela Detalhada
            ctx.font = '700 18px Poppins';
            ctx.fillStyle = LIGHT_TEXT;
            ctx.fillText('DETALHE DE PERFORMANCE DI√ÅRIA:', margin, currentY);
            currentY += margin;
            
            // Cabe√ßalho da Tabela
            ctx.font = '600 15px Poppins'; // Fonte do cabe√ßalho levemente maior
            ctx.fillStyle = COLORS.primary; // Roxo para o cabe√ßalho da tabela
            const colDataCliente = 20;
            const colGasto = 260; 
            const colFaturamento = 400; 
            const colCPM = 550; 
            const colROAS = 680; 
            const colConv = 800; 
            
            ctx.fillText('DATA | CLIENTE', colDataCliente, currentY);
            ctx.fillText('GASTO (R$)', colGasto, currentY);
            ctx.fillText('FATURAMENTO (R$)', colFaturamento, currentY);
            ctx.fillText('CPM (R$)', colCPM, currentY);
            ctx.fillText('ROAS (X)', colROAS, currentY);
            ctx.fillText('CONVERS√ïES', colConv, currentY);
            currentY += 8; // Espa√ßamento extra ap√≥s o cabe√ßalho

            // Desenho das Linhas de Dados
            rowsToShow.forEach(row => {
                currentY += dataRowHeight - 5; // Ajusta para o pr√≥ximo Y
                
                const cpa = calculateCPA(row.investimento, row.conversionCount); // Recalcula se necess√°rio
                const roas = calculateROAS(row.investimento, row.vendas);
                const cpm = calculateCPM(row.investimento, row.impressoes);

                ctx.font = '400 14px Poppins'; // Fonte de dados
                
                // Coluna DATA/CLIENTE
                const clientName = clients.find(c => c.id === row.clientId)?.nome || 'N/D';
                const dateDisplay = getLocalDayDate(row.data).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }); // FIX APLICADO AQUI
                ctx.fillStyle = LIGHT_TEXT;
                ctx.fillText(`${dateDisplay} | ${clientName.substring(0, 10)}`, colDataCliente, currentY);
                
                // Coluna GASTO (formato 1.000,32)
                ctx.fillStyle = COLORS.investimento; // Vermelho para Gasto
                ctx.fillText(formatValueBRL(row.investimento), colGasto, currentY);
                
                // Coluna FATURAMENTO (formato 1.000,32)
                ctx.fillStyle = COLORS.faturamento; // Verde para Faturamento
                ctx.fillText(formatValueBRL(row.faturamento), colFaturamento, currentY);
                
                // Coluna CPM (formato 1.000,32)
                ctx.fillStyle = COLORS.impressoes; // Azul
                ctx.fillText(formatValueBRL(cpm), colCPM, currentY);
                
                // Coluna ROAS (formato 0.00)
                ctx.fillStyle = COLORS.roas; // Amarelo
                ctx.fillText(`${formatNumber(roas)}X`, colROAS, currentY);
                
                // Coluna CONVERS√ÉO (tipo e contagem)
                ctx.fillStyle = LIGHT_TEXT;
                ctx.fillText(`${row.conversionType.substring(0, 5)}. (${row.conversionCount})`, colConv, currentY);
            });

            if (reportData.length > maxRows) {
                currentY += dataRowHeight;
                ctx.fillStyle = LIGHT_TEXT;
                ctx.font = '400 14px Poppins';
                ctx.fillText(`... e mais ${reportData.length - maxRows} registros. Use o CSV para o detalhe completo.`, margin, currentY);
            }

            // --- 4. Download ---
            const dataUrl = compositeCanvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = `Novan_Relatorio_Feed_${reportSummaryMetrics.period.replace(/\s/g, '_').replace(/\//g, '-')}.png`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('Exporta√ß√£o do Relat√≥rio Consolidado (PNG) iniciada!');
        }


        // --- FUN√á√ÉO PARA ANIMA√á√ÉO CODE RAIN (MATRIX) ---
        
        /** Inicializa o Efeito Code Rain (Matrix) */
        function initMatrixEffect() {
            const canvas = document.getElementById('matrixCanvas');
            // Verifica se o elemento foi encontrado antes de prosseguir
            if (!canvas) return; 
            
            const ctx = canvas.getContext('2d');
            let width = canvas.width = window.innerWidth;
            let height = canvas.height = window.innerHeight;
            const fontSize = 16;
            const columns = Math.floor(width / fontSize);
            
            const drops = [];
            for(let i = 0; i < columns; i++) {
                drops[i] = 1;
            }
            
            // Caracteres para o efeito bin√°rio/digital
            const characters = '01'; 
            
            const draw = () => {
                // Fundo com opacidade baixa para o efeito de rastro
                ctx.fillStyle = 'rgba(14, 27, 49, 0.05)'; // Azul Marinho com opacidade
                ctx.fillRect(0, 0, width, height);
                
                ctx.font = `${fontSize}px monospace`;
                ctx.fillStyle = '#6D28D9'; // Cor Roxo Principal
                
                for(let i = 0; i < drops.length; i++) {
                    const text = characters.charAt(Math.floor(Math.random() * characters.length));
                    const x = i * fontSize;
                    const y = drops[i] * fontSize;
                    
                    ctx.fillText(text, x, y);
                    
                    // Re-inicia a gota se sair da tela (com chance de 97.5% de resetar)
                    if(y * fontSize > height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    
                    // Move a gota para baixo
                    drops[i]++;
                }
                requestAnimationFrame(draw);
            };

            const handleResize = () => {
                width = canvas.width = window.innerWidth;
                height = canvas.height = window.innerHeight;
            };

            window.addEventListener('resize', handleResize);
            // Inicia o loop de anima√ß√£o
            requestAnimationFrame(draw);
        }
        
        // Chamada da anima√ß√£o ap√≥s o DOM carregar
        document.addEventListener('DOMContentLoaded', initMatrixEffect);
        // --- FIM DA FUN√á√ÉO PARA ANIMA√á√ÉO CODE RAIN (MATRIX) ---


        // --- INICIALIZA√á√ÉO DA APLICA√á√ÉO PRINCIPAL (Ap√≥s Login) ---

        function initAppContent() {
            loadData();
            // Preenche o campo de respons√°veis com L√©o e Fabio
            populateResponsiblesSelect(); 
            
            // CORRE√á√ÉO: Define a data atual no campo de resultados, ajustando o fuso hor√°rio
            const today = new Date();
            const offset = today.getTimezoneOffset() * 60000; // Offset em milissegundos
            const localTime = new Date(today.getTime() - offset); // Hora local ajustada para o offset
            
            // Formata para YYYY-MM-DD
            document.getElementById('res_data').value = localTime.toISOString().split('T')[0];
            
            // Inicia na primeira aba
            switchTab('resultados'); 
            
            // Garante que o c√°lculo CPA/ROAS/CPM esteja zerado na inicializa√ß√£o
            updateMetricsDisplay();
        }

    </script>
</body>
</html>